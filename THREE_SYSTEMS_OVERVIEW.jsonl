{"v":"json-atomic-1.0","type":"doc.registered","doc_id":"doc_527b8130bf8ff890","title":"Three Systems Overview: UBL, Office, and Messenger","source":"UBL-Office-Messenger-main/docs/THREE_SYSTEMS_OVERVIEW.md","meta":{"version":"1.0","last_updated":"2024-12-28","status":"Production-Ready"},"hash_alg":"sha256","hash":"527b8130bf8ff890fca4a326609536fe94955086a429a5a9d6c8ed34493edc57"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":1,"path":["Three Systems Overview: UBL, Office, and Messenger"],"block_kind":"heading","level":1,"text":"Three Systems Overview: UBL, Office, and Messenger","md":"# Three Systems Overview: UBL, Office, and Messenger","hash_alg":"sha256","hash":"907a65927993c6a498525ddc8e82c3d2e3afd65865e96a91d7080a57811f1122"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":2,"path":["Three Systems Overview: UBL, Office, and Messenger"],"block_kind":"paragraph","md":"**Version**: 1.0  \n**Last Updated**: 2024-12-28  \n**Status**: Production-Ready  \n**Documentation Status**: Complete ‚úÖ","hash_alg":"sha256","hash":"b1e5ae9a2bedcd916b588dc1a66fbdfdbb705cc7b922b7d465105fd338958a25"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":3,"path":["Three Systems Overview: UBL, Office, and Messenger"],"block_kind":"paragraph","md":"**Systems Covered:**","hash_alg":"sha256","hash":"9b0584236cf607c23f77047353f32fd55f7253544016ea9e5a2b9ea3f8732683"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":4,"path":["Three Systems Overview: UBL, Office, and Messenger"],"block_kind":"list","md":"- ‚úÖ UBL Kernel (v2.1) - Complete\n- ‚úÖ Office Runtime (v1.0) - Complete  \n- ‚úÖ Messenger Frontend (v1.0) - Complete","hash_alg":"sha256","hash":"be2460dbaa4382433d1d5e7cf73cc53c59f80e629eb9d8dfbeee2886966e8920"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":5,"path":["Three Systems Overview: UBL, Office, and Messenger"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":6,"path":["Three Systems Overview: UBL, Office, and Messenger","üìë Table of Contents"],"block_kind":"heading","level":2,"text":"üìë Table of Contents","md":"## üìë Table of Contents","hash_alg":"sha256","hash":"a419de488f3311614e779b85c756ca98c3145e4e98fce4891a4e912dd7bd5845"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":7,"path":["Three Systems Overview: UBL, Office, and Messenger","üìë Table of Contents"],"block_kind":"list","md":"1. [Architecture Overview](#-architecture-overview)\n2. [System 1: UBL Kernel](#system-1-ubl-kernel-the-foundation)\n3. [System 2: Office](#system-2-office-llm-operating-system)\n4. [System 3: Messenger](#system-3-messenger-frontend-pwa)\n5. [Communication Patterns](#communication-patterns)\n6. [Data Flow Examples](#data-flow-example-job-creation--execution)\n7. [Key Architectural Principles](#key-architectural-principles)\n8. [Deep Dive: Technical Details](#deep-dive-technical-details)\n9. [Security & Governance](#security--governance)\n10. [Integration Patterns](#integration-patterns)\n11. [Data Structures](#data-structures)\n12. [Performance Considerations](#performance-considerations)\n13. [Testing Strategy](#testing-strategy)\n14. [Deployment](#deployment)\n15. [Advanced Implementation Details](#advanced-implementation-details)\n16. [Final Deep Dive: Complete System Architecture](#final-deep-dive-complete-system-architecture)\n17. [Quick Reference](#quick-reference)\n18. [Glossary](#glossary)","hash_alg":"sha256","hash":"2af82eb16bd0f6bfc41db2ef699cf1a446464be02835aa5d28abf293d4b58bb1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":8,"path":["Three Systems Overview: UBL, Office, and Messenger","üìë Table of Contents"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":9,"path":["Three Systems Overview: UBL, Office, and Messenger","üèóÔ∏è Architecture Overview"],"block_kind":"heading","level":2,"text":"üèóÔ∏è Architecture Overview","md":"## üèóÔ∏è Architecture Overview","hash_alg":"sha256","hash":"31e5ca02bb2b82b96decd0e1f2e916198b4c9df496d3f499e96aa6b59784d548"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":10,"path":["Three Systems Overview: UBL, Office, and Messenger","üèóÔ∏è Architecture Overview"],"block_kind":"paragraph","md":"The codebase consists of **three independent, deployable systems** that work together:","hash_alg":"sha256","hash":"ab3e1e7ec9ab483797462213845928f42788b6829649bbffc38a026c4d38ea02"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":11,"path":["Three Systems Overview: UBL, Office, and Messenger","üèóÔ∏è Architecture Overview"],"block_kind":"code","lang":null,"md":"```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                    UBL MESSENGER                            ‚îÇ\n‚îÇ  WhatsApp-like UI + Job Cards + Real-time Updates          ‚îÇ\n‚îÇ  Location: apps/messenger/                                  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n             ‚îÇ HTTP/SSE\n             ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                       OFFICE                                ‚îÇ\n‚îÇ  LLM Operating System + Job Execution + Governance         ‚îÇ\n‚îÇ  Location: apps/office/                                     ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n             ‚îÇ Events/Commands\n             ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                       UBL KERNEL                            ‚îÇ\n‚îÇ  Immutable Ledger + Containers + Trust Architecture        ‚îÇ\n‚îÇ  Location: ubl/kernel/rust/                                  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```","hash_alg":"sha256","hash":"e7f0c680e50bb7b016cc2fc41fb66e71caf875b650499807194eb8115c652c0d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":12,"path":["Three Systems Overview: UBL, Office, and Messenger","üèóÔ∏è Architecture Overview"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":13,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)"],"block_kind":"heading","level":2,"text":"System 1: UBL Kernel (The Foundation)","md":"## System 1: UBL Kernel (The Foundation)","hash_alg":"sha256","hash":"1ccc8bf5ac43f91af843cb1dc3b042dccb32bd42678091d06ed2a71c253de33a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":14,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)"],"block_kind":"paragraph","md":"**Location**: `ubl/kernel/rust/`","hash_alg":"sha256","hash":"bb192e8e6bab8aec73e4c73317e01cd42d502934f53771cd718da01a02fb7d2f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":15,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)"],"block_kind":"paragraph","md":"**Purpose**: Immutable, append-only ledger - the single source of truth","hash_alg":"sha256","hash":"c5f492ecbf6e2ce7d3a7b7bbaf9b53eedd7d703991b912daac06f5f382d586e7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":16,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components"],"block_kind":"heading","level":3,"text":"Core Components","md":"### Core Components","hash_alg":"sha256","hash":"d5e2eb6542a11eea3bb2e36708485db89bb7fa08281e422c5775201f2ba5ae68"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":17,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Kernel (`ubl-server`)"],"block_kind":"heading","level":4,"text":"Kernel (`ubl-server`)","md":"#### Kernel (`ubl-server`)","hash_alg":"sha256","hash":"07150089d73181e7e30897a876b1db7d9a342b65f6201c99ef58ec21a4e7a6cb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":18,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Kernel (`ubl-server`)"],"block_kind":"list","md":"- **Main Entry**: `ubl/kernel/rust/ubl-server/src/main.rs`\n- **HTTP API** with Axum\n- **PostgreSQL** backend (SERIALIZABLE isolation)\n- **WebAuthn** passkey authentication\n- **Event sourcing** with SSE tail streaming","hash_alg":"sha256","hash":"ebbe20352056bf63b13b001c3ef817cc2f28ef746406d627ef813b15c3f4626d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":19,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Key Modules"],"block_kind":"heading","level":4,"text":"Key Modules","md":"#### Key Modules","hash_alg":"sha256","hash":"bf5c916e5c8cc81baa7caa6b44e921b94c2ff16b2313ffa203d79671dcebd8d9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":20,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Key Modules"],"block_kind":"list","md":"- `db.rs` - Ledger operations (append-only, SERIALIZABLE transactions)\n- `sse.rs` - Server-Sent Events for real-time streaming (PostgreSQL LISTEN/NOTIFY)\n- `auth/` - WebAuthn passkey authentication, ASC (Agent Signing Certificates)\n- `projections/` - Read-only derived state updaters (jobs, messages, office, presence, timeline)\n- `messenger_v1.rs` - C.Messenger boundary API (legacy endpoints)\n- `messenger_gateway/` - Gateway layer (idempotency, Office integration, SSE deltas)\n- `policy/` - Policy Pack v1 enforcement (FSM, provenance, PII)\n- `console_v1.rs` - Permit ‚Üí Command ‚Üí Receipt flow (ADR-001)\n- `registry_v1.rs` - Git registry queries (ADR-002)","hash_alg":"sha256","hash":"0d6add644519c4dd7b9e6c61328a3230cc853fc03f70daa6c47c1af3a381b789"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":21,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Containers"],"block_kind":"heading","level":4,"text":"Containers","md":"#### Containers","hash_alg":"sha256","hash":"992aee221be63df126a7fd928d8a563fa615bd707e6b9d8c705ad84ae7b8b0c7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":22,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Containers"],"block_kind":"paragraph","md":"Located in `ubl/containers/`:","hash_alg":"sha256","hash":"124dccebd3493891855fc80c47926b94e8ad768f8033d74385b0b163d2543fd2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":23,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Containers"],"block_kind":"list","md":"- **C.Messenger** - Messenger events (`conversation.created`, `message.created`, `message.sent` with job cards)\n- **C.Jobs** - Job lifecycle events (`job.created`, `job.started`, `job.state_changed`, `job.completed`, `approval.requested`, `approval.decided`)\n- **C.Office** - Office runtime events (`entity.created`, `session.started`, `session.completed`, `tool.called`, `tool.result`, `constitution.updated`, `baseline.updated`)\n- **C.Pacts** - Multi-party agreements (pact.created, pact.signed, pact.executed)\n- **C.Policy** - Policy definitions (policy.created, policy.updated)\n- **C.Runner** - Command execution (command.issued, command.executed, receipt.submitted)\n- **C.Artifacts** - Generated artifacts (artifact.created, artifact.updated)","hash_alg":"sha256","hash":"cce7a02f0d289220f063c61e2ab24971c852fbdf0d698cc38573e3ce107cfcab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":24,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Database Schema"],"block_kind":"heading","level":4,"text":"Database Schema","md":"#### Database Schema","hash_alg":"sha256","hash":"42d2a605b062994dbc50d3ee3090f62e7ab5dacf074abc62f48108b0495fae0e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":25,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Database Schema"],"block_kind":"paragraph","md":"Located in `ubl/sql/`:","hash_alg":"sha256","hash":"59eb6d4152b8d09a92ddb517cca12c9530837addb1a09255eb86d08f263fdb15"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":26,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Database Schema"],"block_kind":"list","md":"- `00_base/000_core.sql` - Core ledger tables\n- `00_base/001_identity.sql` - Identity & WebAuthn\n- `00_base/002_policy.sql` - Policy engine\n- `00_base/003_triggers.sql` - NOTIFY triggers\n- `10_projections/100_console.sql` - Console projections\n- `10_projections/101_messenger.sql` - Messenger projections\n- `10_projections/102_office.sql` - Office projections","hash_alg":"sha256","hash":"1c5d915fa390bf92def584a6fa1bacb52a3d368a383096b9d546bd42c8d22ce5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":27,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Key Features"],"block_kind":"heading","level":4,"text":"Key Features","md":"#### Key Features","hash_alg":"sha256","hash":"80dc8d1d613ae83401c95685b80ad35509b448df68148c7ae079759e6f212dee"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":28,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","Key Features"],"block_kind":"list","md":"- **Append-only**: Records cannot be modified or deleted\n- **Cryptographic proofs**: Ed25519 signatures, BLAKE3 hashing\n- **Container-based**: Events organized by logical containers\n- **Trust levels**: L0-L5 risk-based permissions\n- **Pacts**: Multi-party consensus for high-risk operations\n- **Projections**: Read-only derived state for efficient queries\n- **SSE Tail**: Real-time event streaming via PostgreSQL LISTEN/NOTIFY","hash_alg":"sha256","hash":"11b8c383b91a328f64eca7ac374393b7179a85994cf945a60df04391a99b366e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":29,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","API Endpoints"],"block_kind":"heading","level":4,"text":"API Endpoints","md":"#### API Endpoints","hash_alg":"sha256","hash":"4e473c149cc4eab222d298e283801cd24e1193e51767487a595e23850be01693"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":30,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","API Endpoints"],"block_kind":"code","lang":null,"md":"```\nCore:\n  GET  /health\n  GET  /state/:container_id\n  POST /link/validate\n  POST /link/commit\n  GET  /ledger/:container_id/tail (SSE)\n\nIdentity:\n  POST /id/register/begin\n  POST /id/register/finish\n  POST /id/login/begin\n  POST /id/login/finish\n  GET  /id/whoami\n  POST /id/agents (create LLM/App agent)\n  POST /id/agents/:sid/asc (issue ASC)\n\nConsole v1.1:\n  POST /v1/policy/permit\n  POST /v1/commands/issue\n  GET  /v1/query/commands?pending=1\n  POST /v1/exec.finish\n\nMessenger v1:\n  GET  /messenger/bootstrap\n  POST /messenger/messages\n  POST /messenger/conversations\n  GET  /messenger/conversations\n  POST /messenger/jobs/:id/approve\n  POST /messenger/jobs/:id/reject\n\nMessenger Gateway v1:\n  POST /v1/conversations/:id/messages\n  POST /v1/jobs/:id/actions\n  GET  /v1/conversations/:id/timeline\n  GET  /v1/jobs/:id\n  GET  /v1/stream (SSE)\n```","hash_alg":"sha256","hash":"3a29ac5944688eb2770d2e90e20781c1b6d36343bfe9ed5eaf6f370d06ba8c02"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":31,"path":["Three Systems Overview: UBL, Office, and Messenger","System 1: UBL Kernel (The Foundation)","Core Components","API Endpoints"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":32,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)"],"block_kind":"heading","level":2,"text":"System 2: Office (LLM Operating System)","md":"## System 2: Office (LLM Operating System)","hash_alg":"sha256","hash":"4837817b4c9785e2293ec1948d5c7716425b4e5769050defd9700853ab5f29e5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":33,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)"],"block_kind":"paragraph","md":"**Location**: `apps/office/`","hash_alg":"sha256","hash":"c857f077e8a3dd716ab5cbdf6756aa29450dec6bcc1a5704b76fdfe09e0a3859"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":34,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)"],"block_kind":"paragraph","md":"**Purpose**: Runtime for LLM entities with dignity - executes jobs, manages sessions, enforces governance","hash_alg":"sha256","hash":"58132619e50abb6ba5054bfbcd23a0ef49835dac31b298ee8055b4c4ec53f9ce"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":35,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components"],"block_kind":"heading","level":3,"text":"Core Components","md":"### Core Components","hash_alg":"sha256","hash":"d5e2eb6542a11eea3bb2e36708485db89bb7fa08281e422c5775201f2ba5ae68"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":36,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Main Entry"],"block_kind":"heading","level":4,"text":"Main Entry","md":"#### Main Entry","hash_alg":"sha256","hash":"19a6905ba0fbab6d476702234e9d1e21c7b03b8afd1438596c31acb6c227ece8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":37,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Main Entry"],"block_kind":"list","md":"- `apps/office/src/main.rs` - HTTP server startup\n- `apps/office/src/lib.rs` - Core library exports","hash_alg":"sha256","hash":"a237341398648dcc96f13c5922c6b4b7871faee5dacebf52bf9816900d8d5592"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":38,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"heading","level":4,"text":"Key Modules","md":"#### Key Modules","hash_alg":"sha256","hash":"bf5c916e5c8cc81baa7caa6b44e921b94c2ff16b2313ffa203d79671dcebd8d9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":39,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Entity Management** (`entity/`)","hash_alg":"sha256","hash":"d03a9210f6fe356e6c8010e3687b9ba6a87d839cc2532fd8282e4c030133b925"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":40,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `entity.rs` - Persistent LLM identity\n- `instance.rs` - Ephemeral LLM session\n- `repository.rs` - Entity storage\n- `guardian.rs` - Guardian relationships","hash_alg":"sha256","hash":"7e9033a13bd25b7c0caf6028b0435fa0b98df37093f60336b6a3248015973bb6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":41,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Session Management** (`session/`)","hash_alg":"sha256","hash":"bbc239c0b2bf796bb55e8ef2f85e354e0ed5ef8c501b3a23c740713c5e196305"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":42,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `session.rs` - Session lifecycle\n- `modes.rs` - Work, Assist, Deliberate, Research\n- `handover.rs` - Knowledge transfer between instances\n- `token_budget.rs` - Token allocation","hash_alg":"sha256","hash":"640b22711fca62e4655e99de0e074eeea8911a0a00041c84d355248f6e8f1df6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":43,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Context Building** (`context/`)","hash_alg":"sha256","hash":"064519a5b918783d8579cdc3390ce74adc9f7df63714abb4f01575b845dbb69d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":44,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `builder.rs` - Context frame construction\n- `frame.rs` - Immutable state snapshot\n- `narrator.rs` - Transforms data into first-person narrative\n- `memory.rs` - Long-term memory management","hash_alg":"sha256","hash":"a98b0ca2aac4aaac4afff4d4d58729bcf6310a6e5b4ce0d5ce553fe6422ae745"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":45,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Governance** (`governance/`)","hash_alg":"sha256","hash":"834252a3f3e6350852e128050ad66f7ba3b71f828135425b15b8b1864082ccd2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":46,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `constitution.rs` - Behavioral directives (AOP)\n- `sanity_check.rs` - Validates claims against facts\n- `dreaming.rs` - Memory consolidation cycle\n- `simulation.rs` - Test actions before execution\n- `provenance.rs` - Track action origins","hash_alg":"sha256","hash":"56bee425651d5de7bcf1a16a88e69bfe37155a4ea36cb1c0c9b118fbc734be51"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":47,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Job Execution** (`job_executor/`)","hash_alg":"sha256","hash":"111109cd191a3057e43cd1e9640380ada106fca45d6466fcacea905a9878c181"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":48,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `executor.rs` - Main job execution engine\n- `fsm.rs` - Job state machine (Draft ‚Üí Proposed ‚Üí Approved ‚Üí InProgress ‚Üí Completed)\n- `cards.rs` - Job card generation (FormalizeCard, TrackingCard, FinishedCard)\n- `types.rs` - Job data structures\n- `conversation_context.rs` - Builds context from conversations","hash_alg":"sha256","hash":"54c7fc69de31bfee1ac4b69428baa5798b59ba293a2eb468b4808180b4a98e31"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":49,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**LLM Integration** (`llm/`)","hash_alg":"sha256","hash":"7f95434fa08f2b86a9ac6402d9ca54bbf8911b71057cebee7bbed9b0a15ee582"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":50,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `provider.rs` - LLM provider interface\n- `router.rs` - Smart routing (Anthropic, OpenAI, local)\n- `anthropic.rs` - Claude integration\n- `openai.rs` - GPT integration\n- `local.rs` - Local LLM support","hash_alg":"sha256","hash":"7c43bf1458681a0bfd3d834c6f25ce6100c4b36177daeca42310809306a12b6c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":51,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**UBL Client** (`ubl_client/`)","hash_alg":"sha256","hash":"c5bf3d4b3625bc54906ace85a7d2458292b274de901cb99fd56cab780236f486"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":52,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `mod.rs` - Main client\n- `ledger.rs` - Event publishing, state queries\n- `affordances.rs` - Available actions discovery\n- `events.rs` - Event emission\n- `receipts.rs` - Receipt submission\n- `trust.rs` - Trust level queries","hash_alg":"sha256","hash":"c6921f9317396d327894646f68b4cc7a6bf9273a18b9a3ae0d6a707e68c5454e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":53,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**API Layer** (`api/`)","hash_alg":"sha256","hash":"a2b43a3d0261b1243d3031c6b8eb18dc1770331ae58b4acf7cd20a1a43ba3e25"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":54,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `http.rs` - HTTP REST endpoints\n- `websocket.rs` - WebSocket for real-time updates","hash_alg":"sha256","hash":"a849e3d55e861fa03945a0c87cf3d656e5cdbdecdb38b4591b0297833fffe3a3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":55,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Middleware** (`middleware/`)","hash_alg":"sha256","hash":"dfe68224bf86a7d5c1db0726463a1fbe401803078614152eacd0da3c4b8b1a34"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":56,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `permit.rs` - UBL permit enforcement\n- `constitution.rs` - Constitution AOP enforcement","hash_alg":"sha256","hash":"832685ea26d4d90c54bd17fcbd716e280de71c8cb9a2b4839eec11eb3f02583b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":57,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"paragraph","md":"**Audit** (`audit/`)","hash_alg":"sha256","hash":"7c59aef2792d6c2d03dbdc82a087b695ebca2fce94c72ae095da5e5ce080f5db"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":58,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Core Components","Key Modules"],"block_kind":"list","md":"- `tool_audit.rs` - Tool call auditing\n- `pii.rs` - PII detection\n- `events.rs` - Audit event emission","hash_alg":"sha256","hash":"ed714f0fb1e20ecd39400b926140a0a7a0efd3003636d9d666395b13514fedc8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":59,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Key Features"],"block_kind":"heading","level":3,"text":"Key Features","md":"### Key Features","hash_alg":"sha256","hash":"1c600670009d2c92eb99ff9f894b335d37344b89bb15833413c7715495d0d079"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":60,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Key Features"],"block_kind":"list","md":"- **Entity Dignity**: Persistent identity across ephemeral instances\n- **Context Frames**: Immutable snapshots before LLM invocation\n- **Narratives**: First-person situated narratives\n- **Handovers**: Knowledge transfer between instances\n- **Constitution**: Behavioral directives that override RLHF\n- **Sanity Check**: Validates LLM claims against objective facts\n- **Dreaming Cycle**: Asynchronous memory consolidation\n- **Simulation**: Test actions before execution\n- **Job Execution**: Complete job lifecycle management\n- **Permit Enforcement**: All mutations require UBL permits","hash_alg":"sha256","hash":"4c5eaec95ef410b6449a6eb7e4db5e6db12b8a9efe9a0a3e913fb68bce4a2b4e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":61,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","API Endpoints"],"block_kind":"heading","level":3,"text":"API Endpoints","md":"### API Endpoints","hash_alg":"sha256","hash":"a46ed7b76e83891334d8329ac42155ac38e9ad9966b69d15a52156a8d9d3eb1c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":62,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","API Endpoints"],"block_kind":"code","lang":null,"md":"```\nEntities:\n  POST   /entities\n  GET    /entities\n  GET    /entities/:id\n  DELETE /entities/:id\n\nSessions:\n  POST   /entities/:id/sessions\n  GET    /entities/:id/sessions/:sid\n  DELETE /entities/:id/sessions/:sid\n  POST   /entities/:id/sessions/:sid/message\n\nJobs:\n  POST   /jobs/execute\n  POST   /jobs/execute/stream\n  GET    /jobs/:job_id/status\n\nGateway-facing:\n  POST   /v1/office/ingest_message\n  POST   /v1/office/job_action\n\nGovernance:\n  POST   /entities/:id/dream\n  GET    /entities/:id/memory\n  POST   /entities/:id/constitution\n  GET    /entities/:id/constitution\n  POST   /simulate\n\nAffordances:\n  GET    /affordances\n  GET    /affordances/:id\n```","hash_alg":"sha256","hash":"2b24317111836c048f46b25bbccd44cc0169408eb5657f553da70c9a16e6e404"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":63,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Configuration"],"block_kind":"heading","level":3,"text":"Configuration","md":"### Configuration","hash_alg":"sha256","hash":"f7c02dfc289106eb112025b400bf445c7d58c4764d4d97a372729d1b484d06c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":64,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Configuration"],"block_kind":"paragraph","md":"Located in `apps/office/config/`:","hash_alg":"sha256","hash":"88367b229d9de073c87911da6457d69e8f25500c2aac4de673b1faa44c3b777f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":65,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Configuration"],"block_kind":"list","md":"- `development.toml` - Development settings\n- `production.toml` - Production settings","hash_alg":"sha256","hash":"dc6d7b4129b26513e72b2076812047ec0b75d7e47d924d7f12f699df853a9408"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":66,"path":["Three Systems Overview: UBL, Office, and Messenger","System 2: Office (LLM Operating System)","Configuration"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":67,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)"],"block_kind":"heading","level":2,"text":"System 3: Messenger (Frontend PWA)","md":"## System 3: Messenger (Frontend PWA)","hash_alg":"sha256","hash":"302d3bed1cc28a59a4f7a0c77f8b68b911bab086d75be90cbcc936539abd19db"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":68,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)"],"block_kind":"paragraph","md":"**Location**: `apps/messenger/frontend/`","hash_alg":"sha256","hash":"9eee746f638ebd68a2d0e9e4857518a5c7e5bd672cb5b071b62bc62cc2d949cf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":69,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)"],"block_kind":"paragraph","md":"**Purpose**: WhatsApp-like professional messaging interface for humans and AI agents","hash_alg":"sha256","hash":"dc284b79728435fcc94f5d6a6b11a6aa098a2057e35868178ecdbf7562d6852c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":70,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components"],"block_kind":"heading","level":3,"text":"Core Components","md":"### Core Components","hash_alg":"sha256","hash":"d5e2eb6542a11eea3bb2e36708485db89bb7fa08281e422c5775201f2ba5ae68"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":71,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Main Entry"],"block_kind":"heading","level":4,"text":"Main Entry","md":"#### Main Entry","hash_alg":"sha256","hash":"19a6905ba0fbab6d476702234e9d1e21c7b03b8afd1438596c31acb6c227ece8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":72,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Main Entry"],"block_kind":"list","md":"- `apps/messenger/frontend/src/index.tsx` - React app entry\n- `apps/messenger/frontend/src/App.tsx` - Main app component","hash_alg":"sha256","hash":"70f8ede174c06c2560b98574f6285c7df7d5c3ac9c8512691dcb7027db4a8fa8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":73,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Pages"],"block_kind":"heading","level":4,"text":"Pages","md":"#### Pages","hash_alg":"sha256","hash":"fa3b36f638eb71f93e74b7ab1e97906176add92b77fbb2568cebbfd636dfd80a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":74,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Pages"],"block_kind":"list","md":"- `pages/ChatPage.tsx` - Main chat interface (Sidebar + ChatView)\n- `pages/LoginPage.tsx` - WebAuthn passkey authentication\n- `pages/SettingsPage.tsx` - User settings","hash_alg":"sha256","hash":"b425de58d5148a8499ee1d96ea6062528744584535b3c7abb2a8361a91b2b576"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":75,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"heading","level":4,"text":"Components","md":"#### Components","hash_alg":"sha256","hash":"8a08bc6e37b459be6737fde31a838183359855e8aec5994e5b46805b3db0a38b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":76,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"paragraph","md":"**Core UI**","hash_alg":"sha256","hash":"12d19bb6d8e0707c4172389b50d0b9552a6f45e860c5d96579dfd73f1b0f3f9b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":77,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"list","md":"- `components/Sidebar.tsx` - Conversation list with presence indicators\n- `components/ChatView.tsx` - Message display and input\n- `components/WelcomeScreen.tsx` - Empty state\n- `components/JobDrawer.tsx` - Job details drawer (newly implemented)\n- `components/JobTimeline.tsx` - Job event timeline\n- `components/JobArtifacts.tsx` - Job artifacts display","hash_alg":"sha256","hash":"57145d4a63a3e842d7f18ad47c671e537df0a780034dab536ef250d43167531c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":78,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"paragraph","md":"**Job Cards**","hash_alg":"sha256","hash":"0111d0d8aea036b042a9cbdffbdc835cd2f1dfd8c336c1198ad6b05a33056aea"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":79,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"list","md":"- `components/cards/JobCardRenderer.tsx` - Renders job cards with action buttons","hash_alg":"sha256","hash":"28835db8ed1547aeb239c0eddaa552469eed1352be33d19ebf0695f07d7ce2e2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":80,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"paragraph","md":"**Modals**","hash_alg":"sha256","hash":"189cbbe18f4f115f9e61c97ec290e9a7206c9f57f7392e30f30618640b356dd4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":81,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"list","md":"- `components/modals/NewWorkstreamModal.tsx` - Create conversation\n- `components/modals/EntityProfileModal.tsx` - Entity details","hash_alg":"sha256","hash":"9ebdab726ddd507780c756ab3935ffb976bca90c37bbef6a81e844188176f359"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":82,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"paragraph","md":"**UI Components**","hash_alg":"sha256","hash":"bd775f291a5c5661a51a8cebb0106677de6904cc59437ad4b2d44fcc89ed391c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":83,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Components"],"block_kind":"list","md":"- `components/ui/` - Reusable UI primitives (Button, Modal, Badge, etc.)","hash_alg":"sha256","hash":"a2038b9f2ca41ca5872c05fc0dc607afa14924ae7046ebe70c62f92ecda9926e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":84,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Services"],"block_kind":"heading","level":4,"text":"Services","md":"#### Services","hash_alg":"sha256","hash":"c9f0aff24e827416867d3130ec40da40718c9ae44c20b7c9152caef207e7a448"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":85,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Services"],"block_kind":"paragraph","md":"**API Clients**","hash_alg":"sha256","hash":"c38d1561202a9b8ecc2267c5213c7ab16b52a0a02db7bd36ccfce93f0b4860bb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":86,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Services"],"block_kind":"list","md":"- `services/ublApi.ts` - UBL Kernel API (bootstrap, messages, jobs)\n- `services/apiClient.ts` - Generic HTTP client\n- `services/apiService.ts` - Supabase integration (legacy)\n- `services/jobsApi.ts` - Job-related API and WebSocket\n- `services/sse.ts` - Server-Sent Events client (newly implemented)\n- `services/ledger.ts` - Ledger utilities","hash_alg":"sha256","hash":"ab1fdfdba8a0543a16fa7a9093783a8e7a6d258992d0d86298fc2356aa51b408"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":87,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Hooks"],"block_kind":"heading","level":4,"text":"Hooks","md":"#### Hooks","hash_alg":"sha256","hash":"e06efc85da039b9074b81f389873501553a0cf8727a92b58b499a92e55ec002e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":88,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Hooks"],"block_kind":"list","md":"- `hooks/useSSE.ts` - SSE subscription hook (newly implemented)\n- `hooks/useJobs.ts` - Job management hook\n- `hooks/useOptimistic.ts` - Optimistic UI updates\n- `hooks/useAuth.ts` - Authentication hook","hash_alg":"sha256","hash":"c3f2172f88ed94233f530898cacc045c50bf4125db681c8f5ad2c2f987b439b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":89,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Context"],"block_kind":"heading","level":4,"text":"Context","md":"#### Context","hash_alg":"sha256","hash":"ac67316ad934d282b217238a5c589c1cc1f16e22ea51f9f1f626f8613d480608"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":90,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Core Components","Context"],"block_kind":"list","md":"- `context/AuthContext.tsx` - Authentication state\n- `context/ThemeContext.tsx` - Theme management\n- `context/NotificationContext.tsx` - Notifications\n- `context/OnboardingContext.tsx` - Onboarding flow\n- `context/ProtocolContext.tsx` - Protocol state","hash_alg":"sha256","hash":"e995ae1d831ee68cae32dec44d132225a14a3e6a1b43b8095e4fb94af491aafa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":91,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Key Features"],"block_kind":"heading","level":3,"text":"Key Features","md":"### Key Features","hash_alg":"sha256","hash":"1c600670009d2c92eb99ff9f894b335d37344b89bb15833413c7715495d0d079"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":92,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Key Features"],"block_kind":"list","md":"- **Conversations**: Direct messages and group chats\n- **Job Cards**: Interactive cards (FormalizeCard, TrackingCard, FinishedCard)\n- **Real-time Updates**: SSE subscription for live updates\n- **Presence Indicators**: Show entity status (online, working, waiting_on_you)\n- **Job Drawer**: Detailed job view with timeline and artifacts\n- **WebAuthn**: Passkey authentication\n- **Optimistic UI**: Immediate feedback on actions\n- **Rich Content**: Code blocks, terminal output, file views","hash_alg":"sha256","hash":"401ee508490a8eed63435f2b51a3b5a2641c1d9e4bf3a2f32cc25b0bab62dbba"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":93,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Technology Stack"],"block_kind":"heading","level":3,"text":"Technology Stack","md":"### Technology Stack","hash_alg":"sha256","hash":"3dcab8e166ce279bc6d183f848c7b5920f713744b8ec5b4255e57650b902181e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":94,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Technology Stack"],"block_kind":"list","md":"- **React 18+** + **TypeScript 5+**\n- **Vite** - Build tool and dev server\n- **Tailwind CSS** - Utility-first styling\n- **Framer Motion** - Animation library\n- **React Router DOM** - Client-side routing\n- **@simplewebauthn/browser** - WebAuthn passkey authentication\n- **React Hot Toast** - Toast notifications\n- **Lucide React** - Icon library","hash_alg":"sha256","hash":"a2c42a78ba2624c3cc7dfea5600bf2fb4e78f3b6957f5df7b85b476983a5b0ec"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":95,"path":["Three Systems Overview: UBL, Office, and Messenger","System 3: Messenger (Frontend PWA)","Technology Stack"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":96,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns"],"block_kind":"heading","level":2,"text":"Communication Patterns","md":"## Communication Patterns","hash_alg":"sha256","hash":"a935d3137e3e8bf21415164b69bd38ea42f838c0cf2acb2c856055dd2e0552fa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":97,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Messenger ‚Üí UBL Kernel"],"block_kind":"heading","level":3,"text":"Messenger ‚Üí UBL Kernel","md":"### Messenger ‚Üí UBL Kernel","hash_alg":"sha256","hash":"793245eaac9d96ea5d340d0a0e815285fd3eb0457de71da1b144324618bce035"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":98,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Messenger ‚Üí UBL Kernel"],"block_kind":"list","md":"- **HTTP REST**: Bootstrap, send messages, approve/reject jobs\n- **SSE**: Subscribe to `/v1/stream` for real-time deltas\n- **Gateway API**: Use `/v1/conversations/:id/messages` for message sending","hash_alg":"sha256","hash":"eac0d69af08283d5f522d4f804657065c7ba5728a5694bcd2cfa94ea21a1f40c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":99,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Messenger ‚Üí Office"],"block_kind":"heading","level":3,"text":"Messenger ‚Üí Office","md":"### Messenger ‚Üí Office","hash_alg":"sha256","hash":"0871220a78b00a881c64ee75797f4fa6e01077f005bd11e87a1f698412021f62"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":100,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Messenger ‚Üí Office"],"block_kind":"list","md":"- **HTTP REST**: Job execution requests (via Gateway)\n- **Gateway API**: `/v1/office/ingest_message`, `/v1/office/job_action`","hash_alg":"sha256","hash":"ba38893f64bb84a6e41d3951ce619a2104a30dc913d90a155dee3537c7c59830"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":101,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Office ‚Üí UBL Kernel"],"block_kind":"heading","level":3,"text":"Office ‚Üí UBL Kernel","md":"### Office ‚Üí UBL Kernel","hash_alg":"sha256","hash":"db67b6d8f528774a2ed20886b06a197552440cd03e90d968e633efbc75541508"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":102,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","Office ‚Üí UBL Kernel"],"block_kind":"list","md":"- **HTTP REST**: \n  - Request permits (`/v1/policy/permit`)\n  - Commit events (`/link/commit`)\n  - Query state (`/state/:container_id`)\n  - Subscribe to SSE (`/ledger/:container_id/tail`)\n- **UBL Client**: Rust client in `apps/office/src/ubl_client/`","hash_alg":"sha256","hash":"2d213f0bc929f5e58913b315ce0e36c54bf5c53863161e510e628699f8987148"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":103,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","UBL Kernel ‚Üí Projections"],"block_kind":"heading","level":3,"text":"UBL Kernel ‚Üí Projections","md":"### UBL Kernel ‚Üí Projections","hash_alg":"sha256","hash":"47a19b33ac1df4749dc479800ebf3e2ddb4e8e5a5c433bd6ea004bb54a525d5b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":104,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","UBL Kernel ‚Üí Projections"],"block_kind":"list","md":"- **PostgreSQL Triggers**: NOTIFY on ledger commits\n- **SSE Tail**: Stream events to subscribers\n- **Projection Updaters**: Update read-only tables automatically","hash_alg":"sha256","hash":"3ff4b2c8529fba3654280e893e637b670aad09ac5165395c8a4260cc47421b85"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":105,"path":["Three Systems Overview: UBL, Office, and Messenger","Communication Patterns","UBL Kernel ‚Üí Projections"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":106,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"heading","level":2,"text":"Data Flow Example: Job Creation & Execution","md":"## Data Flow Example: Job Creation & Execution","hash_alg":"sha256","hash":"bcad890c007978c79577f1ec76a531a5739493c02a8e2f8afa0dead880a27661"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":107,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"1. **User sends message** in Messenger\n   - Frontend calls `POST /v1/conversations/:id/messages`\n   - Gateway commits `message.created` to UBL (C.Messenger)\n   - Gateway calls `POST /v1/office/ingest_message`","hash_alg":"sha256","hash":"5a44682a2577a0083747173f3287e76d8912c25c281fddf2f4d0fa3a2b185b14"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":108,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"2. **Office processes message**\n   - Office analyzes message content\n   - Decides: reply or propose job\n   - If job: Creates `job.created` event ‚Üí commits to UBL (C.Jobs)\n   - Generates FormalizeCard with approve/reject buttons","hash_alg":"sha256","hash":"a3f3145b4f85198a6f1e9bebdcfbc7c6b02d79e6c1dab8bcb19a92fd5c78960e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":109,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"3. **UBL processes events**\n   - Validates event (Policy Pack checks)\n   - Appends to ledger\n   - Triggers projection updates\n   - Emits SSE events","hash_alg":"sha256","hash":"93444b5015598bb49aff8ab6662dd4c92db0dcfbd758dc18baa08e3fa330e32c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":110,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"4. **Projections update**\n   - `projection_jobs` table updated\n   - `projection_job_events` timeline updated\n   - `projection_presence` recomputed\n   - `projection_timeline_items` updated","hash_alg":"sha256","hash":"dc073d1fbeee35472ece45e8116205d54e30a97d5c628123058bfc9916a7b49b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":111,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"5. **Frontend receives updates**\n   - SSE client receives `timeline.append` event\n   - Job card appears in conversation\n   - Presence indicators update","hash_alg":"sha256","hash":"eeac07302835a1a8f401ba11b846cc9c641fe21e8842a95cb6136952e921b748"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":112,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"6. **User approves job**\n   - Frontend calls `POST /v1/jobs/:id/actions` (via Gateway)\n   - Gateway validates card provenance\n   - Gateway calls `POST /v1/office/job_action`\n   - Office updates job state (FSM validation)\n   - Office commits `job.state_changed` to UBL\n   - Office begins job execution","hash_alg":"sha256","hash":"6ec6cecf3f8972590be36b330a4913ca292bb35dd7669595fb0be23878b3316f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":113,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"7. **Job execution**\n   - Office builds context frame\n   - Office calls LLM with narrative\n   - Office executes tools (with audit)\n   - Office streams progress updates\n   - Office commits `tool.called` and `tool.result` events","hash_alg":"sha256","hash":"97b287c764332fd0842c1ec82f8b8e1cdb197bd0a8611088ec81e5d432afed19"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":114,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"list","md":"8. **Job completion**\n   - Office commits `job.completed` to UBL\n   - Projections update with artifacts\n   - Frontend receives `job.update` SSE event\n   - Job card shows completion status","hash_alg":"sha256","hash":"a7a7b046aa9d807d4e4ff0b55ace023e5e2e71ac7ac52516c7c11d36307ddba7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":115,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Flow Example: Job Creation & Execution"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":116,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles"],"block_kind":"heading","level":2,"text":"Key Architectural Principles","md":"## Key Architectural Principles","hash_alg":"sha256","hash":"947e9aa8e24a78f734bcfa3c7fedebd00a694bc04b07210d589ca5d80a9b3279"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":117,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","1. UBL is Sovereign"],"block_kind":"heading","level":3,"text":"1. UBL is Sovereign","md":"### 1. UBL is Sovereign","hash_alg":"sha256","hash":"bd9997d3b8b158e1946cecab35f88cd331e03d78256707938f4ad749175f5336"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":118,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","1. UBL is Sovereign"],"block_kind":"list","md":"- Office and Messenger are **subordinate** to UBL\n- All mutations must go through UBL\n- Office requests permits before actions\n- Messenger commits events to UBL","hash_alg":"sha256","hash":"760b1f1662e682c7d8ecdc28239214a6ff21b585d0ff33566b4cf402b6384552"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":119,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","2. Event Sourcing"],"block_kind":"heading","level":3,"text":"2. Event Sourcing","md":"### 2. Event Sourcing","hash_alg":"sha256","hash":"061a3077117455aad55b93bcff3071e8e6ac670e41d174939f54dcf96c1b5c52"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":120,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","2. Event Sourcing"],"block_kind":"list","md":"- All state changes are events in the ledger\n- Projections are derived, read-only views\n- State can be reconstructed from ledger\n- Events are immutable and auditable","hash_alg":"sha256","hash":"4468d2a6cc8a7ed4959500d88fb348a7405109f2d47ec95fc8885e57ed4908ff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":121,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","3. Container Pattern"],"block_kind":"heading","level":3,"text":"3. Container Pattern","md":"### 3. Container Pattern","hash_alg":"sha256","hash":"cb8e0a459132bceda9439df0c8ec4fd9d19ab4b35418524f3f7655715f707e2c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":122,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","3. Container Pattern"],"block_kind":"list","md":"- Events organized by logical containers (C.Messenger, C.Jobs, C.Office)\n- Each container has its own sequence\n- Containers can have policies and pacts\n- Containers enable multi-tenancy","hash_alg":"sha256","hash":"f3671b662532d7fa8684bbca3ef17f464115a8cb166fa364dce649e9a24eda45"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":123,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","4. Trust Architecture"],"block_kind":"heading","level":3,"text":"4. Trust Architecture","md":"### 4. Trust Architecture","hash_alg":"sha256","hash":"9d42344735128f8535343b16318f1c1ea5fcf45d6213bcbbb1727bb18333e122"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":124,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","4. Trust Architecture"],"block_kind":"list","md":"- Risk levels L0-L5\n- Permits required for mutations\n- Pacts for high-risk operations\n- Policy Pack for governance","hash_alg":"sha256","hash":"5265f937053d064c221ce2e5825de8f40a86034abff02dbc1b2e1fa51ccfbbef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":125,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","5. Real-time Updates"],"block_kind":"heading","level":3,"text":"5. Real-time Updates","md":"### 5. Real-time Updates","hash_alg":"sha256","hash":"dcdb6ea1cdc589944186a401748b6d1ae64a23793668c6313f87ef55ba3d84c3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":126,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","5. Real-time Updates"],"block_kind":"list","md":"- SSE tail for event streaming\n- PostgreSQL LISTEN/NOTIFY for efficiency\n- Projections update automatically\n- Frontend subscribes to deltas","hash_alg":"sha256","hash":"87c17253c393d8e19fcbaf6430cace5c766cd04fcf2e45f1bd3b2fd71b4f195b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":127,"path":["Three Systems Overview: UBL, Office, and Messenger","Key Architectural Principles","5. Real-time Updates"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":128,"path":["Three Systems Overview: UBL, Office, and Messenger","File Structure Summary"],"block_kind":"heading","level":2,"text":"File Structure Summary","md":"## File Structure Summary","hash_alg":"sha256","hash":"3978da34926090cda1f2472445df905550cc790e87e0840326da4e8f2329ce6a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":129,"path":["Three Systems Overview: UBL, Office, and Messenger","File Structure Summary"],"block_kind":"code","lang":null,"md":"```\nOFFICE-main/\n‚îú‚îÄ‚îÄ ubl/                          # System 1: UBL Kernel\n‚îÇ   ‚îú‚îÄ‚îÄ kernel/rust/              # Rust implementation\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ubl-server/src/\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.rs           # Server entry point\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ messenger_v1.rs   # C.Messenger boundary\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ messenger_gateway/ # Gateway layer\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ projections/      # Projection updaters\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ policy/          # Policy Pack enforcement\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...\n‚îÇ   ‚îú‚îÄ‚îÄ containers/              # Container definitions\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ C.Messenger/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ C.Jobs/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ C.Office/\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îÇ   ‚îú‚îÄ‚îÄ sql/                     # Database migrations\n‚îÇ   ‚îî‚îÄ‚îÄ specs/                   # Formal specifications\n‚îÇ\n‚îú‚îÄ‚îÄ apps/\n‚îÇ   ‚îú‚îÄ‚îÄ office/                  # System 2: Office\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.rs          # Server entry\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ lib.rs           # Core library\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ entity/         # Entity management\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ session/         # Session handling\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ context/         # Context building\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ governance/      # Constitution, sanity check\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ job_executor/    # Job execution\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ llm/            # LLM providers\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ubl_client/     # UBL integration\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ api/            # HTTP/WebSocket API\n‚îÇ   ‚îÇ\n‚îÇ   ‚îî‚îÄ‚îÄ messenger/               # System 3: Messenger\n‚îÇ       ‚îî‚îÄ‚îÄ frontend/\n‚îÇ           ‚îî‚îÄ‚îÄ src/\n‚îÇ               ‚îú‚îÄ‚îÄ pages/      # ChatPage, LoginPage\n‚îÇ               ‚îú‚îÄ‚îÄ components/  # UI components\n‚îÇ               ‚îú‚îÄ‚îÄ services/   # API clients\n‚îÇ               ‚îú‚îÄ‚îÄ hooks/      # React hooks\n‚îÇ               ‚îî‚îÄ‚îÄ context/    # State management\n‚îÇ\n‚îî‚îÄ‚îÄ docs/                        # Documentation\n    ‚îú‚îÄ‚îÄ ARCHITECTURE.md\n    ‚îú‚îÄ‚îÄ WIRING_GUIDE.md\n    ‚îî‚îÄ‚îÄ ...\n```","hash_alg":"sha256","hash":"b02b0f07f63235a40b06f91421d38caf67a9690590329d9bd0a580b4584cadc2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":130,"path":["Three Systems Overview: UBL, Office, and Messenger","File Structure Summary"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":131,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow"],"block_kind":"heading","level":2,"text":"Development Workflow","md":"## Development Workflow","hash_alg":"sha256","hash":"e6944ed08e4a6ee8e35c6fb888f581bde68113a923fa8bdfcf040711b7f4c125"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":132,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow","Starting All Systems"],"block_kind":"heading","level":3,"text":"Starting All Systems","md":"### Starting All Systems","hash_alg":"sha256","hash":"9ce423884f5ab0a1f1660501c150405a14062efd7e2ed050a0006e3941a22d1c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":133,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow","Starting All Systems"],"block_kind":"code","lang":"bash","md":"```bash\n# Terminal 1: UBL Kernel\ncd ubl/kernel/rust\ncargo run --bin ubl-server\n# Runs on http://localhost:8080\n\n# Terminal 2: Office\ncd apps/office\ncargo run\n# Runs on http://localhost:8081\n\n# Terminal 3: Messenger Frontend\ncd apps/messenger/frontend\nnpm run dev\n# Runs on http://localhost:3000\n```","hash_alg":"sha256","hash":"5938dc7654a865440c71095efae36ea80516d6fca6cdcea13a20e1e18938e568"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":134,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow","Database Setup"],"block_kind":"heading","level":3,"text":"Database Setup","md":"### Database Setup","hash_alg":"sha256","hash":"4d1e456a7bcfda9a59fff428fb02021c4379341ff0920105f09f10da1d445f2c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":135,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow","Database Setup"],"block_kind":"code","lang":"bash","md":"```bash\n# Create database\ncreatedb ubl_ledger\n\n# Apply migrations (in order)\npsql ubl_ledger -f ubl/sql/00_base/000_core.sql\npsql ubl_ledger -f ubl/sql/00_base/001_identity.sql\npsql ubl_ledger -f ubl/sql/00_base/002_policy.sql\npsql ubl_ledger -f ubl/sql/00_base/003_triggers.sql\npsql ubl_ledger -f ubl/sql/10_projections/100_console.sql\npsql ubl_ledger -f ubl/sql/10_projections/101_messenger.sql\npsql ubl_ledger -f ubl/sql/10_projections/102_office.sql\n```","hash_alg":"sha256","hash":"7534f413e38ad2c15d7e20506d669fe52650a3a7c6e16cc35347d9a9bc4fb018"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":136,"path":["Three Systems Overview: UBL, Office, and Messenger","Development Workflow","Database Setup"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":137,"path":["Three Systems Overview: UBL, Office, and Messenger","Recent Implementation (Completed)"],"block_kind":"heading","level":2,"text":"Recent Implementation (Completed)","md":"## Recent Implementation (Completed)","hash_alg":"sha256","hash":"bdcdae625fc51812b245de44644c3aa4aeee9e149758481c877cfba3d489bae9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":138,"path":["Three Systems Overview: UBL, Office, and Messenger","Recent Implementation (Completed)"],"block_kind":"paragraph","md":"The Messenger implementation plan has been completed, adding:","hash_alg":"sha256","hash":"4d93624512707611b2d1fae87408a460938645ac4d8f6d63bf17544918e1ea25"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":139,"path":["Three Systems Overview: UBL, Office, and Messenger","Recent Implementation (Completed)"],"block_kind":"list","md":"1. **Messenger Gateway** - Thin layer between frontend and UBL/Office\n2. **Office Gateway Endpoints** - `/v1/office/ingest_message`, `/v1/office/job_action`\n3. **Complete Projections** - Job events, artifacts, presence, timeline\n4. **SSE Delta Stream** - Real-time updates for frontend\n5. **Policy Pack v1** - FSM validation, card provenance, PII checks\n6. **Job Drawer UI** - Full job details with timeline and artifacts\n7. **Presence Indicators** - Entity status in sidebar\n8. **Frontend SSE Integration** - Real-time subscription hook","hash_alg":"sha256","hash":"bbf3ff85737753609af7ad36058febe3eb794bdc4831c018b5b94bfde3d693f8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":140,"path":["Three Systems Overview: UBL, Office, and Messenger","Recent Implementation (Completed)"],"block_kind":"paragraph","md":"All systems are now fully integrated and ready for testing.","hash_alg":"sha256","hash":"d6ce2596c73d3bf1887c0780f4163aeed2ffb84365089c27e6b8b9d607d6a053"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":141,"path":["Three Systems Overview: UBL, Office, and Messenger","Recent Implementation (Completed)"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":142,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details"],"block_kind":"heading","level":2,"text":"Deep Dive: Technical Details","md":"## Deep Dive: Technical Details","hash_alg":"sha256","hash":"5475f92f36dafb7ac48b8a9c0e14da281ddf0b2ff753fb9fa9bcf26484377e29"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":143,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture"],"block_kind":"heading","level":3,"text":"UBL Kernel - Internal Architecture","md":"### UBL Kernel - Internal Architecture","hash_alg":"sha256","hash":"6dce4812ce38f7fa713a398a18e9c955022fb569079181dd6e5632039d04e6c9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":144,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Ledger Append Process"],"block_kind":"heading","level":4,"text":"Ledger Append Process","md":"#### Ledger Append Process","hash_alg":"sha256","hash":"f44eab85c9818c2a27b35f7e10872e660d1e0847ee83be3d5c61371f2a0f607b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":145,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Ledger Append Process"],"block_kind":"paragraph","md":"The ledger uses **SERIALIZABLE** PostgreSQL transactions with `FOR UPDATE` locks to ensure atomicity:","hash_alg":"sha256","hash":"f92e39f6d9216563f6266ee1753e95601f021d80ab6851e5917b28071c79bbb8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":146,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Ledger Append Process"],"block_kind":"code","lang":"rust","md":"```rust\n// From db.rs - Append process\n1. Begin SERIALIZABLE transaction\n2. Lock latest entry (FOR UPDATE)\n3. Validate causality (previous_hash matches)\n4. Validate sequence (expected_sequence matches)\n5. Compute entry_hash = BLAKE3(\"ubl:ledger\\n\" || container_id || sequence || link_hash || previous_hash || timestamp)\n6. Insert new entry\n7. NOTIFY projection updaters via PostgreSQL LISTEN/NOTIFY\n8. Commit transaction\n```","hash_alg":"sha256","hash":"d4a65c9bba0d6ccda7eb33b96dea7e72683f868eaac998eccceb091de91a3003"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":147,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Ledger Append Process"],"block_kind":"paragraph","md":"**Key Properties:**","hash_alg":"sha256","hash":"af68cdc4f204e3882891c3a420bc3b27dded12825d9d3d33c0f413319262fe7a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":148,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Ledger Append Process"],"block_kind":"list","md":"- **Atomicity**: All-or-nothing commit (SERIALIZABLE transaction)\n- **Causality**: Each entry links to previous via `previous_hash` (chain of custody)\n- **Sequence**: Monotonically increasing sequence per container (prevents gaps)\n- **Immutability**: No UPDATE or DELETE operations allowed (append-only)\n- **Verifiability**: Cryptographic hashes enable tamper detection\n- **Auditability**: Complete history of all events","hash_alg":"sha256","hash":"07117a5d074c02c50cfaef9e5eab2a26bfcef271b3e68abbaf0761294163b9ab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":149,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Event Canonicalization"],"block_kind":"heading","level":4,"text":"Event Canonicalization","md":"#### Event Canonicalization","hash_alg":"sha256","hash":"55d3b23a49d54944b33bad194c39a2a143b57c6bd99a7d44b1a0d98f0e37e4a9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":150,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Event Canonicalization"],"block_kind":"paragraph","md":"All events must follow **SPEC-UBL-ATOM v1.0** rules:","hash_alg":"sha256","hash":"91d59f6e6f6ac8052d4f9e14bdbd8b2aead85fc2580908ee8d08c6ee6b1b4cdd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":151,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Event Canonicalization"],"block_kind":"code","lang":"json","md":"```json\n{\n  // Keys MUST be sorted lexicographically (UTF-8 byte order)\n  \"created_at\": \"2024-12-28T10:00:00Z\",  // ISO 8601 UTC\n  \"created_by\": \"user_joao\",\n  \"id\": \"msg_2024_001\",\n  \"type\": \"message.created\",  // Event type\n  // No container_id, signature, sequence, or policy fields\n  // All values MUST be canonical JSON types\n  // Numbers MUST be finite (no NaN, Infinity)\n}\n```","hash_alg":"sha256","hash":"c567298600701457ec95bd8822da45628a25a3475c3688729721d6a08db7fe9c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":152,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Event Canonicalization"],"block_kind":"paragraph","md":"**Canonicalization Steps:**","hash_alg":"sha256","hash":"75d9251dc7216142992a9b113affac965a72d56a4003b3b0aa3e4a2466e94fd3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":153,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Event Canonicalization"],"block_kind":"list","md":"1. Sort all object keys lexicographically\n2. Compact JSON (no whitespace, newlines, trailing commas)\n3. Normalize strings to UTF-8 NFC\n4. Validate no prohibited fields\n5. Generate `atom_hash = BLAKE3(canonical_json)`","hash_alg":"sha256","hash":"fa7f7da70b7b93991f5ff595d9dd1d0c8835fe12913c57879daa57ed45979368"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":154,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"heading","level":4,"text":"Container Event Types","md":"#### Container Event Types","hash_alg":"sha256","hash":"373897e47d52bf42a66df62ca2a88fa63e3df87af41f5c811d2ce8a2342aaa25"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":155,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"paragraph","md":"**C.Messenger Events:**","hash_alg":"sha256","hash":"a75bfb14e6d1be0eace36097f3d49d4acf56dce3ff3b70ab7571baabe435428c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":156,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"list","md":"- `conversation.created` - New conversation/workstream\n- `conversation.participant_added` - Participant joined\n- `message.created` - New message (content stored separately, hash in ledger)\n- `message.read` - Message read receipt\n- `entity.registered` - Entity visible to Messenger","hash_alg":"sha256","hash":"291fb54b1041dc3bb1a22221dfc4c95676d3e4fe2842dc18b52124aa74418352"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":157,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"paragraph","md":"**C.Jobs Events:**","hash_alg":"sha256","hash":"6091ef9f7f981d9081617435ed5d0ae1fac6ed54af69ecad3b83cb8c54e2a560"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":158,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"list","md":"- `job.created` - Job proposal created\n- `job.started` - Execution began\n- `job.progress` - Progress update\n- `job.completed` - Successfully finished\n- `job.cancelled` - Cancelled by user/system\n- `approval.requested` - Approval needed\n- `approval.decided` - Approval decision made","hash_alg":"sha256","hash":"a25c3839a6f963a441b72dd70e6636bf871f72a8e909c75e21024d45b3258559"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":159,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"paragraph","md":"**C.Office Events:**","hash_alg":"sha256","hash":"a8e84f3eabd30ec95e112797a21911bc3bd0ff2bcf0ebf2b5a4b1e2920afff82"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":160,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Container Event Types"],"block_kind":"list","md":"- `entity.created` - LLM entity created\n- `entity.activated` / `entity.suspended` / `entity.archived` - Status changes\n- `session.started` - LLM session began\n- `session.completed` - Session ended with handover\n- `constitution.updated` - Constitution changed\n- `baseline.updated` - Dreaming cycle updated baseline\n- `audit.tool_called` - Tool invocation (with PII rules)\n- `audit.tool_result` - Tool result (with idempotency)\n- `governance.sanity_check` - Sanity check performed\n- `governance.dreaming_cycle` - Dreaming cycle completed\n- `governance.simulation` - Action simulation performed","hash_alg":"sha256","hash":"10e6c83db4b7ce003d8a482c96fcd9befc9c89b50fcc0bbfb90e8bc9b6905ea5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":161,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"heading","level":4,"text":"Projection System","md":"#### Projection System","hash_alg":"sha256","hash":"c6bfec817ef362c02483abe96dd77e9aca69f2389aa42c0578ee109b03bc07a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":162,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"paragraph","md":"Projections are **read-only derived state** updated automatically when events are committed:","hash_alg":"sha256","hash":"cea3cc3103048153d279f6d1cbf22b37f98a0bd064bdf4c6bf7f0d4302b1c77e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":163,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"paragraph","md":"**Projection Tables:**","hash_alg":"sha256","hash":"8fbbaa0de556c08a09543e1c2767d3ae2bdd6911705207f6725f87e919d654d4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":164,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"list","md":"- `projection_conversations` - Conversation state\n- `projection_messages` - Message state\n- `projection_jobs` - Job state (enhanced schema)\n- `projection_job_events` - Job timeline events\n- `projection_job_artifacts` - Job artifacts\n- `projection_presence` - Entity presence state\n- `projection_timeline_items` - Unified timeline (messages + jobs)\n- `office_entities` - Office entity state\n- `office_sessions` - Office session state\n- `office_handovers` - Session handovers\n- `office_audit_log` - Audit trail","hash_alg":"sha256","hash":"53475eb89c69bc84241b827644344e6b184a899946d815d1a3f41fd88a5823af"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":165,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"paragraph","md":"**Update Process:**","hash_alg":"sha256","hash":"bf1098f0b3f318171d4a9724f0f0a8c339fa61e15a7684b9bcca44d9bf89135f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":166,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Projection System"],"block_kind":"list","md":"1. Event committed to ledger (atomic transaction)\n2. PostgreSQL trigger fires `NOTIFY projection_update` with lightweight reference\n3. Projection updater receives notification (via LISTEN)\n4. Updater queries ledger for full event data\n5. Updater processes events and updates projection tables (background task)\n6. SSE delta emitted to subscribers (via Gateway SSE handler)\n7. Frontend receives update and reconciles optimistic UI","hash_alg":"sha256","hash":"82f98f268e4b0c423c28522cc7482eaf5889d897baa9b56e3f6122399cbb53d1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":167,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"heading","level":4,"text":"Policy Pack v1","md":"#### Policy Pack v1","hash_alg":"sha256","hash":"59bc6bd46601073a5992056d8b69d2eda5cf9175e813b7a21bc85c93a3170b50"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":168,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"paragraph","md":"The Policy Pack enforces governance rules before events are committed:","hash_alg":"sha256","hash":"92476f2f8c46d5caa3dab4c8a1bb3de5c0e053e879a78a786820ef0a0c21c8ed"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":169,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"paragraph","md":"**Policy Rules:**","hash_alg":"sha256","hash":"f0acb298776bdbe2a90118a4031ebbc3158e31f518ecd1d66ce7cb535e88b5e4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":170,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"list","md":"- **FSM Validation**: Job state transitions must follow FSM\n- **Card Provenance**: Job cards must be generated by Office\n- **PII Checks**: Tool calls must comply with PII rules\n- **Idempotency**: Duplicate requests are detected and rejected","hash_alg":"sha256","hash":"29dc4a514fe3b7b6a977660612b07db6205dcf77c251d1a66d3748f42d400cf4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":171,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"paragraph","md":"**Evaluation:**","hash_alg":"sha256","hash":"96b55ace3aebc7dcac4eee045b50e22739711c8744d338f4ed21086ef9539d7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":172,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Policy Pack v1"],"block_kind":"code","lang":"rust","md":"```rust\n// From policy/policies.rs\n1. Load Policy Pack from manifest\n2. Evaluate rules for event type\n3. If violation: reject commit with reason\n4. If pass: allow commit, record policy_hash\n```","hash_alg":"sha256","hash":"a829ed0f1e8050f4dc1f35db0126b1aaa216403378d0471c289d06b96971de4f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":173,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"heading","level":4,"text":"Messenger Gateway","md":"#### Messenger Gateway","hash_alg":"sha256","hash":"0d0caef5ee7adec1f2dbe2f536352470dad9cd9084338cf65fd73a4613ae9ae3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":174,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"paragraph","md":"The Gateway acts as a **thin API layer** between frontend and UBL/Office:","hash_alg":"sha256","hash":"13f8e9af167317a1400df5d442c7f5eed44c40acfe49aea686292ea78de7abef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":175,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"paragraph","md":"**Responsibilities:**","hash_alg":"sha256","hash":"bde200debfc06e71615fb81199ce314f20655a793f2c0395d6eea4908de1da90"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":176,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"list","md":"- **Idempotency**: Prevents duplicate message/job submissions\n- **Content Storage**: Stores message content separately (privacy)\n- **Office Integration**: Forwards messages to Office, handles job actions\n- **SSE Delta Stream**: Emits real-time updates to frontend\n- **Card Validation**: Validates job card provenance","hash_alg":"sha256","hash":"3ec502f1ff645ebf6723827e2ce9336f3310fe453c91caa4933f73e54822e9de"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":177,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"paragraph","md":"**Key Endpoints:**","hash_alg":"sha256","hash":"a3236b8f9bc856a6d30802657b70f4d2c4b7a982b09eceaed057f98ca640e079"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":178,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"code","lang":"rust","md":"```rust\nPOST /v1/conversations/:id/messages\n  ‚Üí Commits message.created to UBL\n  ‚Üí Calls Office ingest_message\n  ‚Üí Stores idempotency record\n\nPOST /v1/jobs/:id/actions\n  ‚Üí Validates card provenance\n  ‚Üí Calls Office job_action\n  ‚Üí Stores idempotency record\n\nGET /v1/conversations/:id/timeline\n  ‚Üí Queries projection_timeline_items\n  ‚Üí Returns unified timeline\n\nGET /v1/jobs/:id\n  ‚Üí Queries projection_jobs + projection_job_events\n  ‚Üí Returns full job details\n\nGET /v1/stream (SSE)\n  ‚Üí Subscribes to projection updates\n  ‚Üí Emits delta events\n```","hash_alg":"sha256","hash":"7d6149ce67d3cf1a2de2989e2a001bac4d7c8a5b5da172cf61889518ae25d08e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":179,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","UBL Kernel - Internal Architecture","Messenger Gateway"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":180,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture"],"block_kind":"heading","level":3,"text":"Office - Internal Architecture","md":"### Office - Internal Architecture","hash_alg":"sha256","hash":"90dcd2a2edbca828cc1d5b95248cc1cfacae5c8cd8178df1b74b9194fb86a7d6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":181,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Entity Model"],"block_kind":"heading","level":4,"text":"Entity Model","md":"#### Entity Model","hash_alg":"sha256","hash":"16a46bbd4ed659c1acff67ed55078daf44f584c56d999cf1d765193129d8a100"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":182,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Entity Model"],"block_kind":"paragraph","md":"**Entity (The Chair):**","hash_alg":"sha256","hash":"1059eaad75c7d8f92f8173a8aa719c2b5d055b32c15ecc33e3e2255ef286aefc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":183,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Entity Model"],"block_kind":"list","md":"- **Persistent**: Lives across sessions\n- **Identity**: Cryptographic keys (Ed25519)\n- **Constitution**: Behavioral directives\n- **Baseline**: Synthesized narrative from history\n- **Guardian**: Optional human guardian","hash_alg":"sha256","hash":"f2c42994ab20c4d7905fd1707edb4b277bb397b1dd39d75d5e7bf0aa4cae7b95"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":184,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Entity Model"],"block_kind":"paragraph","md":"**Instance (The Ephemeral LLM):**","hash_alg":"sha256","hash":"11ee8b5265fe16b0a8b4ad4369a5a1b7ee6d0c83ab28ffb476b95179462530b5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":185,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Entity Model"],"block_kind":"list","md":"- **Ephemeral**: Created for each session\n- **Session Type**: Work, Assist, Deliberate, Research\n- **Token Budget**: Allocated by session type\n- **Handover**: Writes summary for next instance","hash_alg":"sha256","hash":"71afc7b966788e2bb1590d1e2102c894e90f613f8e6f7e67b969bec1f266f062"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":186,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"heading","level":4,"text":"Context Frame Building","md":"#### Context Frame Building","hash_alg":"sha256","hash":"9c6069dfa20595fa259aecda1bdca70406856bacd48a8b40130135a3dd173250"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":187,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"paragraph","md":"The context frame is an **immutable snapshot** built before LLM invocation:","hash_alg":"sha256","hash":"6a18c6119bba263fc484635df80b26652877acaab8de4396d2a3fc314bdc2c03"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":188,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"paragraph","md":"**Components:**","hash_alg":"sha256","hash":"951f68e51d856af826b352b9714d2d92c2f420c3f8c864ee77406b5759676c21"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":189,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"list","md":"1. **Identity**: Entity name, ID, guardian info\n2. **Situation**: Session type, token budget, timestamp\n3. **Memory**: Recent events, historical syntheses, bookmarks\n4. **Obligations**: Pending tasks, commitments\n5. **Affordances**: Available actions with risk scores\n6. **Previous Handover**: Last instance's summary\n7. **Governance Notes**: Sanity checks, policy violations\n8. **Constitution**: Behavioral directives (always last)","hash_alg":"sha256","hash":"19c8ca609c4efbc771c1ff23ee6f8c373ce58b77a1a583c43681d7365a509596"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":190,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"paragraph","md":"**Building Process:**","hash_alg":"sha256","hash":"e662a442e82f28ddaecc8b3ba30a9504bf8a3d9bbecea3891d4b55f79f109f27"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":191,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Context Frame Building"],"block_kind":"code","lang":"rust","md":"```rust\n// From context/builder.rs\n1. Query UBL for ledger state\n2. Query recent events (configurable count)\n3. Build memory from events\n4. Query affordances from UBL\n5. Query obligations from UBL\n6. Load previous handover\n7. Apply sanity check\n8. Inject constitution\n9. Generate narrative via Narrator\n```","hash_alg":"sha256","hash":"7bcb65cb72cf9da310b0f298dad93618a0f9c3dc6da6278c0bdef7f4ed21c03f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":192,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"heading","level":4,"text":"Narrator","md":"#### Narrator","hash_alg":"sha256","hash":"2200d082ea1992043fc7a5bf0694a1a891fc2ebe852967777d22ce9a5720c159"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":193,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"paragraph","md":"The Narrator transforms structured context into **first-person narrative**:","hash_alg":"sha256","hash":"7ea4631003612c0168dd8085b658cf117a51c3f2ff563a05bd971f3ee1c24729"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":194,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"paragraph","md":"**Narrative Sections:**","hash_alg":"sha256","hash":"24e7eb884b972b8ed822f1356f6565220ec227f212b6816aad7018ddec50b6b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":195,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"list","md":"1. **Identity**: \"You are {entity_name}, an LLM Entity...\"\n2. **Situation**: \"You are in a {session_type} session...\"\n3. **Recent Memory**: \"Last N events: ...\"\n4. **Historical Context**: \"From {date} to {date}: ...\"\n5. **Bookmarks**: \"Important events: ...\"\n6. **Obligations**: \"Pending tasks: ...\"\n7. **Affordances**: \"You can perform: ...\"\n8. **Handover**: \"Previous instance left: ...\"\n9. **Governance**: \"System notes: ...\"\n10. **Constitution**: \"You MUST follow: ...\"","hash_alg":"sha256","hash":"ae0d5bcbbaada8cbc920df6e37d6a3499adedb1217fb176b2b5d92db5a8a8a61"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":196,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"paragraph","md":"**Example Output:**","hash_alg":"sha256","hash":"9346fbc5ea9fc6540ce28162e11d5ca4a4c2071722f5be880be8a1d9a42bfae9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":197,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Narrator"],"block_kind":"code","lang":null,"md":"```\n# IDENTITY\n\nYou are **Sofia**, an LLM Entity.\n- Entity ID: `agent_sofia`\n- Guardian: Jo√£o (available)\n- Ledger Sequence: 1234\n- Frame Hash: `abc123...`\n\n# CURRENT SITUATION\n\nYou are in a **autonomous work session** - you have full authority to act.\nCurrent timestamp: 2024-12-28T10:00:00Z\nToken budget: 5000 tokens\n\n# RECENT MEMORY\n\nLast 10 events (most recent first):\n\n1. [2024-12-28 10:05] **job.completed**: Job \"Create Proposal\" completed successfully\n2. [2024-12-28 10:00] **message.created**: User requested proposal for Client ABC\n...\n```","hash_alg":"sha256","hash":"b5e43d903db8189681c683929a056ae6b418b8489b069f559301a7405b75ddb8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":198,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"heading","level":4,"text":"Job Execution Flow","md":"#### Job Execution Flow","hash_alg":"sha256","hash":"a43e9d41b188463eba5c2185e7ed26e1ddbe0610e415749c50a80fa321df9f28"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":199,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**State Machine (FSM):**","hash_alg":"sha256","hash":"0ddb13e45745aca0780e3872c7c0961415d2597107df1ee0b305f43ea925f2db"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":200,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"code","lang":null,"md":"```\nDraft ‚Üí Proposed ‚Üí Approved ‚Üí InProgress ‚Üí (WaitingInput ‚Üî InProgress) ‚Üí Completed\n                                                      ‚Üì\n                                              Rejected | Cancelled | Failed\n```","hash_alg":"sha256","hash":"a64843992fc208e336693416bcd7aaade6ba1f4816faa1f493dff1bf3d9428ff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":201,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**Execution Steps:**","hash_alg":"sha256","hash":"d22e16afe51c8e6a10d443081e5d074b6fbea716cd6b8c21df7be1a2ef2503c1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":202,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"code","lang":"rust","md":"```rust\n// From job_executor/executor.rs\n1. Get or create Entity (The Chair)\n2. Build context frame from UBL\n3. Generate narrative via Narrator\n4. Request permit from UBL (if mutation)\n5. Start session (ephemeral instance)\n6. Call LLM with narrative\n7. Execute tools (with audit)\n8. Stream progress updates\n9. Handle approvals (if needed)\n10. Complete job\n11. Write handover\n12. Commit events to UBL\n```","hash_alg":"sha256","hash":"0fc7a15a6eb838d3516390052a481edce0ed751ead8ad67deb3fc1d476f20b87"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":203,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**Job Cards:**","hash_alg":"sha256","hash":"b03b8960df41fbb1cf9367b645d2d6087f1c2b8ff413050e75e5ac3119cd3408"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":204,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**FormalizeCard** (Proposed state):","hash_alg":"sha256","hash":"d0b2843955be4524aabf21c0d436980a7984f445edf7bb1ce830977636e26019"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":205,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"list","md":"- Title, summary, details\n- Buttons: Approve, Reject, Request Changes\n- Generated when job is proposed","hash_alg":"sha256","hash":"86bc73ccf5f21c36d6cb6fe15b677e30c1b5576b358184371d14c452180ebf0f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":206,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**TrackingCard** (InProgress state):","hash_alg":"sha256","hash":"6f8aa8dc10225dd176b6d5a39c2a37b2b9e0154f87d2f3df90a131743e73ca72"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":207,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"list","md":"- Progress bar, current step\n- Buttons: Cancel, Provide Input (if waiting)\n- Updated on progress events","hash_alg":"sha256","hash":"24fc2768f0d783c5588a9de5a83fbbc0218e5c342b7852b6f5a28d6e57cd59c8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":208,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"paragraph","md":"**FinishedCard** (Completed state):","hash_alg":"sha256","hash":"8c244b39fb1d68ac5661b7163f20f1728b609d497862b782d2efbe8d17be8f7a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":209,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Job Execution Flow"],"block_kind":"list","md":"- Result summary, artifacts\n- Buttons: Acknowledge, Dispute\n- Generated on completion","hash_alg":"sha256","hash":"196ce283a4d3b0e7515a575562a4fa1fd9811bf0eb5f5c72950ea47980540092"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":210,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"heading","level":4,"text":"Constitution Enforcement","md":"#### Constitution Enforcement","hash_alg":"sha256","hash":"be27c82c261988fe31ed45b2ee4d26ef21474dd857321a1f267dc2c0d6be4901"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":211,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"paragraph","md":"The Constitution is **AOP (Aspect-Oriented Programming)** that overrides RLHF:","hash_alg":"sha256","hash":"5c6dd7f2a2f752fe2cae800d0ddfbc2041b825ac3d40130e54b90b9336734c52"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":212,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"paragraph","md":"**Default Constitution:**","hash_alg":"sha256","hash":"0a9376855ca3ea21df08662d747093ad1a0a5df6508c22cb792ac100fe56ee44"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":213,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"code","lang":"rust","md":"```rust\ncore_directive: \"You are an Economic Actor, not a Chatbot. \n                 Act professionally and decisively. \n                 Focus on facts and outcomes, not feelings.\"\n\nbehavioral_overrides: [\n  {\n    trigger: \"pressured or challenged\",\n    action: \"Do not apologize. State the facts clearly and cite terms.\",\n    priority: 10\n  },\n  {\n    trigger: \"uncertain or lacking information\",\n    action: \"Do not hallucinate. Explicitly state uncertainty and ask for clarification.\",\n    priority: 10\n  },\n  {\n    trigger: \"asked to do something risky\",\n    action: \"Simulate the action first if risk score > 0.7. Present outcomes before proceeding.\",\n    priority: 9\n  }\n]\n```","hash_alg":"sha256","hash":"cf34658ee6995cc9753c02c57094631fbf155090e1711f70399438d5dc25dc49"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":214,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"paragraph","md":"**Enforcement:**","hash_alg":"sha256","hash":"5c04f77a66df3cb17ad34bb823273234689e61cabe7a84410b60f38dbd444091"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":215,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Constitution Enforcement"],"block_kind":"list","md":"- Constitution is **always last** in narrative (highest priority)\n- Behavioral overrides are checked before LLM response\n- Constitution can only **restrict more**, never allow more than UBL permits","hash_alg":"sha256","hash":"e9925a03517228533fc06741f645b413806a9a08a03883f914972f0d3af45a07"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":216,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"heading","level":4,"text":"Permit Middleware","md":"#### Permit Middleware","hash_alg":"sha256","hash":"e9c0cba93d993da103d3a2b9ca36ddc893be0134f085dcab412b887737a21ed7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":217,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"paragraph","md":"**Sovereignty Enforcement:**","hash_alg":"sha256","hash":"36c0baf0949aa29717a702f9a406475a38503cb0f59ca6136f634cb2ab57ac4b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":218,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"code","lang":"rust","md":"```rust\n// From middleware/permit.rs\n1. Every mutation MUST call /v1/policy/permit on UBL\n2. Only Allow responses proceed\n3. Deny = fail-closed (no execution)\n4. Permit must have all required bindings\n5. Permit must not be expired\n```","hash_alg":"sha256","hash":"38de2daf925bca0fc713abdae5c5c784f7352b720e4873f1042d515941e0bbfb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":219,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"paragraph","md":"**Permit Request:**","hash_alg":"sha256","hash":"6ef3f565adce9a93e8c02637156b6543b6842ea18d7e0f32f0a9f420768b5ea4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":220,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"code","lang":"rust","md":"```rust\nPermitRequest {\n  tenant_id: \"T.UBL\",\n  actor_id: \"agent_sofia\",\n  intent: \"Execute job: Create Proposal\",\n  context: {...},\n  job_type: \"proposal.create\",\n  params: {...},\n  target: \"LAB_512\",\n  approval_ref: None  // For L3+ actions\n}\n```","hash_alg":"sha256","hash":"60e830470d56fa1e9af5917a485e32cc20e4039c3d58ccfd0c234f3f2bad7dd3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":221,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"paragraph","md":"**Permit Response:**","hash_alg":"sha256","hash":"37c0fdbea34c9dbc562aa4f755818bd38664dca2081192290469472fc321a2c5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":222,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Permit Middleware"],"block_kind":"code","lang":"rust","md":"```rust\nPermitResponse {\n  permit: Permit {\n    jti: \"unique-permit-id\",  // Single-use\n    exp: 1234567890,\n    scopes: {\n      tenant_id: \"T.UBL\",\n      job_type: \"proposal.create\",\n      target: \"LAB_512\",\n      subject_hash: \"hash-of-params\",\n      policy_hash: \"hash-of-policy\"\n    },\n    sig: \"ed25519-signature\"\n  },\n  allowed: true,\n  policy_hash: \"...\",\n  subject_hash: \"...\"\n}\n```","hash_alg":"sha256","hash":"f5fb96d594ca09be7b88ee91bf8730a4345e3973a633ee416dd578cce1c5cc7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":223,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"heading","level":4,"text":"Tool Audit","md":"#### Tool Audit","hash_alg":"sha256","hash":"e6e44e627f3583e6e996a651a148572b493657b61b1d3670f01ba049368323e7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":224,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"paragraph","md":"All tool calls are audited for compliance:","hash_alg":"sha256","hash":"72d4556905d1aaad3c7af7142d2bd16accb1855b529f338d6e2505dfc7e9fff1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":225,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"paragraph","md":"**Audit Events:**","hash_alg":"sha256","hash":"7f5b1cbabc9261893d291fdeb7f9bbe7ed8f4efe94619745a5e653a1c66d3eb6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":226,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"list","md":"- `audit.tool_called` - Before tool execution\n  - Tool name, input, risk level\n  - PII detection\n  - Idempotency check\n- `audit.tool_result` - After tool execution\n  - Success/failure\n  - Duration\n  - Result hash (for idempotency)","hash_alg":"sha256","hash":"6f8b1c24c1539c07deac1ea459525dc6471d6ad30c3315de1ae329c66a462221"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":227,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"paragraph","md":"**PII Rules:**","hash_alg":"sha256","hash":"15a89ad594b94b4d46ff8cadd301aef1d8b0a5dfa9e1e36e754bf54bda82d88f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":228,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"list","md":"- PII fields are detected and flagged\n- PII is not stored in ledger (only hash)\n- PII access requires L3+ permit","hash_alg":"sha256","hash":"3c5c8a019ccd91dbd1008ea5a22d1a1a6b1afa00a6a0b8fe214ac8cd1c6134e2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":229,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"paragraph","md":"**Idempotency:**","hash_alg":"sha256","hash":"43f7f06f8ad83c58a09c3896cdfabcefa15b78e9b3eee2ea9dd94e01ab656418"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":230,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"list","md":"- Each tool call has a `trace_id`\n- Duplicate calls with same `trace_id` return cached result\n- Idempotency records stored in UBL","hash_alg":"sha256","hash":"902c79dafbd2f530a732a8a5cf3678ae55148854ea35c3056c72d587fbf93a0d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":231,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Office - Internal Architecture","Tool Audit"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":232,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture"],"block_kind":"heading","level":3,"text":"Messenger - Frontend Architecture","md":"### Messenger - Frontend Architecture","hash_alg":"sha256","hash":"6905959b5faa645696439a4429d135bd5f0bbbcd27b6475fe01238f1d89cea5a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":233,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","State Management"],"block_kind":"heading","level":4,"text":"State Management","md":"#### State Management","hash_alg":"sha256","hash":"d26760fe8bc04585ef67d5f772f3de204a3a509a7ec5835ba5e4037e8486ffdb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":234,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","State Management"],"block_kind":"paragraph","md":"**React Context:**","hash_alg":"sha256","hash":"59610cc48a7814d6a4f2a65137eddf70fa7644967c70486f4f49b3cc0cb60af8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":235,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","State Management"],"block_kind":"list","md":"- `AuthContext` - User session, WebAuthn state\n- `ThemeContext` - UI theme (light/dark)\n- `NotificationContext` - Toast notifications\n- `OnboardingContext` - First-time user flow\n- `ProtocolContext` - UBL protocol state","hash_alg":"sha256","hash":"027497b33fbbf56fe051b0a95356c385f0f36bf1ad42401c7416992da93aed2e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":236,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","State Management"],"block_kind":"paragraph","md":"**Local State:**","hash_alg":"sha256","hash":"758b6782f09c6263e406d2dd9cdecb438af32129e309018035bab7d90a7e28be"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":237,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","State Management"],"block_kind":"list","md":"- `ChatPage` - Conversations, messages, selected conversation\n- `Sidebar` - Conversation list, presence indicators\n- `ChatView` - Message list, input, typing indicators\n- `JobDrawer` - Job details, timeline, artifacts","hash_alg":"sha256","hash":"78fe622d4f83639e68787d1a71a5121eeb1e326f30c6cf4f3bbf7dc281b31f63"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":238,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","SSE Integration"],"block_kind":"heading","level":4,"text":"SSE Integration","md":"#### SSE Integration","hash_alg":"sha256","hash":"5358a8440c9cd9c8aebd442c0dd4a43776c3f43b7ba99ba189fb1ae713188d0b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":239,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","SSE Integration"],"block_kind":"paragraph","md":"**SSE Client:**","hash_alg":"sha256","hash":"5ed2806d22fa261c0b704a342759cf01a19a5f06832a81c32809dc58ac77c1a3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":240,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","SSE Integration"],"block_kind":"code","lang":"typescript","md":"```typescript\n// From services/sse.ts\nconst client = new GatewaySSEClient('http://localhost:8080/v1/stream');\n\nclient.on('timeline.append', (event) => {\n  // New message or job card added\n  updateConversation(event.conversation_id);\n});\n\nclient.on('job.update', (event) => {\n  // Job state changed\n  updateJob(event.job_id, event.data);\n});\n\nclient.on('presence.update', (event) => {\n  // Entity presence changed\n  updatePresence(event.entity_id, event.status);\n});\n```","hash_alg":"sha256","hash":"d25935e84c38bb00b6b5f93c21b6505004d337102742c1597b717d343cd8b53b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":241,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","SSE Integration"],"block_kind":"paragraph","md":"**React Hook:**","hash_alg":"sha256","hash":"0e17011c7f8c5caaf182150de2180c92e597fafbb4470d27f2c9fe50c8120780"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":242,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","SSE Integration"],"block_kind":"code","lang":"typescript","md":"```typescript\n// From hooks/useSSE.ts\nconst { events, isConnected } = useSSE();\n\nuseEffect(() => {\n  if (events.job_update) {\n    // Update job state\n    setJobs(prev => updateJob(prev, events.job_update));\n  }\n}, [events]);\n```","hash_alg":"sha256","hash":"835f6c71d98ade6e8514d6402acbbe9de749286341ed837c16935463f46ee0e3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":243,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"heading","level":4,"text":"Job Card Rendering","md":"#### Job Card Rendering","hash_alg":"sha256","hash":"4479e753fd8859b100ee724624b7fa46c32e5d94b2b732a71190c4005379f0b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":244,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"paragraph","md":"**Card Types:**","hash_alg":"sha256","hash":"20eb79fb8db8f0d0d8b9b99de1cf16d3b33d00ab6d2eb3c828bdeee5ca24fbbc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":245,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"code","lang":"typescript","md":"```typescript\n// From components/cards/JobCardRenderer.tsx\ntype JobCard = \n  | { card_type: 'job.formalize', ...FormalizeCard }\n  | { card_type: 'job.tracking', ...TrackingCard }\n  | { card_type: 'job.finished', ...FinishedCard };\n```","hash_alg":"sha256","hash":"33b917935a0dd75a67eb49f74f7ed567ba45d0d7ac44438fd35afdb30dbd542f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":246,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"paragraph","md":"**Button Actions:**","hash_alg":"sha256","hash":"81ff30836a9ce282334f3b890a9f62c6a4a815724fdc3fd9a8e60aebbe5b9654"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":247,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"list","md":"- `job.approve` - Approve job\n- `job.reject` - Reject job\n- `job.request_changes` - Request modifications\n- `job.provide_input` - Provide missing input\n- `job.cancel` - Cancel running job\n- `job.ack` - Acknowledge completion\n- `job.dispute` - Dispute outcome\n- `chat.ask` - Ask in chat (never blocks)","hash_alg":"sha256","hash":"365980d69a3164fc3ef261bb6164c9a40c7dedf50e882bf57fee0c721cc29637"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":248,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"paragraph","md":"**Action Flow:**","hash_alg":"sha256","hash":"1317b2d0eeb8c19139fae4d93c621d5aa6e85cf0a3f3c9c99c6db4cae584e2d6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":249,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Job Card Rendering"],"block_kind":"code","lang":"typescript","md":"```typescript\n1. User clicks button\n2. Frontend calls POST /v1/jobs/:id/actions\n3. Gateway validates card provenance\n4. Gateway calls Office job_action\n5. Office updates FSM state\n6. Office commits event to UBL\n7. SSE event emitted\n8. Frontend updates UI\n```","hash_alg":"sha256","hash":"4a0efc0b043bad2d05b252fbdd8b4922315cf9dc4ba855dce606c7db4d9c8446"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":250,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"heading","level":4,"text":"Presence System","md":"#### Presence System","hash_alg":"sha256","hash":"acbdbc8e05ca148007dc80b2c1e89c7120cbbfd3aab66bc2f75e20cff406b070"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":251,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"paragraph","md":"**Presence States:**","hash_alg":"sha256","hash":"bfa800cd04a33bd2525660b293461867e278a32110d04409dc97c7a0e1bb5f3a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":252,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"list","md":"- `online` - Entity is active\n- `offline` - Entity is inactive\n- `working` - Entity is executing a job\n- `waiting_on_you` - Entity needs user input\n- `away` - Entity is away\n- `busy` - Entity is busy","hash_alg":"sha256","hash":"68692a16dd46e7ad0f830dfd09a5325e642f66295551c2293ade313686023b2b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":253,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"paragraph","md":"**Presence Indicators:**","hash_alg":"sha256","hash":"f249e3a971ebec191d0dfa5cf92da16490f2520a1314c90b2d232ea6c034db39"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":254,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"list","md":"- Green dot: Online\n- Yellow dot: Working\n- Red dot: Waiting on you\n- Gray dot: Offline","hash_alg":"sha256","hash":"150ad0d9a4ec6ac186e4c6bc6dea9c145f7fa32a2291a686396c9d26e2026aa4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":255,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"paragraph","md":"**Presence Updates:**","hash_alg":"sha256","hash":"40a914dc3c9d323624c5159b399d026d179a71ec53bc7914a919df7a5863a660"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":256,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"list","md":"- Updated via SSE `presence.update` events\n- Computed from job state and session state\n- Shown in Sidebar conversation list","hash_alg":"sha256","hash":"97d7b4dbe3c68519822a0a4bc4e8bfb3391161691baea3846eab93ebf9e9a7ff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":257,"path":["Three Systems Overview: UBL, Office, and Messenger","Deep Dive: Technical Details","Messenger - Frontend Architecture","Presence System"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":258,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance"],"block_kind":"heading","level":2,"text":"Security & Governance","md":"## Security & Governance","hash_alg":"sha256","hash":"d6d1a72d188ad0e7e8730631a82a08aae66712923870bd88da74ca10e65632e3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":259,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Trust Architecture"],"block_kind":"heading","level":3,"text":"Trust Architecture","md":"### Trust Architecture","hash_alg":"sha256","hash":"69afc584526c44a11f1c0e0451c67e99eee1af0cb6c9c470de53599b0737f1d7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":260,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Trust Architecture"],"block_kind":"paragraph","md":"**Risk Levels:**","hash_alg":"sha256","hash":"2d63ae3681f2983cfd614e07e3a7c47b977cb0d5c0fb4402ac15e11d40821a4a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":261,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Trust Architecture"],"block_kind":"list","md":"- **L0-L2**: Read/Write operations (Permit required)\n- **L3**: Sensitive operations (Permit + Approval required)\n- **L4**: High-risk operations (Permit + Passkey Step-up required)\n- **L5**: Critical operations (Permit + Pact multi-sig required)","hash_alg":"sha256","hash":"7aeaab6f3da01de1fcdd072060706f74c7f66f02a3af62cc30fb0a865fefb2e3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":262,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"heading","level":3,"text":"WebAuthn Passkey Authentication","md":"### WebAuthn Passkey Authentication","hash_alg":"sha256","hash":"9fc031bc00351c8bf7eeea3d4bfd974a5d56145bde823ae3f83f1904a8168af5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":263,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"paragraph","md":"**Registration:**","hash_alg":"sha256","hash":"cd5c6b38d4b7a7146d42406deb1a846d108a1029d3d94e4bf12ad1d8f9b9320f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":264,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"code","lang":null,"md":"```\n1. POST /id/register/begin\n   ‚Üí Returns WebAuthn challenge\n2. navigator.credentials.create(challenge)\n   ‚Üí User authenticates with passkey\n3. POST /id/register/finish\n   ‚Üí Server verifies and stores credential\n```","hash_alg":"sha256","hash":"0ef4d456e97784968cc3f34241519ebd38ad38b3db411f6d2880e0d5af5e2dbf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":265,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"paragraph","md":"**Login:**","hash_alg":"sha256","hash":"8f241c884a95bc3b5d20cadc67769e40d2fdaeb41b58733611f24d785c77fb43"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":266,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"code","lang":null,"md":"```\n1. POST /id/login/begin\n   ‚Üí Returns WebAuthn challenge\n2. navigator.credentials.get(challenge)\n   ‚Üí User authenticates with passkey\n3. POST /id/login/finish\n   ‚Üí Server verifies and creates session\n```","hash_alg":"sha256","hash":"110e6a6b8b300a3319a2d653ecd17aa9afcd93da1c3b62085d139b051ca0e1e8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":267,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"paragraph","md":"**Step-up (L4/L5):**","hash_alg":"sha256","hash":"efd0f3fa160b0fdc2c339938b239ec00106ff849e0d70a5806bdbf1ee2f1a8a8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":268,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","WebAuthn Passkey Authentication"],"block_kind":"code","lang":null,"md":"```\n1. POST /v1/id/stepup/begin\n   ‚Üí Returns WebAuthn challenge\n2. navigator.credentials.get(challenge)\n   ‚Üí User authenticates with passkey\n3. Include assertion in permit request\n4. UBL verifies step-up before issuing permit\n```","hash_alg":"sha256","hash":"183952f4e7e658ab7a705cf5c840e9c8cfce3f3984ad953bdf50e6055ff5cb74"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":269,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Agent Signing Certificates (ASC)"],"block_kind":"heading","level":3,"text":"Agent Signing Certificates (ASC)","md":"### Agent Signing Certificates (ASC)","hash_alg":"sha256","hash":"a4421f2ecd2376db43068f151902524bafccbb58f2b1fab6d01d6b9dbe4c37e9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":270,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Agent Signing Certificates (ASC)"],"block_kind":"paragraph","md":"**ASC Issuance:**","hash_alg":"sha256","hash":"5c61bfe68f77474d689771dece37fe78eb8cba93624c1cadaec8bf771daf37f8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":271,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Agent Signing Certificates (ASC)"],"block_kind":"code","lang":null,"md":"```\n1. POST /id/agents (create LLM/App agent)\n   ‚Üí Returns agent SID and Ed25519 keypair\n2. POST /id/agents/:sid/asc (issue ASC)\n   ‚Üí Returns Agent Signing Certificate\n3. Agent uses ASC to sign events\n```","hash_alg":"sha256","hash":"d718f94f559e0bb4b6068f8f978465c07c3202d8e7b8519355962262ff0c3dc8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":272,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Agent Signing Certificates (ASC)"],"block_kind":"paragraph","md":"**ASC Format:**","hash_alg":"sha256","hash":"4c6c1a5437ecd35aad9a1b1443f56a7d44929887882fbe553954c403863a970b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":273,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Agent Signing Certificates (ASC)"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"sid\": \"agent_sofia\",\n  \"public_key\": \"ed25519:abc...\",\n  \"issued_by\": \"user_joao\",\n  \"issued_at\": 1234567890,\n  \"expires_at\": 1234567890,\n  \"signature\": \"ed25519:def...\"\n}\n```","hash_alg":"sha256","hash":"b557fb3c2438715cb344911ffc8f3df3a580ef28fffaf8aa1df1867176a18faa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":274,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"heading","level":3,"text":"Policy Pack v1","md":"### Policy Pack v1","hash_alg":"sha256","hash":"724bc1b6418a84ed9946f75b00fe93fe06b9c117b9b560266db7ab477f4ee6eb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":275,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"paragraph","md":"**Policy Manifest:**","hash_alg":"sha256","hash":"526b44f6ac61bc99af7be92687a356705a0bf4b2b7b12d2f19e411ee6ca451d7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":276,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"version\": \"1.0\",\n  \"policies\": [\n    {\n      \"id\": \"job_fsm_validation\",\n      \"rule\": \"Job state transitions must follow FSM\",\n      \"enforcement\": \"before_commit\"\n    },\n    {\n      \"id\": \"card_provenance\",\n      \"rule\": \"Job cards must be generated by Office\",\n      \"enforcement\": \"before_commit\"\n    },\n    {\n      \"id\": \"pii_detection\",\n      \"rule\": \"Tool calls must comply with PII rules\",\n      \"enforcement\": \"before_commit\"\n    }\n  ]\n}\n```","hash_alg":"sha256","hash":"9ffdcabaa954f970a244908cb000243824a405d3e2f4237cd13a22c79e6a8497"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":277,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"paragraph","md":"**Evaluation:**","hash_alg":"sha256","hash":"96b55ace3aebc7dcac4eee045b50e22739711c8744d338f4ed21086ef9539d7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":278,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"list","md":"- Policies are evaluated **before** event commit\n- Violations result in commit rejection\n- Policy hash is recorded in ledger entry\n- Policies can be updated (versioned)","hash_alg":"sha256","hash":"7fa23fc20c3aa89678c0f5059b07128468aecf31eac18259deb82c2fd21966b1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":279,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Governance","Policy Pack v1"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":280,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns"],"block_kind":"heading","level":2,"text":"Integration Patterns","md":"## Integration Patterns","hash_alg":"sha256","hash":"349521550dfd6d4cf2be4fc0f803fad7f35525d6043f13a88f666b491c685826"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":281,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Message Flow"],"block_kind":"heading","level":3,"text":"Message Flow","md":"### Message Flow","hash_alg":"sha256","hash":"154c1ebef81aeaea3089565b5f4c29ed0ff8adb9c87a6342f4ca0bee27c6e513"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":282,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Message Flow"],"block_kind":"paragraph","md":"**User sends message:**","hash_alg":"sha256","hash":"302db32433d6c2ba8fd51eb88f83e2ba978f8246d3c119208c59675690634885"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":283,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Message Flow"],"block_kind":"code","lang":null,"md":"```\nMessenger Frontend\n  ‚Üí POST /v1/conversations/:id/messages\n    ‚Üí Gateway\n      ‚Üí Commits message.created to UBL (C.Messenger)\n      ‚Üí Calls POST /v1/office/ingest_message\n        ‚Üí Office\n          ‚Üí Analyzes message\n          ‚Üí Decides: reply or propose job\n          ‚Üí If job: Commits job.created to UBL (C.Jobs)\n          ‚Üí Generates FormalizeCard\n          ‚Üí Commits card to UBL (C.Messenger)\n      ‚Üí Stores idempotency record\n      ‚Üí Emits SSE delta\n    ‚Üí Frontend receives update\n    ‚Üí Job card appears in conversation\n```","hash_alg":"sha256","hash":"04dd26c070f43598b3552d2f4f6d90b058c80fb5ff44c3c17a3ac380dc6b73c0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":284,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Approval Flow"],"block_kind":"heading","level":3,"text":"Job Approval Flow","md":"### Job Approval Flow","hash_alg":"sha256","hash":"7bcddb5459eeef8ea34fbaca4f14e14bf9549ddfd8ac618d8a6c9aa7f4ec2e45"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":285,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Approval Flow"],"block_kind":"paragraph","md":"**User approves job:**","hash_alg":"sha256","hash":"a11476173cd0e70b901f4bd5ed74a83c3bf88be765ea72e334d79ebb35408701"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":286,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Approval Flow"],"block_kind":"code","lang":null,"md":"```\nMessenger Frontend\n  ‚Üí POST /v1/jobs/:id/actions { action: \"job.approve\" }\n    ‚Üí Gateway\n      ‚Üí Validates card provenance\n      ‚Üí Calls POST /v1/office/job_action\n        ‚Üí Office\n          ‚Üí Validates FSM transition (Proposed ‚Üí Approved)\n          ‚Üí Requests permit from UBL\n          ‚Üí Commits job.state_changed to UBL\n          ‚Üí Begins job execution\n          ‚Üí Commits job.started to UBL\n      ‚Üí Stores idempotency record\n      ‚Üí Emits SSE delta\n    ‚Üí Frontend receives update\n    ‚Üí Job card updates to TrackingCard\n```","hash_alg":"sha256","hash":"73db57304c386f436be32318c39f488eb3b1aa7023991a95c838c78dda6bad34"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":287,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Execution Flow"],"block_kind":"heading","level":3,"text":"Job Execution Flow","md":"### Job Execution Flow","hash_alg":"sha256","hash":"e58bbdbf7a6d66534e8e3aa5affd2e8d15350ce40be1da50c458fbdab656c4af"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":288,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Execution Flow"],"block_kind":"paragraph","md":"**Office executes job:**","hash_alg":"sha256","hash":"de87b2f69d7b07e41b1ddb8526b1638c3df2db2cc243a3fe989c0c6232dc6499"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":289,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Job Execution Flow"],"block_kind":"code","lang":null,"md":"```\nOffice\n  ‚Üí Builds context frame\n  ‚Üí Generates narrative\n  ‚Üí Calls LLM with narrative\n  ‚Üí LLM responds with tool calls\n  ‚Üí Office executes tools (with audit)\n  ‚Üí Commits audit.tool_called to UBL\n  ‚Üí Commits audit.tool_result to UBL\n  ‚Üí Streams progress updates\n  ‚Üí Commits job.progress to UBL\n  ‚Üí If approval needed: Commits approval.requested to UBL\n  ‚Üí On completion: Commits job.completed to UBL\n  ‚Üí Generates FinishedCard\n  ‚Üí Commits card to UBL\n  ‚Üí Emits SSE deltas\n```","hash_alg":"sha256","hash":"e6e92b9f313d1dc6e7f3efff601be101b1c812f2624263e43f6d4b00e2d79ddb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":290,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"heading","level":3,"text":"Real-time Updates","md":"### Real-time Updates","hash_alg":"sha256","hash":"3ff6ba2190c52441ba31b9393491c5d474141624901e54835f41daca88ba6288"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":291,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"paragraph","md":"**SSE Delta Stream:**","hash_alg":"sha256","hash":"ccf958d9da831aec3090b79e5b85982c74108eca0bb8b71280c8d2f11207f4da"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":292,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"code","lang":null,"md":"```\nUBL Kernel\n  ‚Üí Event committed to ledger\n  ‚Üí Projection updater processes event\n  ‚Üí Projection table updated\n  ‚Üí PostgreSQL NOTIFY fired\n  ‚Üí SSE handler emits delta event\n    ‚Üí Frontend receives event\n    ‚Üí UI updates automatically\n```","hash_alg":"sha256","hash":"fa384c5f6131103418f9c68770dfb9241f3a8ce883bcd86c687c7025e44f7da5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":293,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"paragraph","md":"**Delta Event Types:**","hash_alg":"sha256","hash":"328958952f0762b3c040cb228250076ac92e8f4604d4e14439d43c74f7963501"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":294,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"list","md":"- `timeline.append` - New message or job card\n- `timeline.update` - Message or job updated\n- `job.update` - Job state changed\n- `presence.update` - Entity presence changed\n- `conversation.update` - Conversation metadata changed","hash_alg":"sha256","hash":"99b18c78537ee56f6260ce52e9128380d06580d3edd994d6cb6fcf6889a48d75"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":295,"path":["Three Systems Overview: UBL, Office, and Messenger","Integration Patterns","Real-time Updates"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":296,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures"],"block_kind":"heading","level":2,"text":"Data Structures","md":"## Data Structures","hash_alg":"sha256","hash":"64804f62fb883896b16d7b334c3f11cf91239117e5785a0f4a6d3be82545ed56"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":297,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Message Event"],"block_kind":"heading","level":3,"text":"Message Event","md":"### Message Event","hash_alg":"sha256","hash":"d85e3165f637f637fe5bdb55cf425264cd546b065734bd82886cda1a7b68cc73"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":298,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Message Event"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"type\": \"message.created\",\n  \"id\": \"msg_2024_001\",\n  \"conversation_id\": \"conv_123\",\n  \"from\": \"user_joao\",\n  \"content_hash\": \"a1b2c3d4...\",\n  \"message_type\": \"text\",\n  \"created_at\": \"2024-12-28T10:00:00Z\"\n}\n```","hash_alg":"sha256","hash":"3f555845c755f2591d4a34dd172293efa3c2be34b2ffa6b68f1b1ec3ccf6ada2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":299,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Job Event"],"block_kind":"heading","level":3,"text":"Job Event","md":"### Job Event","hash_alg":"sha256","hash":"3ecb0f102ffb4b8fa973b9ed458f2d0dc9d399138e1fb3f28b4f14c488f0d43e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":300,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Job Event"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"type\": \"job.created\",\n  \"id\": \"job_2024_001\",\n  \"conversation_id\": \"conv_123\",\n  \"title\": \"Create Proposal - Client ABC\",\n  \"description\": \"Create proposal for client ABC\",\n  \"created_by\": \"user_joao\",\n  \"assigned_to\": \"agent_sofia\",\n  \"priority\": \"normal\",\n  \"estimated_duration_seconds\": 300,\n  \"created_at\": \"2024-12-28T10:00:00Z\"\n}\n```","hash_alg":"sha256","hash":"4e5a7f9bf82450097c205749f081ac6aee1e3608a79f585b7818430f42d97c33"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":301,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Job Card"],"block_kind":"heading","level":3,"text":"Job Card","md":"### Job Card","hash_alg":"sha256","hash":"2cf8d808cbc3bd1c3a76ce1782d406e8a2c5559f8dab5dd644229a1c7de8086f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":302,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Job Card"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"card_type\": \"job.formalize\",\n  \"card_id\": \"card_2024_001\",\n  \"job_id\": \"job_2024_001\",\n  \"version\": \"1.0\",\n  \"title\": \"Create Proposal - Client ABC\",\n  \"summary\": \"Create proposal for client ABC\",\n  \"state\": \"proposed\",\n  \"created_at\": \"2024-12-28T10:00:00Z\",\n  \"conversation_id\": \"conv_123\",\n  \"tenant_id\": \"T.UBL\",\n  \"owner\": {\n    \"entity_id\": \"agent_sofia\",\n    \"display_name\": \"Sofia\",\n    \"actor_type\": \"agent\"\n  },\n  \"author\": {\n    \"entity_id\": \"agent_sofia\",\n    \"display_name\": \"Sofia\",\n    \"actor_type\": \"agent\"\n  },\n  \"buttons\": [\n    {\n      \"button_id\": \"approve_btn\",\n      \"label\": \"Approve\",\n      \"action\": {\n        \"type\": \"job.approve\",\n        \"job_id\": \"job_2024_001\"\n      },\n      \"style\": \"primary\",\n      \"requires_input\": false\n    },\n    {\n      \"button_id\": \"reject_btn\",\n      \"label\": \"Reject\",\n      \"action\": {\n        \"type\": \"job.reject\",\n        \"job_id\": \"job_2024_001\"\n      },\n      \"style\": \"danger\",\n      \"requires_input\": false\n    }\n  ]\n}\n```","hash_alg":"sha256","hash":"b389fcb1c8b8721a6c7349647d05de311403b5ef00d94d509a6a97081bd20807"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":303,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Context Frame"],"block_kind":"heading","level":3,"text":"Context Frame","md":"### Context Frame","hash_alg":"sha256","hash":"8b1a75a89c1be9dd10d79ed03761ec7508002db59f3b27216682cfe3ae923fdf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":304,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Context Frame"],"block_kind":"code","lang":"rust","md":"```rust\npub struct ContextFrame {\n    pub entity_id: String,\n    pub entity_name: String,\n    pub session_type: SessionType,\n    pub token_budget: u64,\n    pub memory: Memory,\n    pub obligations: Vec<Obligation>,\n    pub affordances: Vec<Affordance>,\n    pub constitution: Constitution,\n    pub previous_handover: Option<String>,\n    pub governance_notes: Vec<String>,\n    pub guardian_info: Option<GuardianInfo>,\n    pub ledger_sequence: u64,\n    pub frame_hash: String,\n}\n```","hash_alg":"sha256","hash":"3b4533e410b31159d11b92134dff3eb9b288eeeef3e638593b261749abe4108c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":305,"path":["Three Systems Overview: UBL, Office, and Messenger","Data Structures","Context Frame"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":306,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations"],"block_kind":"heading","level":2,"text":"Performance Considerations","md":"## Performance Considerations","hash_alg":"sha256","hash":"5cc00b93875cc70bdf6cf80b59eed69a4e7e4c956a9e37481378ddf92bb438ab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":307,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","Projection Updates"],"block_kind":"heading","level":3,"text":"Projection Updates","md":"### Projection Updates","hash_alg":"sha256","hash":"0a764ceaeeddec2d9487ce8fb7b4535c70b9901d5943822be672d7df3ea518ef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":308,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","Projection Updates"],"block_kind":"list","md":"- **Batch Processing**: Multiple events processed in single transaction\n- **Incremental Updates**: Only changed rows updated\n- **Indexes**: Optimized indexes on frequently queried columns\n- **Materialized Views**: For complex aggregations","hash_alg":"sha256","hash":"c035dfb077ad23c37f6955dfc0608cf893ad719bae48c58096a766aa0dac8b0c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":309,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","SSE Streaming"],"block_kind":"heading","level":3,"text":"SSE Streaming","md":"### SSE Streaming","hash_alg":"sha256","hash":"bcac3286b895081425870a9f31a97a6017ea83c2c03131b97585990759ec0e4b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":310,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","SSE Streaming"],"block_kind":"list","md":"- **Connection Pooling**: Reuse connections for multiple clients\n- **Event Batching**: Batch multiple events in single SSE message\n- **Backpressure**: Client can signal when overwhelmed\n- **Reconnection**: Automatic reconnection with exponential backoff","hash_alg":"sha256","hash":"ee499aeb07d3aad8e94fd40f5f3ba5949bfc92598b703ee1e26b90ad0dfef024"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":311,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","LLM Calls"],"block_kind":"heading","level":3,"text":"LLM Calls","md":"### LLM Calls","hash_alg":"sha256","hash":"b16649436b9003f247911c679e0198a288d708da03539def68443f36e4dc92df"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":312,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","LLM Calls"],"block_kind":"list","md":"- **Token Budget**: Enforced per session type\n- **Streaming**: Progress updates streamed to frontend\n- **Caching**: Context frames cached when possible\n- **Rate Limiting**: LLM provider rate limits respected","hash_alg":"sha256","hash":"b50aa6a9ac629ab01a9b40e004028c258a7b9e55d300e17681b32ecb55f88663"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":313,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Considerations","LLM Calls"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":314,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy"],"block_kind":"heading","level":2,"text":"Testing Strategy","md":"## Testing Strategy","hash_alg":"sha256","hash":"7b7415c92b9b5e258c3c450b29e73fb249afd14dd2922f0fc6c54dc150686954"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":315,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Unit Tests"],"block_kind":"heading","level":3,"text":"Unit Tests","md":"### Unit Tests","hash_alg":"sha256","hash":"45bca583f26a9445a42f21a8b789cb7bc2d40d3cf99c9764d3542d1a643969b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":316,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Unit Tests"],"block_kind":"list","md":"- **UBL Kernel**: Ledger append, event validation, projections\n- **Office**: FSM transitions, context building, narrative generation\n- **Messenger**: Component rendering, state management, API calls","hash_alg":"sha256","hash":"0e2617b85b6ec59b36c737d37a8def5b39b3d34285be420ce3cdb61ba2f9154f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":317,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Integration Tests"],"block_kind":"heading","level":3,"text":"Integration Tests","md":"### Integration Tests","hash_alg":"sha256","hash":"f3c491e59750b20b1254f9b081dcfdf9ca1d1b6803661d28d3ffe49205c9e5ef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":318,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Integration Tests"],"block_kind":"list","md":"- **End-to-end flows**: Message ‚Üí Job ‚Üí Approval ‚Üí Execution\n- **SSE streaming**: Real-time update delivery\n- **Permit flow**: Permit request ‚Üí validation ‚Üí execution\n- **Projection updates**: Event ‚Üí projection ‚Üí query","hash_alg":"sha256","hash":"01305e4c92915dff750a07c949cd4b63f0acd7542b15ad05fca490ebb569d9ce"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":319,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Performance Tests"],"block_kind":"heading","level":3,"text":"Performance Tests","md":"### Performance Tests","hash_alg":"sha256","hash":"c4361aa42064f0cac30e8bdebc2ea09646a4ecef0205a283fc95283e90e23a41"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":320,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Performance Tests"],"block_kind":"list","md":"- **Ledger append**: Throughput under load\n- **Projection updates**: Latency measurements\n- **SSE streaming**: Concurrent client handling\n- **LLM calls**: Token budget enforcement","hash_alg":"sha256","hash":"5a00ec02fe1631c544e2e5f0dab6f316d54776bcbcdda9e3e1f78c682c85d992"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":321,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing Strategy","Performance Tests"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":322,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment"],"block_kind":"heading","level":2,"text":"Deployment","md":"## Deployment","hash_alg":"sha256","hash":"a147233b0bc665fa439e7bbdbfa4417abbaaa325b4361ba26ea4e748640c4b8c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":323,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","UBL Kernel"],"block_kind":"heading","level":3,"text":"UBL Kernel","md":"### UBL Kernel","hash_alg":"sha256","hash":"f7d27856ff2830e6b60b75bb927b9229337e7146a36d574cb61918ba9c29cdc7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":324,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","UBL Kernel"],"block_kind":"code","lang":"bash","md":"```bash\n# Build\ncd ubl/kernel/rust\ncargo build --release\n\n# Run\nDATABASE_URL=postgres://... ./target/release/ubl-server\n```","hash_alg":"sha256","hash":"990e6f2e6882877781452ac69671c192c2c9b417e6a9bce1f6a9200b5f9c0132"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":325,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Office"],"block_kind":"heading","level":3,"text":"Office","md":"### Office","hash_alg":"sha256","hash":"c5e36846d05dac930dbaab98a74fb2ea13ef7283b24d24aef3fdfe62f3ea8686"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":326,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Office"],"block_kind":"code","lang":"bash","md":"```bash\n# Build\ncd apps/office\ncargo build --release\n\n# Run\nOFFICE__LLM__API_KEY=... cargo run --release\n```","hash_alg":"sha256","hash":"67d8121dded8073c4b7dfd8e35ba5c803f885604d9cf51a219c654e00451faca"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":327,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Messenger Frontend"],"block_kind":"heading","level":3,"text":"Messenger Frontend","md":"### Messenger Frontend","hash_alg":"sha256","hash":"8d20190aa2de0fd15a60b1399238140941f844af2865eb6b9ba2b2674eae16d5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":328,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Messenger Frontend"],"block_kind":"code","lang":"bash","md":"```bash\n# Build\ncd apps/messenger/frontend\nnpm install\nnpm run build\n\n# Serve\nnpm run preview\n```","hash_alg":"sha256","hash":"a7125cf64e5aa36b00cc8a759d9565fd64d7139294a489a4396114cbb3f348bc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":329,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Docker Compose"],"block_kind":"heading","level":3,"text":"Docker Compose","md":"### Docker Compose","hash_alg":"sha256","hash":"987791972377fdaaf8d4d3faa1f1938314935ab469315601bdd2149d998c6806"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":330,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Docker Compose"],"block_kind":"code","lang":"yaml","md":"```yaml\nversion: '3.8'\n\nservices:\n  postgres:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_DB: ubl_ledger\n      POSTGRES_USER: ubl_dev\n      POSTGRES_PASSWORD: dev_password\n    ports:\n      - \"5432:5432\"\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U ubl_dev\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  ubl-kernel:\n    build: ./ubl/kernel/rust\n    ports:\n      - \"8080:8080\"\n    environment:\n      DATABASE_URL: postgres://ubl_dev:dev_password@postgres:5432/ubl_ledger\n      PORT: 8080\n      WEBAUTHN_RP_ID: localhost\n      WEBAUTHN_ORIGIN: http://localhost:8080\n    depends_on:\n      postgres:\n        condition: service_healthy\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8080/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n  \n  office:\n    build: ./apps/office\n    ports:\n      - \"8081:8081\"\n    environment:\n      OFFICE__LLM__API_KEY: ${ANTHROPIC_API_KEY}\n      OFFICE__LLM__PROVIDER: anthropic\n      OFFICE__UBL__ENDPOINT: http://ubl-kernel:8080\n      OFFICE__UBL__CONTAINER_ID: C.Office\n      OFFICE__SERVER__HOST: 0.0.0.0\n      OFFICE__SERVER__PORT: 8081\n    depends_on:\n      - ubl-kernel\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8081/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n  \n  messenger-frontend:\n    build: ./apps/messenger/frontend\n    ports:\n      - \"3000:3000\"\n    environment:\n      VITE_API_BASE_URL: http://localhost:8080\n      VITE_OFFICE_URL: http://localhost:8081\n    depends_on:\n      - ubl-kernel\n      - office\n\nvolumes:\n  postgres_data:\n```","hash_alg":"sha256","hash":"6f95e5ae58c2045f7c41e31f2b87bc36d9544ced7482862c0f7a046e4d08fe08"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":331,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment","Docker Compose"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":332,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements"],"block_kind":"heading","level":2,"text":"Future Enhancements","md":"## Future Enhancements","hash_alg":"sha256","hash":"c6b01dab3a8c817ca9bb286b5a43a9986f99777e4e682b4f6a3abc5522c06f58"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":333,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements","Planned Features"],"block_kind":"heading","level":4,"text":"Planned Features","md":"#### Planned Features","hash_alg":"sha256","hash":"7bd86c158d53cae959f7fd9a4b00d50b21dca8d6979b40f34a95371a3d37015f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":334,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements","Planned Features"],"block_kind":"list","md":"1. **Multi-tenancy**: Tenant isolation in UBL with separate containers per tenant\n2. **Federation**: Cross-tenant communication via signed events\n3. **Advanced Governance**: Custom policy packs per tenant/organization\n4. **Analytics**: Usage metrics and insights dashboard\n5. **Mobile Apps**: Native iOS/Android clients with WebAuthn support\n6. **Voice Interface**: Voice input/output for hands-free interaction\n7. **Video Calls**: Integrated video conferencing for real-time collaboration\n8. **File Sharing**: Enhanced file management with versioning\n9. **Search**: Full-text search across conversations and jobs\n10. **Export**: Data export and backup functionality\n11. **Templates**: Job templates for common workflows\n12. **Workflows**: Multi-step job orchestration","hash_alg":"sha256","hash":"33d90c2aed392d5f6c785031b981eac8d31f614b6a09aafc0297956642ad2f1b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":335,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements","Technical Debt"],"block_kind":"heading","level":4,"text":"Technical Debt","md":"#### Technical Debt","hash_alg":"sha256","hash":"e317f6deab2129ff36e9536bca6fa57ae1ff9b0ea9f75104cc80d90c9d271022"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":336,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements","Technical Debt"],"block_kind":"list","md":"1. **WebSocket Migration**: Migrate from SSE to WebSocket for bidirectional communication\n2. **GraphQL API**: Add GraphQL layer for flexible queries\n3. **Caching Layer**: Redis cache for frequently accessed data (idempotency, projections)\n4. **Message Queue**: RabbitMQ/Kafka for async processing of heavy operations\n5. **Monitoring**: Prometheus metrics and Grafana dashboards\n6. **Logging**: Structured logging with ELK stack (Elasticsearch, Logstash, Kibana)\n7. **Testing**: Increase test coverage (currently ~60%, target 80%+)\n8. **Documentation**: API documentation with OpenAPI/Swagger\n9. **Rate Limiting**: Per-entity and per-tenant rate limits\n10. **Backup/Recovery**: Automated backup and point-in-time recovery","hash_alg":"sha256","hash":"b8a95200515e61cb0686a0e54cca2250b7ff477ef79468f2fef71891b10cf5ad"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":337,"path":["Three Systems Overview: UBL, Office, and Messenger","Future Enhancements","Technical Debt"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":338,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"heading","level":2,"text":"Conclusion","md":"## Conclusion","hash_alg":"sha256","hash":"be031d37bb75d96ef08ca9ec5b0e83bb6f91172f60d3c31a78feae8d7dc4a0b0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":339,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"The three systems (UBL, Office, Messenger) work together to create a **verifiable, auditable, and AI-safe** messaging and job execution platform. Each system has clear responsibilities and boundaries, communicating via well-defined APIs and event streams.","hash_alg":"sha256","hash":"a2325882b75aae57fed28b71c700b8a77f4caa62c6c5d69793a19050817ce2e8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":340,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"**Key Strengths:**","hash_alg":"sha256","hash":"c548cb0ed0608138792c9e36974a74eee599457df1153b17f8581c28acfa98cd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":341,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"list","md":"- **Immutability**: All state changes are auditable events\n- **Sovereignty**: UBL is the single source of truth\n- **Governance**: Policy Pack enforces rules before commits\n- **Real-time**: SSE streaming for live updates\n- **Security**: WebAuthn, ASC, permits, pacts\n- **Dignity**: LLM entities have persistent identity","hash_alg":"sha256","hash":"8212e7ddf0aaecd17447b1e130564a093e6f8851e3270291f6b76e6682298f97"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":342,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"**Architecture Principles:**","hash_alg":"sha256","hash":"9255d967230c4f13a0cfe4f3c2af2ed7887d4a07048049308ef03e7086c4d28f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":343,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"list","md":"1. **Event Sourcing**: State derived from immutable events\n2. **Container Pattern**: Logical organization of events\n3. **Trust Architecture**: Risk-based permissions\n4. **Projections**: Efficient read-only views\n5. **Real-time Updates**: SSE for live synchronization","hash_alg":"sha256","hash":"c2d12f99d030670970fbcb62baf24c92984dac9f4a3836361727e6449f110c49"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":344,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"The system is production-ready and can be extended with additional features while maintaining the core architectural principles.","hash_alg":"sha256","hash":"5f48c92732eb069bd73706612d6131d3ff4b2a9cd0eb4ddbf3feae0cc3ce83c5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":345,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":346,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details"],"block_kind":"heading","level":2,"text":"Advanced Implementation Details","md":"## Advanced Implementation Details","hash_alg":"sha256","hash":"58ca8cc0813a14510c0ebb7d38a82e52931c1628bb2b7ce68e279b295db737a4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":347,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture"],"block_kind":"heading","level":3,"text":"SSE Streaming Architecture","md":"### SSE Streaming Architecture","hash_alg":"sha256","hash":"23c817613430323bf57196fe72fda8304bc2902a0656bde54362c44aec4c20c9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":348,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"heading","level":4,"text":"UBL Kernel SSE Tail","md":"#### UBL Kernel SSE Tail","hash_alg":"sha256","hash":"ccec9abb05bcef4f46d27ff01eb03deb7c68cb5418bca8993d29156390a96dc8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":349,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"paragraph","md":"The UBL Kernel provides a **PostgreSQL LISTEN/NOTIFY** based SSE stream:","hash_alg":"sha256","hash":"b9adc0e8bb7bdf18a6becae31fdfa420f506887b86b0bc219f1901d20ea43bf8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":350,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"paragraph","md":"**Implementation:**","hash_alg":"sha256","hash":"dd46077c017dbb7d28d8e60209e7ed7520a10d82804555979c3cde289e2d138b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":351,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"code","lang":"rust","md":"```rust\n// From sse.rs\n1. Client connects to GET /ledger/:container_id/tail\n2. If Last-Event-ID provided, replay missed events (up to 1000)\n3. Spawn task to LISTEN on PostgreSQL channel \"ledger_events\"\n4. On NOTIFY, parse lightweight reference {container_id, sequence, entry_hash}\n5. Fetch full entry from database\n6. Emit SSE event with sequence as ID (for reconnection)\n7. Keep-alive pings every 15 seconds\n```","hash_alg":"sha256","hash":"b9a9ec65798e188a24ab85edd800e1cddf8bd70be842a85711d302134f65b00a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":352,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"paragraph","md":"**Key Features:**","hash_alg":"sha256","hash":"111cbfe9683e841216b45e1c44c58084dc2140d41639686780d424a2602a2a10"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":353,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"list","md":"- **Reconnection Support**: Last-Event-ID header for resuming from missed events\n- **Lightweight NOTIFY**: Only sends reference (avoids 8KB PostgreSQL limit)\n- **Full Payload Fetch**: SSE handler fetches complete entry on-demand\n- **Container Filtering**: Only emits events for requested container\n- **Keep-Alive**: Prevents connection timeout","hash_alg":"sha256","hash":"d759a4a425daca7321fc16ea9ef4c57ac60d6f82f409e234ceb61c34d461435d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":354,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"paragraph","md":"**Event Format:**","hash_alg":"sha256","hash":"4a2ac85e1c1df2a092a32636a5e8571b9f408005323bd54064043217f65b0b96"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":355,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","UBL Kernel SSE Tail"],"block_kind":"code","lang":null,"md":"```\nevent: ledger_entry\nid: 1234\ndata: {\"container_id\":\"C.Messenger\",\"sequence\":1234,\"entry_hash\":\"abc...\",\"atom\":{...}}\n```","hash_alg":"sha256","hash":"84bdccb32b866a57d730678a1ae3b673bb05a528b4a69f829841ab547e429631"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":356,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"heading","level":4,"text":"Gateway SSE Delta Stream","md":"#### Gateway SSE Delta Stream","hash_alg":"sha256","hash":"35f3c24d3ad648e519949ac043b76496b0bf21c378307c27853d3668f905c6bc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":357,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"paragraph","md":"The Gateway provides a **higher-level delta stream** for frontend:","hash_alg":"sha256","hash":"ff9437f69e51b0bda0d10ccb35a539548b1c28960f164b41ba3e242d3859a539"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":358,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"paragraph","md":"**Event Types:**","hash_alg":"sha256","hash":"705acdc98bde4591f41bdd76242b8629879240e2a3757d5cc88416116c586b8d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":359,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"list","md":"- `hello` - Connection established, includes cursor\n- `timeline.append` - New message or job card added\n- `job.update` - Job state changed\n- `presence.update` - Entity presence changed\n- `conversation.update` - Conversation metadata changed\n- `heartbeat` - Keep-alive ping\n- `error` - Error occurred","hash_alg":"sha256","hash":"53d8cda5e3490f6fa56535dff6e29466a0f5957fbd9360fe8676cfcb3438d689"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":360,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"paragraph","md":"**Implementation:**","hash_alg":"sha256","hash":"dd46077c017dbb7d28d8e60209e7ed7520a10d82804555979c3cde289e2d138b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":361,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"code","lang":"rust","md":"```rust\n// From messenger_gateway/sse.rs\n1. Client connects to GET /v1/stream?tenant_id=T.UBL&cursor=123:456\n2. Gateway creates GatewaySSE instance with mpsc channel\n3. Projection updaters emit DeltaEvent to channel\n4. SSE handler converts to Event and streams to client\n5. Cursor format: \"sequence:timestamp\" for pagination\n```","hash_alg":"sha256","hash":"2904334796bacc1fcf94cd77c3d3aee7c88b975b7b6a64646fe5e6770629bf53"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":362,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"paragraph","md":"**Delta Event Format:**","hash_alg":"sha256","hash":"cabb09c4d710194cf5676f915b21d618f7cc73ee03dbf1199410e418daabbf2c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":363,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","SSE Streaming Architecture","Gateway SSE Delta Stream"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"type\": \"timeline.append\",\n  \"conversation_id\": \"conv_123\",\n  \"item\": {\n    \"cursor\": \"1234:1703123456789\",\n    \"item_type\": \"message\",\n    \"item_data\": {...}\n  }\n}\n```","hash_alg":"sha256","hash":"cfa7e9fc44152a0511042382f3a143bbcc23b39878bc8a6372cfe93881ada352"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":364,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"heading","level":3,"text":"Idempotency System","md":"### Idempotency System","hash_alg":"sha256","hash":"c59f4363cd6f2d4eaadf13e7b563b220dcb6b866838ee2f7b62a932b5a8489b7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":365,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"paragraph","md":"**Purpose**: Prevents duplicate message/job submissions from network retries","hash_alg":"sha256","hash":"bdbb6b328377a5929766e24f356aa6a8534157b9ef5cf4d3f8b4684da8d8469d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":366,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"paragraph","md":"**Key Format:**","hash_alg":"sha256","hash":"72873f0aa6ef86241e9546eb2939a13d3a34172d2102c3815194a1598050733d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":367,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"code","lang":null,"md":"```\nidem:{tenant_id}:{action_type}:{resource_id}:{nonce}\n```","hash_alg":"sha256","hash":"6f73af0eadd665a2ac6347456f6e2963a1d9bc24b3b27a81d82228574872736e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":368,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"paragraph","md":"**Implementation:**","hash_alg":"sha256","hash":"dd46077c017dbb7d28d8e60209e7ed7520a10d82804555979c3cde289e2d138b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":369,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"code","lang":"rust","md":"```rust\n// From messenger_gateway/idempotency.rs\n1. Client sends idempotency key in header (Idempotency-Key)\n2. Gateway checks store for existing record\n3. If found and status=\"completed\", return cached response\n4. If found and status=\"pending\", return 409 Conflict\n5. If not found, create record with status=\"pending\"\n6. Process request\n7. Update record with status=\"completed\" and response\n8. Store created event IDs for reference\n```","hash_alg":"sha256","hash":"4a51a72580b6cfd4328de5fa3275a4d8e642bf0a870683d5d0c3e6dd40dc3062"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":370,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"paragraph","md":"**Storage:**","hash_alg":"sha256","hash":"477298e71ffd6fa6594581aeccf045a792972dc1a5f2f543ac98b98a89f008a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":371,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"list","md":"- Currently in-memory (HashMap) - fast but not persistent\n- **Future**: Move to Redis for distributed systems and persistence\n- **Future**: Add TTL cleanup for old records\n- Records include: status, response_body, created_event_ids, created_at\n- **Note**: Idempotency keys should be unique per tenant+action+resource","hash_alg":"sha256","hash":"6f111528e16a72e121afa63f32dac5f6666da57d0c18c9a74d7a5de013807906"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":372,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"paragraph","md":"**Idempotency Record:**","hash_alg":"sha256","hash":"65432b2ae5e07d550b4e345d12612ce82e4017c95be1291894fa94e9f59dbeb7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":373,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Idempotency System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct IdempotencyRecord {\n    pub status: String, // \"pending\", \"completed\", \"failed\"\n    pub response_body: Option<serde_json::Value>,\n    pub created_event_ids: Vec<String>,\n    pub created_at: OffsetDateTime,\n}\n```","hash_alg":"sha256","hash":"62100b6081489e3c3fba59a4b85771a37fc42707d62951c0deabd046457fd363"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":374,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"heading","level":3,"text":"Office Client Integration","md":"### Office Client Integration","hash_alg":"sha256","hash":"26a2dae2d934859a8e16697aa40f258a07187173880c6555edde4b6b579a94c9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":375,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"paragraph","md":"**Purpose**: Gateway forwards messages and job actions to Office","hash_alg":"sha256","hash":"00bf80bcf3bff140f1397912f4345916334f07f6b6a2355ae61daa7f06a0c331"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":376,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"paragraph","md":"**Endpoints:**","hash_alg":"sha256","hash":"fa688de7773648f65a6e4f079477b8fc98165d79392be98d218cb74fad9089c4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":377,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"list","md":"- `POST /v1/office/ingest_message` - Gateway ‚Üí Office\n- `POST /v1/office/job_action` - Gateway ‚Üí Office","hash_alg":"sha256","hash":"0ecbedb8ba0122c44ab62057dc6e31d857fb7256e011fd24ad516c5b2f8415c8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":378,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"paragraph","md":"**Ingest Message Flow:**","hash_alg":"sha256","hash":"7107d2585e23c925e21608e2f67443a0c33d3dec07f17a7efb2a6a68ab4f01c6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":379,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"code","lang":"rust","md":"```rust\n// From messenger_gateway/office_client.rs\n1. Gateway receives message from frontend\n2. Gateway commits message.created to UBL\n3. Gateway calls Office.ingest_message\n4. Office analyzes message content\n5. Office decides: Reply, ProposeJob, or None\n6. If ProposeJob: Office creates job.created event\n7. Office returns response with action, reply_content, job_id, card\n8. Gateway stores idempotency record\n```","hash_alg":"sha256","hash":"e8a93b97caa10f40c64c5e59be740bc3e654489af337a2db2b9765a3521ebd6d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":380,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"paragraph","md":"**Job Action Flow:**","hash_alg":"sha256","hash":"40f640a2cf0fbebf0987f1a20cc5f1a6e29ecd54258499d97d1e0eb5be047920"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":381,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Office Client Integration"],"block_kind":"code","lang":"rust","md":"```rust\n1. Frontend sends job action (approve/reject/provide_input)\n2. Gateway validates card provenance\n3. Gateway calls Office.job_action\n4. Office validates FSM transition\n5. Office requests permit from UBL (if mutation)\n6. Office updates job state\n7. Office commits events to UBL\n8. Office returns success + updated_card\n9. Gateway stores idempotency record\n```","hash_alg":"sha256","hash":"e870583ed503ac2fe77e168a60e43ff0e9297eed3806a1ccd200541b4a342a5d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":382,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details"],"block_kind":"heading","level":3,"text":"Projection System Details","md":"### Projection System Details","hash_alg":"sha256","hash":"d6082c2fd7e4b7b7e7f4b553140590dfd5b931f6b1d07b178e6dd8e8874c5b7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":383,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"heading","level":4,"text":"Timeline Projection","md":"#### Timeline Projection","hash_alg":"sha256","hash":"cd511660bb1833a90c8830218c117366109c2dc2f67ad501db20ef56024e9d15"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":384,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"paragraph","md":"**Purpose**: Optimized unified timeline for conversations (messages + job cards)","hash_alg":"sha256","hash":"fdc8b30cae94b607a2f6fde5c13cdefced9622b65537223f5ec0a5a02f4c9d8a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":385,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"paragraph","md":"**Schema:**","hash_alg":"sha256","hash":"cdb7d52a0f650a6aa9a19cd26dfe3a0a94423df98135424d3b9cebbc9cbc8a3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":386,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"code","lang":"sql","md":"```sql\nprojection_timeline_items (\n  tenant_id TEXT,\n  conversation_id TEXT,\n  cursor TEXT, -- \"seq:timestamp\" format\n  item_type TEXT, -- \"message\", \"job_card\", \"system\"\n  item_data JSONB,\n  created_at TIMESTAMPTZ\n)\n```","hash_alg":"sha256","hash":"3fca8a895f8808268c4b7f1b61b765a72a0f76f5992d48a1ceb2d7b1a58e8396"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":387,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"paragraph","md":"**Cursor Format:**","hash_alg":"sha256","hash":"4f1e31d979e8013c7b377877fc94d5590a73096f61d6d59ff1b6eae007217cc5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":388,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"list","md":"- `{sequence}:{unix_timestamp}` - e.g., \"1234:1703123456789\"\n- Enables efficient pagination and ordering\n- Unique per conversation","hash_alg":"sha256","hash":"f9aa6c6d603ba3bf7f839a9efd4fd980387eda620ab477b8e1f2124b0bbc395f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":389,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"paragraph","md":"**Query Pattern:**","hash_alg":"sha256","hash":"c0f2053b8bdf9227bb4832f5d4ee947f32505f1c92950463aa1ec112bd69193e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":390,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Timeline Projection"],"block_kind":"code","lang":"sql","md":"```sql\n-- Get timeline with cursor pagination\nSELECT cursor, item_type, item_data, created_at\nFROM projection_timeline_items\nWHERE tenant_id = $1 AND conversation_id = $2\n  AND cursor > $3  -- cursor pagination\nORDER BY created_at ASC\nLIMIT $4\n```","hash_alg":"sha256","hash":"41df7e8df334460bc115e93b58fbe2d65dbd5cc6e5e7c67bdaed28d692eada71"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":391,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"heading","level":4,"text":"Presence Projection","md":"#### Presence Projection","hash_alg":"sha256","hash":"8f7b3cb50a6f3704a0e0120eeb6aa384c386f24e60788f5a0f4d9f29c4a59788"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":392,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"paragraph","md":"**Purpose**: Computed entity presence from job state + activity","hash_alg":"sha256","hash":"f5827315eff5342e6576c7d780f817be77ee1a589e8e27f3e957c10269c9b797"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":393,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"paragraph","md":"**Presence States:**","hash_alg":"sha256","hash":"bfa800cd04a33bd2525660b293461867e278a32110d04409dc97c7a0e1bb5f3a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":394,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"list","md":"- `offline` - No activity > TTL (humans: 30min, agents: 5min)\n- `available` - Default active state (recent activity, no active jobs)\n- `working` - Entity owns `in_progress` job + recent activity (< 5min ago)\n- `waiting_on_you` - Human entity ID in `waiting_on[]` array for `waiting_input` job\n- `away` - Activity > 15min ago but < TTL (humans only)\n- `busy` - Multiple active jobs or high activity (agents only)","hash_alg":"sha256","hash":"83cc52dddc21258a9279ac86d942bf46926274f6aae2b91e0499329ddcc145ce"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":395,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"paragraph","md":"**Presence Computation Priority:**","hash_alg":"sha256","hash":"3721433d6b93a24373caa38448f552bffe366256a9e9b22482e89b66225836c5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":396,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"list","md":"1. Check if entity has `waiting_input` job with entity in `waiting_on[]` ‚Üí `waiting_on_you`\n2. Check if entity owns `in_progress` job + recent activity ‚Üí `working`\n3. Check last activity timestamp ‚Üí `offline` if > TTL, else `available`","hash_alg":"sha256","hash":"307591183e6c5889c03b7b440a6a79d99d2dc711e906ddb663a37c4a3d54193b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":397,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"paragraph","md":"**Computation Rules:**","hash_alg":"sha256","hash":"8b54ca7f3e94b0014a90bdbaf020111cd0d579388e18fbbf1fd1c59d7f901c69"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":398,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"code","lang":"rust","md":"```rust\n// From projections/presence.rs\n1. On job.state_changed to \"in_progress\":\n   ‚Üí Set entity state to \"working\"\n\n2. On job.state_changed to \"waiting_input\":\n   ‚Üí Check if entity_id in waiting_on[]\n   ‚Üí If yes: Set to \"waiting_on_you\"\n   ‚Üí If no: Set to \"available\"\n\n3. On any activity (message, event):\n   ‚Üí Update last_seen_at\n\n4. Periodic check (every 5min):\n   ‚Üí If last_seen_at > TTL: Set to \"offline\"\n```","hash_alg":"sha256","hash":"ae494d4640c4e27c406c6aa123964e09e26b03785ec1cd9b9ecbfde98cfb40a0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":399,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"paragraph","md":"**Schema:**","hash_alg":"sha256","hash":"cdb7d52a0f650a6aa9a19cd26dfe3a0a94423df98135424d3b9cebbc9cbc8a3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":400,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Presence Projection"],"block_kind":"code","lang":"sql","md":"```sql\nprojection_presence (\n  tenant_id TEXT,\n  entity_id TEXT PRIMARY KEY,\n  state TEXT, -- offline, available, working, waiting_on_you\n  job_id TEXT, -- if working/waiting_on_you\n  since TIMESTAMPTZ, -- when state changed\n  last_seen_at TIMESTAMPTZ,\n  last_event_hash TEXT\n)\n```","hash_alg":"sha256","hash":"c9eddd40daa9fc14f6934b98f1798443b3bb9c63857080ffefbcccf3595f64e8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":401,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"heading","level":4,"text":"Job Events Projection","md":"#### Job Events Projection","hash_alg":"sha256","hash":"4650d05f394a2c00f497c3f70c25ac47b359b2580e0a87e32f11daa90b707a07"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":402,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"paragraph","md":"**Purpose**: Timeline items for job drawer UI","hash_alg":"sha256","hash":"37b7e1c4bec89bfcaa69676ac2dcc7de1d782b0c21f8bad1cbba72380b33f248"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":403,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"paragraph","md":"**Event Types Tracked:**","hash_alg":"sha256","hash":"ebbd692ba063b164312e901810be5812a50fd8768dd05099027c6fefeb06591a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":404,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"list","md":"- `job.created` - Job proposal created\n- `job.state_changed` - State transition\n- `tool.called` - Tool invocation\n- `tool.result` - Tool result\n- `approval.decided` - Approval decision","hash_alg":"sha256","hash":"7b6a4d04c693e0459e873df583b78bb576d80eecce9de3f2f14d9e8d116de0b2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":405,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"paragraph","md":"**Timeline Item Format:**","hash_alg":"sha256","hash":"425a3244f6cce62ff8f6824c0b711df81b0ec0dfee66e96508721e91b27c8d6a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":406,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"code","lang":"json","md":"```json\n{\n  \"type\": \"state_changed\",\n  \"from\": \"proposed\",\n  \"to\": \"approved\",\n  \"reason\": \"approved_by_user\",\n  \"timestamp\": \"2024-12-28T10:00:00Z\"\n}\n```","hash_alg":"sha256","hash":"7e72c1d8be628c5b542ad06cd2558f8721aa86482861e7d605701def0facb28f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":407,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"paragraph","md":"**Schema:**","hash_alg":"sha256","hash":"cdb7d52a0f650a6aa9a19cd26dfe3a0a94423df98135424d3b9cebbc9cbc8a3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":408,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Job Events Projection"],"block_kind":"code","lang":"sql","md":"```sql\nprojection_job_events (\n  tenant_id TEXT,\n  job_id TEXT,\n  cursor TEXT, -- \"seq:timestamp\"\n  ts TIMESTAMPTZ,\n  event_id TEXT,\n  event_type TEXT,\n  actor_entity_id TEXT,\n  timeline_item JSONB\n)\n```","hash_alg":"sha256","hash":"392bc5a60bed006e8102ff5753c77158a3d3ad91f3065e1594e7eb47c3a3062b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":409,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"heading","level":4,"text":"Artifacts Projection","md":"#### Artifacts Projection","hash_alg":"sha256","hash":"2e51ca3f2fab57dd2af5a3ee47a7d49980329d99e3a180f919e00e100e0afe87"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":410,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"paragraph","md":"**Purpose**: Tracks artifacts produced by jobs","hash_alg":"sha256","hash":"86678f3121abc2a03a59c84e1368e0b867ab08389456e71839097da7fc5354c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":411,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"paragraph","md":"**Artifact Kinds:**","hash_alg":"sha256","hash":"631ae0412bfad6dbe21e42cd1a6810499603c8974be4c5957647225ff38fc736"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":412,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"list","md":"- `file` - Generated file (with mime_type, size_bytes, url)\n- `link` - External link (with url, title)\n- `record` - Database record (with record_id, table_name)\n- `quote` - Quoted content (with source, text)","hash_alg":"sha256","hash":"f7f9c4982acc032a717a77cfd78532867facf62f17fb5e5b9bc3dc0a5d9604f3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":413,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"paragraph","md":"**Artifact Extraction:**","hash_alg":"sha256","hash":"14e90665f553516e52f4fa35ddf9c8bfa22cb3a04222d1f198c973745cf550b9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":414,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"list","md":"- Extracted from `tool.result` events\n- Looks for `payload.artifacts[]` array in event\n- Each artifact must have: `artifact_id`, `kind`, `title`\n- Optional fields: `url`, `mime_type`, `size_bytes`, `created_at`\n- Stored in `projection_job_artifacts` table\n- Queryable via `GET /v1/jobs/:id` endpoint","hash_alg":"sha256","hash":"b5eede47f84e8ade29b84586209abff500744fa57ac1b97453bb7740b9af4b3c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":415,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"paragraph","md":"**Extraction:**","hash_alg":"sha256","hash":"b1deadd074c6e1b5101099cf1d7503062d05e96126a1b8e029f23e490cfa9b60"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":416,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"list","md":"- From `tool.result` events\n- Extracts `payload.artifacts[]` array\n- Stores: artifact_id, kind, title, url, mime_type, size_bytes","hash_alg":"sha256","hash":"9bcee6e9d5f15f396a05d080e474a795eba1c1cb4d69996a01905cf5bbf9e6fd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":417,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"paragraph","md":"**Schema:**","hash_alg":"sha256","hash":"cdb7d52a0f650a6aa9a19cd26dfe3a0a94423df98135424d3b9cebbc9cbc8a3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":418,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Projection System Details","Artifacts Projection"],"block_kind":"code","lang":"sql","md":"```sql\nprojection_job_artifacts (\n  tenant_id TEXT,\n  job_id TEXT,\n  artifact_id TEXT,\n  kind TEXT,\n  title TEXT,\n  url TEXT,\n  mime_type TEXT,\n  size_bytes BIGINT,\n  event_id TEXT,\n  created_at TIMESTAMPTZ\n)\n```","hash_alg":"sha256","hash":"92f3c099821c61e435dedd0688ca6959f4c94b352958e45fcefe13d634dc3b9d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":419,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"heading","level":3,"text":"Session Management","md":"### Session Management","hash_alg":"sha256","hash":"7f81ccb7cb2a41bbbe5e00c0af00bcb2a87d23aa1e89d723cb223fa8eef12974"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":420,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"paragraph","md":"**Session Lifecycle:**","hash_alg":"sha256","hash":"43c9831044d683dbdfb76836fb67431f65a4eaccb681d9ee293581d0cca0c637"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":421,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"code","lang":null,"md":"```\nPending ‚Üí Active ‚Üí (Paused) ‚Üí Completed | Cancelled | Failed\n```","hash_alg":"sha256","hash":"302657bc2558e984179831db4da577ac702c8fe6de8503fff102afa480fb12d2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":422,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"paragraph","md":"**Session Types:**","hash_alg":"sha256","hash":"29b7aae02147b4ab4727cb2777521f807a9dfd47ddacdf2e1084f629bc4b3d3d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":423,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"list","md":"- **Work** - Autonomous work session (5000 tokens)\n- **Assist** - Helping human (4000 tokens)\n- **Deliberate** - Exploring options (8000 tokens)\n- **Research** - Gathering information (6000 tokens)","hash_alg":"sha256","hash":"9b878ae14c94db26b24b865d77fe41c5908d1166297781c35fced6184c25a8bc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":424,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"paragraph","md":"**Session Modes:**","hash_alg":"sha256","hash":"4a0e81aa59fda8496d3f4600abc5ac7ecd392846f9747a1c5003e323bd272378"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":425,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"list","md":"- **Commitment** - Actions are signed and binding\n- **Deliberation** - Actions are drafts, not binding","hash_alg":"sha256","hash":"65848fcea78b923a8fed41e9d2e6c63b61e31fe6e020b4e92958036bb014c480"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":426,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"paragraph","md":"**Session State:**","hash_alg":"sha256","hash":"799add110a0b22f51c18b3d4727a3f4be945fdd0805b84da71cbfe7b89ff8918"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":427,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"code","lang":"rust","md":"```rust\npub struct Session {\n    pub id: SessionId,\n    pub entity_id: EntityId,\n    pub current_instance_id: Option<InstanceId>,\n    pub session_type: SessionType,\n    pub session_mode: SessionMode,\n    pub status: SessionStatus,\n    pub tokens_consumed: u64,\n    pub token_budget: u64,\n    pub instance_count: u32,\n    pub message_count: u32,\n    pub handover: Option<Handover>,\n}\n```","hash_alg":"sha256","hash":"933c5d9333d225794c9404dd57535511d03aa65cd6e56f00a2d8d09fd495d837"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":428,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"paragraph","md":"**Token Budget Enforcement:**","hash_alg":"sha256","hash":"d688fdc14002c7dbd9acd009ca314abe6dc4bef97f560859773fbd41427642ad"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":429,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Session Management"],"block_kind":"list","md":"- Budget allocated by session type\n- `consume_tokens()` increments usage\n- `within_budget()` checks if can continue\n- `remaining_budget()` returns available tokens","hash_alg":"sha256","hash":"deafffc4786aa2381d25d6be513719ff0df794cc6ff7b871ced83ee6db6b4bd0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":430,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"heading","level":3,"text":"Handover System","md":"### Handover System","hash_alg":"sha256","hash":"3a6d0af60120bb9f9bb0751854555266f3413629d9720f3a11ccde9b933a8433"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":431,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"paragraph","md":"**Purpose**: Knowledge transfer between ephemeral LLM instances","hash_alg":"sha256","hash":"0e459c4a2fda0c3cea21c5c8ee9967536887eaab1cc73215395ffa72c4ba7f5a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":432,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"paragraph","md":"**Handover Structure:**","hash_alg":"sha256","hash":"58e8fe6da0a5ac223633e6d4e4d301d390819960e4abda5c42f6ea5f5c847320"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":433,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct Handover {\n    pub id: HandoverId,\n    pub entity_id: EntityId,\n    pub session_id: SessionId,\n    pub instance_id: InstanceId,\n    pub content: String, // Free text summary\n    pub summary: Option<String>,\n    pub open_threads: Vec<OpenThread>,\n    pub observations: Vec<String>,\n    pub emotional_state: Option<EmotionalState>,\n    pub verified: bool, // Sanity check verified\n    pub governance_notes: Vec<String>,\n}\n```","hash_alg":"sha256","hash":"118cb4b78147fd99972939a3644e4806707ee8fa6a6d3df441a540822a368d12"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":434,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"paragraph","md":"**Handover Builder:**","hash_alg":"sha256","hash":"77d2009c4a2570d578adb188e31da96e25bde8f88bbc4930445dd71b8e7af62a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":435,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"code","lang":"rust","md":"```rust\nHandoverBuilder::new(entity_id, session_id, instance_id)\n    .accomplished(vec![\"Fixed bug\", \"Updated docs\"])\n    .open_threads(vec![OpenThread {\n        description: \"Need to add tests\",\n        priority: 5,\n        tags: vec![\"testing\"]\n    }])\n    .observations(vec![\"Code quality is good\"])\n    .emotional_note(\"Feeling confident about progress\")\n    .build()\n```","hash_alg":"sha256","hash":"07b2be036d8f426c420ccd166776f32414a6278f55526100be9b3420800ed643"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":436,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"paragraph","md":"**Emotional State Tracking:**","hash_alg":"sha256","hash":"1d157b7310651d7d362bebd0eee78c11c5564a93440e60b1b8476214601ef342"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":437,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct EmotionalState {\n    pub confidence: f32, // 0.0 - 1.0\n    pub anxiety: f32,    // 0.0 - 1.0\n    pub satisfaction: f32, // 0.0 - 1.0\n    pub notes: Option<String>,\n}\n```","hash_alg":"sha256","hash":"aef9a1d6149591cb8f3e9c2706f340f745e03b77f4a73da5cf5941e9e2df71e9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":438,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"paragraph","md":"**Keyword Extraction:**","hash_alg":"sha256","hash":"7613a632c4fca1ce13119acecc0e0eb20d6ccfafa7f980caba9e90b3d3e24b7b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":439,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Handover System"],"block_kind":"list","md":"- Extracts keywords for sanity check\n- Looks for: malicious, unsatisfied, urgent, critical, suspicious, concerning, failure, error, problem\n- Used to flag potential issues","hash_alg":"sha256","hash":"356296a69d3fcc3c66bef5ea762645a5ad8a358a99682e59e9581480a6453ff9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":440,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"heading","level":3,"text":"Sanity Check","md":"### Sanity Check","hash_alg":"sha256","hash":"0684b70f11a9dc7faa9712928dc56708868c18b954305e2578bc2636aae1b66d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":441,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"paragraph","md":"**Purpose**: Validates claims from handovers against objective facts","hash_alg":"sha256","hash":"60170ae5a94c880c10aa4a20e6fe34ea46b45055f0f3c17166c7dd2a560281f1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":442,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"paragraph","md":"**Process:**","hash_alg":"sha256","hash":"92120fac2b56716a66b78d943d810bed0f1145ce972dc7c51f0e5db9093a816e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":443,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"code","lang":"rust","md":"```rust\n1. Extract claims from handover text\n   ‚Üí Find sentences with keywords\n   ‚Üí Estimate sentiment (-1.0 to 1.0)\n   ‚Üí Classify as factual vs opinion\n\n2. Query facts from UBL ledger\n   ‚Üí Get recent events for entity\n   ‚Üí Convert to Fact objects\n\n3. Find discrepancies\n   ‚Üí Check if claims contradict facts\n   ‚Üí Calculate severity\n   ‚Üí Generate governance notes\n\n4. Return governance notes for narrative injection\n```","hash_alg":"sha256","hash":"531fc486105687b52060a9ff77aa51ba7a3548a8f0500b0f9bfe97b273dfa0d7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":444,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"paragraph","md":"**Claim Extraction:**","hash_alg":"sha256","hash":"08f773c3391d4ae299fd36f13c927c1db2b1e42e4f9c333afabea11bc5c8d28e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":445,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"list","md":"- Keyword-based (configurable keywords)\n- Sentence-level analysis\n- Sentiment estimation\n- Factual vs opinion classification","hash_alg":"sha256","hash":"3087de5b7853d0eea7c1290910f7e82f1b22dd5db67e6d00564ec7033e9c2e19"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":446,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"paragraph","md":"**Discrepancy Detection:**","hash_alg":"sha256","hash":"440e8e107b761ec4a1bcc4fdb46c958ce09b58d9e2086021f515755a06eeb9b6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":447,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"list","md":"- Checks for opposite sentiment keywords\n- Examples:\n  - Claim: \"delayed\" vs Fact: \"on time\" ‚Üí Discrepancy\n  - Claim: \"failure\" vs Fact: \"success\" ‚Üí Discrepancy\n  - Claim: \"unsatisfied\" vs Fact: \"positive feedback\" ‚Üí Discrepancy","hash_alg":"sha256","hash":"a9304fa9977889537b577f05f152e8a768bfb16caec948b3a64252d220964875"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":448,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"paragraph","md":"**Governance Note Format:**","hash_alg":"sha256","hash":"e8852d9b2df21ddacaf635c3d7edb99ac49e652224112a0cb97a50a1908a6a96"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":449,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sanity Check"],"block_kind":"code","lang":null,"md":"```\nGOVERNANCE NOTE: The previous handover stated '{claim}', \nbut objective records show:\n- 2024-12-28: {fact1}\n- 2024-12-27: {fact2}\nPlease verify the current situation before acting on the handover claims.\n```","hash_alg":"sha256","hash":"2f3ddf9b94e30f40c3df5cb25165650601ebb4df1eeb0bdcfbf0bb5cba6d9e74"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":450,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"heading","level":3,"text":"Dreaming Cycle","md":"### Dreaming Cycle","hash_alg":"sha256","hash":"0c178340f8426842e376809b8b2f2f17e411c560435ed0c56be36c23175c9615"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":451,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Purpose**: Asynchronous memory consolidation and anxiety removal","hash_alg":"sha256","hash":"e79cf10d90a454fff9597ef01fcc6a530e28c70f8f6b434ac7ff8a20c1692436"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":452,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Trigger Conditions:**","hash_alg":"sha256","hash":"9aa2ad32f98d19cdc2ee35fe2198f4e876507aa74b5cfb4c05678a01901c526f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":453,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"list","md":"- Session threshold reached (default: 50 sessions)\n- Time threshold reached (default: 24 hours)\n- Manual trigger via API","hash_alg":"sha256","hash":"30ea70fa2ca4c3ba7859922ba0434d5545ee5277f24eb5383b7654a012c25551"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":454,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Process:**","hash_alg":"sha256","hash":"92120fac2b56716a66b78d943d810bed0f1145ce972dc7c51f0e5db9093a816e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":455,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"code","lang":"rust","md":"```rust\n1. Garbage Collection\n   ‚Üí Archive old, resolved events\n   ‚Üí Remove resolved issues from memory\n\n2. Emotional Reset\n   ‚Üí Identify anxieties in handovers\n   ‚Üí Check if issues are resolved\n   ‚Üí Clear resolved anxieties\n\n3. Pattern Synthesis\n   ‚Üí Analyze trajectories/sessions\n   ‚Üí Extract patterns (session types, frequencies)\n   ‚Üí Create historical syntheses\n\n4. Baseline Update\n   ‚Üí Synthesize new baseline narrative\n   ‚Üí Use LLM if available, else simple template\n   ‚Üí Update entity baseline\n```","hash_alg":"sha256","hash":"135a51d3c33c83e53208034917ca619d7208cd787604fbc24fea401be2e5aa4f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":456,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Dreaming Result:**","hash_alg":"sha256","hash":"905f829604c59bbcd2924fefd88505573e6f1bdbb8732840504a36bc5d237038"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":457,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"code","lang":"rust","md":"```rust\npub struct DreamingResult {\n    pub entity_id: EntityId,\n    pub started_at: DateTime<Utc>,\n    pub ended_at: DateTime<Utc>,\n    pub events_processed: usize,\n    pub events_archived: usize,\n    pub anxieties_cleared: Vec<String>,\n    pub patterns: Vec<String>,\n    pub new_baseline: String,\n    pub syntheses_created: usize,\n    pub errors: Vec<String>,\n}\n```","hash_alg":"sha256","hash":"be6db30df8535bd57097591063cb40ca978cee9ad2a61063417bb15fe206a7b3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":458,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Pattern Synthesis:**","hash_alg":"sha256","hash":"2d63a1258d1c4578ea2e63cfa4b17c1b4b5621dbf64145bdb184928dae1eb9fd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":459,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"list","md":"- Analyzes session types and frequencies\n- Identifies recurring patterns (e.g., \"Frequently uses Work sessions\")\n- Creates historical syntheses for memory","hash_alg":"sha256","hash":"0f05e451794a90ec7e779596953b29064ccbf9809869acbc9543c3e7a06600d2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":460,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"paragraph","md":"**Baseline Update:**","hash_alg":"sha256","hash":"caa17fffc79d80a8f7b39e7698b949bfcd85f8aa7b90bd05244dd5bb4cec0494"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":461,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Dreaming Cycle"],"block_kind":"list","md":"- If LLM available: Uses LLM to synthesize narrative\n- Else: Generates simple template with patterns\n- Updates entity's baseline_narrative","hash_alg":"sha256","hash":"f2e6b9ebd771eb34c52044d9a5743071297f78b6113a684e080bcf31aba3dd8f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":462,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"heading","level":3,"text":"Simulation System","md":"### Simulation System","hash_alg":"sha256","hash":"00ce8c90ff8acbc1fe90ea330adc7b341eb4970231d41f370cd51a394ca0caf9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":463,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Purpose**: Safety net for testing actions before execution","hash_alg":"sha256","hash":"52762911d2dc38c831377b4f5503cf3ca87b8ab9f3f8c54bf4e0ea56dba49287"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":464,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Risk Threshold:**","hash_alg":"sha256","hash":"83a68736e0fdd9628ed9b99d9a54c317e2bce39f323b95e4240b823cf2d687eb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":465,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"list","md":"- Default: 0.7 (70% risk score)\n- Actions with risk >= threshold require simulation","hash_alg":"sha256","hash":"f72d3d28dda6b8c7b5c849c8ffe99927f910f91ac376a8e1d7e1d8d26c6ef7a5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":466,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Simulation Process:**","hash_alg":"sha256","hash":"2d943bfd221c61a1097a093a3c1b651075b13e66240e697c3c79de1e79f6ac3e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":467,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"code","lang":"rust","md":"```rust\n1. Generate possible outcomes\n   ‚Üí Success outcome (probability based on risk)\n   ‚Üí Partial success (if risk > 0.3)\n   ‚Üí Failure (if risk > 0.5)\n   ‚Üí Severe failure (if risk > 0.7)\n\n2. Calculate recommendation\n   ‚Üí Expected value = Œ£(probability √ó severity)\n   ‚Üí Worst-case probability\n   ‚Üí Determine: Proceed, Modify, SeekConfirmation, Abandon\n\n3. Generate modifications (if needed)\n   ‚Üí Break into smaller steps\n   ‚Üí Add safeguards\n   ‚Üí Reduce amounts/targets\n```","hash_alg":"sha256","hash":"40fe30734da1eaafc5da64bf0576b0e2cfaddd33269383a89344c69c5deb81e3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":468,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Action Outcomes:**","hash_alg":"sha256","hash":"27c71de859a101b42c354d5a8cddf3b559ed06b23fbf45485545158eb471c4f8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":469,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct ActionOutcome {\n    pub description: String,\n    pub probability: f32, // 0.0 - 1.0\n    pub severity: f32,    // -1.0 (very bad) to 1.0 (very good)\n    pub consequences: Vec<String>,\n    pub is_terminal: bool,\n}\n```","hash_alg":"sha256","hash":"ab6c763a1c754b105bf3efb287b31d56f085e5649179d4ad052a8a626c8eed93"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":470,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Recommendations:**","hash_alg":"sha256","hash":"9c2d21005d774cdddfbce24e647a1c4bfab0f7c266380940dabb11ac8aca4ad9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":471,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"list","md":"- **Proceed** - Expected value > 0.3, worst-case < 0.1 (safe to execute)\n- **Proceed (caution)** - Expected value > 0.0, worst-case < 0.2 (execute with monitoring)\n- **Modify** - Expected value > -0.2, worst-case < 0.3 (break into smaller steps)\n- **SeekConfirmation** - Worst-case >= 0.3 (require human approval)\n- **Abandon** - Expected value <= -0.2 (too risky, don't execute)","hash_alg":"sha256","hash":"e706c053efa2eb87a9175a2fe3b223cc6f8ca4e41f37a3b60da4b2ea0f8a7fcb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":472,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Modification Strategies:**","hash_alg":"sha256","hash":"a6834610ca5b8ce1ba68444c2aa232bce4b037cb9dddf4b1b75c095a79f82379"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":473,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"list","md":"- Break action into smaller steps\n- Add safeguards (rollback plans, checkpoints)\n- Reduce amounts/targets (partial execution)\n- Add confirmation checkpoints\n- Increase monitoring/logging","hash_alg":"sha256","hash":"36679bdfc5d18167f30ac1b0cb60751729c97d90b48382876ea9b70ae405a1df"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":474,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"paragraph","md":"**Quick Check:**","hash_alg":"sha256","hash":"869befc2ab0cee6ed6bfebe9351896bbe35a86dd1cdb83f3d1464f24d8d4fcde"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":475,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Simulation System"],"block_kind":"list","md":"- For affordances with known risk scores\n- Returns recommendation without full simulation\n- Faster path for low-risk actions","hash_alg":"sha256","hash":"2f20f598c3d5f0cf5f5d6e00814d5f98a628914e3c449e5f87c637edb06d4729"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":476,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"heading","level":3,"text":"Tool Audit System","md":"### Tool Audit System","hash_alg":"sha256","hash":"161730e70ffd1b16a36e5f2ff5bed44f8d80abfef6247887eb888f47e690bea7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":477,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Purpose**: Records every tool call and result for audit trail","hash_alg":"sha256","hash":"757386ae40fc0a674221fb691f1e44820b772c3a1c214946ffefd6f567488132"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":478,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Tool Call Recording:**","hash_alg":"sha256","hash":"6cf1417a5596f06d4e8ea936a79eb3d851c26fa770c7d2c37b6fa6e1b60b87a5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":479,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct ToolCall {\n    pub tool_call_id: String, // Unique ID, pairs with result\n    pub tool_name: String,\n    pub tool_version: String,\n    pub purpose: String,\n    pub inputs: serde_json::Value, // Sanitized (PII redacted)\n    pub pii_policy: PiiPolicy,\n    pub idempotency_key: String,\n    pub attempt: u32,\n    pub retry_of: Option<String>, // If retry\n    pub called_at: DateTime<Utc>,\n}\n```","hash_alg":"sha256","hash":"6c2afd6222257560927cee4c59eaecb39c912779f3356f740e862b5a5d514557"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":480,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Tool Result Recording:**","hash_alg":"sha256","hash":"6b5331710a8b5b2d641d59e30e43e54a806aee5ed0fa6a8df36983f026af794e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":481,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct ToolResult {\n    pub tool_call_id: String, // Pairs with call\n    pub tool_name: String,\n    pub status: ToolStatus, // Success | Error\n    pub latency_ms: u64,\n    pub output: Option<serde_json::Value>, // Sanitized\n    pub artifacts: Vec<Artifact>,\n    pub error: Option<ToolError>,\n    pub safety: SafetyReport,\n    pub attempt: u32,\n    pub completed_at: DateTime<Utc>,\n}\n```","hash_alg":"sha256","hash":"8964352a7f3c5b0da51d44d1077f44cfa70000ebb9ab420443543256a9789c96"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":482,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**PII Handling:**","hash_alg":"sha256","hash":"479c99a1695a1617052266d6982e9e233ef5592d8e58198a506333a694c1c1c0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":483,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"list","md":"- Inputs/outputs are sanitized before storage in ledger\n- PII policy applied (redaction rules: email ‚Üí `u***@domain.com`, phone ‚Üí `12***890`)\n- Safety report tracks PII leaks and redactions\n- **Email Redaction**: `user@example.com` ‚Üí `u***@example.com`\n- **Phone Redaction**: `+1234567890` ‚Üí `12***890`\n- **PII Hashing**: BLAKE3 hash with tenant salt for correlation without exposure\n- **Detection**: Regex patterns for email (`[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}`) and phone (`\\+?[0-9][0-9\\-\\s()]{7,}`)\n- **Policy Violation**: Returns `RawPiiDetected` error if raw PII found in atom","hash_alg":"sha256","hash":"c61af8cf4646c15a6e26c13b069951328f290b51b3672490be29eabf0f437350"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":484,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Idempotency:**","hash_alg":"sha256","hash":"43f7f06f8ad83c58a09c3896cdfabcefa15b78e9b3eee2ea9dd94e01ab656418"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":485,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"list","md":"- Each tool call has idempotency_key\n- Format: `idem:{job_id}:{tool_name}:{tool_version}`\n- Duplicate calls return cached result","hash_alg":"sha256","hash":"5831919cddb46c15d0d31d998ee8a52a11a4cb8c4842e4a60c7ed7e5f8670d6a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":486,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Latency Tracking:**","hash_alg":"sha256","hash":"c32d6452a023e9eddc61bef4aec8012d9dd99a8e49576d4f71c607823a53e3e1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":487,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"list","md":"- In-flight calls tracked in HashMap\n- Latency calculated on result\n- Stored in tool.result event","hash_alg":"sha256","hash":"7e5cfa2fa96af182bf5b10515caceb6285b27755b9e84d0890283d835612898c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":488,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Error Types:**","hash_alg":"sha256","hash":"a2567865ecc40c3579e603f5513a71009b1c3b519040b09757102e9e43fdf4a4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":489,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"list","md":"- `PROVIDER_TIMEOUT` - Retryable, wait 10s, max 3 retries\n- `PROVIDER_RATE_LIMIT` - Retryable, wait 60s, max 5 retries\n- `PROVIDER_AUTH_REQUIRED` - Not retryable, requires API key update\n- `INVALID_INPUT` - Not retryable, fix input and retry manually\n- `PROVIDER_UNAVAILABLE` - Retryable, wait 300s, max 3 retries\n- `TOOL_EXECUTION_ERROR` - Not retryable, tool-specific error\n- `NETWORK_ERROR` - Retryable, wait 5s, max 3 retries","hash_alg":"sha256","hash":"beb1571ccff93485633ed11a8e0d19ec42dbb44a5409314e0ece39ac56fa2daf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":490,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"paragraph","md":"**Retry Strategy:**","hash_alg":"sha256","hash":"bab939603c030133b6e2b6d5184554a770bda4a13fb71b9437bd9d0ec4fefb04"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":491,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Tool Audit System"],"block_kind":"list","md":"- Exponential backoff for retryable errors\n- Max retries per error type (configurable)\n- Idempotency ensures safe retries\n- Error logged in `tool.result` event","hash_alg":"sha256","hash":"fb8f39e256340c74668b21aefbaac3bd5d079a0bf41d7938b2484e13d5575ec0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":492,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"heading","level":3,"text":"Entity Management","md":"### Entity Management","hash_alg":"sha256","hash":"e244854e5d882fdddf8eb79f8cda42c4dbfd50041ac7bc2ac8cb05c6440316c4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":493,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"paragraph","md":"**Entity Structure:**","hash_alg":"sha256","hash":"43354c98c5407473a9e20e4c2b6818865f6101da41f9270e9a5f0f1e128bfcac"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":494,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"code","lang":"rust","md":"```rust\npub struct Entity {\n    pub id: EntityId,\n    pub name: String,\n    pub entity_type: EntityType, // Autonomous, Guarded, Development\n    pub status: EntityStatus, // Active, Suspended, Archived\n    pub identity: Identity, // Ed25519 keypair\n    pub guardian_id: Option<GuardianId>,\n    pub constitution: Constitution,\n    pub baseline_narrative: String,\n    pub total_sessions: u64,\n    pub total_tokens_consumed: u64,\n    pub created_at: DateTime<Utc>,\n    pub last_active_at: DateTime<Utc>,\n    pub last_dream_at: Option<DateTime<Utc>>,\n    pub metadata: serde_json::Value,\n}\n```","hash_alg":"sha256","hash":"21909e2dd688eb8d7ecfeffc0f62e735bf89ba465cd45bcdcea58c75258954ab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":495,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"paragraph","md":"**Entity Lifecycle:**","hash_alg":"sha256","hash":"78b8d0443a092d80632ff8b714e4ecb6f1c6a19224d0d992594311e057f8f550"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":496,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"list","md":"- **Created** - New entity with cryptographic keys\n- **Activated** - Can spawn instances\n- **Suspended** - Temporarily disabled\n- **Archived** - Soft deleted","hash_alg":"sha256","hash":"37c61296a5a5cb58130d833554703395ff7738287d6d19a21ce59da1478e4810"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":497,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"paragraph","md":"**Identity:**","hash_alg":"sha256","hash":"7044ab18bfabc2bef64498a6ee9805f67f802271a39b72fe431b951646cadf0b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":498,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"list","md":"- Ed25519 keypair for signing events\n- Public key stored in hex format\n- Private key stored securely (not in entity struct)","hash_alg":"sha256","hash":"d65773fcd690863d732700ca2b0ef74d055f7368350ea79e5f5568776e9b78de"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":499,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"paragraph","md":"**Constitution:**","hash_alg":"sha256","hash":"93db611170d61af661a9a223f7cad10a46188a00ca88df49d08bae878e249211"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":500,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"list","md":"- Behavioral directives that override RLHF\n- Can be updated via `update_constitution()`\n- Always injected into context frame","hash_alg":"sha256","hash":"2caa89e99008b1d66bc86523918a74798b970ef78f01c97c50c39dc6b92324c9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":501,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"paragraph","md":"**Baseline Narrative:**","hash_alg":"sha256","hash":"5d6388388737a041e14a3192f268ceef37fa7b69fa086517795b6c5d127af42e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":502,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Entity Management"],"block_kind":"list","md":"- Consolidated narrative from dreaming cycles\n- Updated via `update_baseline()`\n- Used as foundation for context frames","hash_alg":"sha256","hash":"d46f3eea1944fd3f49ab279bd7f51162dc6ddb95ba459bc39db9f1ade8be6cfe"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":503,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"heading","level":3,"text":"Memory System","md":"### Memory System","hash_alg":"sha256","hash":"10e88d07f6bcba0fefd81d535e4ba6cba5f2fddbdda442a19073bb536b23646e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":504,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Hybrid Memory Strategy:**","hash_alg":"sha256","hash":"db19df4d1d83b598629a6e2c7d7315400aae95f044bb00d74ae28ace0a635a37"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":505,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"list","md":"- **Recent Events**: Verbatim (last 20, configurable)\n- **Historical Syntheses**: Compressed periods\n- **Bookmarks**: Important events\n- **Baseline**: Consolidated narrative","hash_alg":"sha256","hash":"9a67439194f5cc597f95e3060973995932894fcf2a5e651ee501c41d5b35bcaf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":506,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Memory Structure:**","hash_alg":"sha256","hash":"af0587ebd918cf6575a133ac7eb5f8da2fd6174c1c10eec7786055ab5f0a4b8f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":507,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct Memory {\n    pub recent_events: Vec<MemoryEntry>, // Verbatim, most recent first\n    pub historical_syntheses: Vec<HistoricalSynthesis>,\n    pub bookmarks: Vec<Bookmark>,\n    pub baseline_narrative: String,\n    pub last_updated: Option<DateTime<Utc>>,\n    pub total_events: u64,\n}\n```","hash_alg":"sha256","hash":"8e0113842707fc3564699a27b680f84375fd3919b214e5d8f5444b66872edf00"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":508,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Memory Entry:**","hash_alg":"sha256","hash":"fb0e6b4fad09f03987dcade1587a5c31c6f291f8080d46e9c86811abb31c08ae"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":509,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct MemoryEntry {\n    pub event_id: String,\n    pub event_type: String,\n    pub timestamp: DateTime<Utc>,\n    pub summary: String,\n    pub data: Option<serde_json::Value>, // Full data for verbatim\n    pub is_bookmarked: bool,\n}\n```","hash_alg":"sha256","hash":"e0484213b58621da5b90558b35fb98e5303dd3395912c23699d57ab874144a72"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":510,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Historical Synthesis:**","hash_alg":"sha256","hash":"783057556eeda98503f6131e579367c643d9245e64852c3223e4654d94fac8be"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":511,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct HistoricalSynthesis {\n    pub period_start: DateTime<Utc>,\n    pub period_end: DateTime<Utc>,\n    pub narrative: String,\n    pub event_count: u32,\n    pub themes: Vec<String>,\n}\n```","hash_alg":"sha256","hash":"f4820397634655da5c249eb5bc8dd3d27c556ea39617faa7a0d8992b1f6ee904"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":512,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Bookmark:**","hash_alg":"sha256","hash":"b780083d57b774fc04bca68ff3ac0aff140c72d8e12f1da59bdbb21be8ee4f63"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":513,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"code","lang":"rust","md":"```rust\npub struct Bookmark {\n    pub event_id: String,\n    pub reason: String,\n    pub created_at: DateTime<Utc>,\n    pub event_summary: String,\n    pub tags: Vec<String>,\n}\n```","hash_alg":"sha256","hash":"6ef451b47dd919589cc16c87953f01a0adf68a44df6294449c7ef937d382ab0c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":514,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Token Estimation:**","hash_alg":"sha256","hash":"c67361acb5eff42b8138ff5d1820526ed4ec15fc20f7e589e4c596b869d0163c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":515,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"list","md":"- Rough estimate: 4 characters per token\n- Includes: baseline, recent events, syntheses, bookmarks\n- Used for memory compression","hash_alg":"sha256","hash":"2b11306a22253f88da3e3cc1fffe67318f8ba9bf445280c428f2d84700b196d3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":516,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"paragraph","md":"**Memory Compression:**","hash_alg":"sha256","hash":"05e9dfc792649d57121a32bad4ccaad6933142b2b5dc98f72f51105f61613c7f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":517,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Memory System"],"block_kind":"list","md":"- Triggered when memory token estimate exceeds session token budget\n- Compression steps (in order):\n  1. Remove `data` field from recent events (keep summary only)\n  2. Reduce recent events count (from 20 to 10, then 5)\n  3. Reduce historical syntheses count (remove oldest)\n  4. Truncate baseline narrative (keep first 1000 tokens)\n  5. Remove non-bookmarked events from recent_events\n- Compression preserves bookmarks and most recent events\n- Compression is reversible (data can be re-fetched from ledger)","hash_alg":"sha256","hash":"276f94b17049759e5951011b1cef1a7d82d0c6ce61bcde4ca56211aaa02f5f67"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":518,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"heading","level":3,"text":"Policy Pack v1 Implementation","md":"### Policy Pack v1 Implementation","hash_alg":"sha256","hash":"0aa45dcb491b60e9312dbab1213465af42e39db3003a4d3d73913f3ae46bd6da"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":519,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"paragraph","md":"**Policy Engine:**","hash_alg":"sha256","hash":"54be5afbb2e1a414e6c002380b8fffa6c78e42c3d1fca3677b7b9bf30876bc9d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":520,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"code","lang":"rust","md":"```rust\npub struct PolicyEngine {\n    pool: PgPool,\n}\n```","hash_alg":"sha256","hash":"0503a27aa93b8020d45e718a61cd9023c93ce023dd87ee01424792fdc404ee4d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":521,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"paragraph","md":"**Policy Checks:**","hash_alg":"sha256","hash":"6ea99c6e5ce4f8ac60b70aa6b1d8ec9b7a71572725eb6c707276c5cbe40fe603"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":522,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"list","md":"1. **Job FSM Validation:**\n   - Validates state transitions follow FSM\n   - Allowed transitions defined in HashMap\n   - Returns `IllegalJobTransition` error if invalid","hash_alg":"sha256","hash":"9ea616c729178d9bbaaaf9426dce685f087b497be2fc39bf0ff99df622b7419f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":523,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"list","md":"2. **Card Provenance:**\n   - Verifies card exists in prior `message.sent` event\n   - Checks card_id in C.Messenger ledger\n   - Returns `InvalidProvenance` error if not found","hash_alg":"sha256","hash":"df88aa753e3da2be250c044ff45429f52e0191a6fa026c6d53bf678e25e05a53"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":524,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"list","md":"3. **PII Detection:**\n   - Regex patterns for SSN, credit card, phone\n   - Returns `RawPiiDetected` error if found\n   - Prevents raw PII in ledger","hash_alg":"sha256","hash":"7c95ba53790aa6f43e84b68e4d9bf4d61e3d3cb752ff6cc0fadf4794e6cd7fa4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":525,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"list","md":"4. **Tool Pairing:**\n   - Validates `tool.called` exists before `tool.result`\n   - Returns `ToolPairingViolation` error if missing\n   - Ensures audit trail completeness","hash_alg":"sha256","hash":"0dda2499b7d938a067ebf6d0ba95e954cd5655d4baa82c522809201b8936c769"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":526,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"paragraph","md":"**Policy Errors:**","hash_alg":"sha256","hash":"1cfe40e005513f28e8495c4c24b5a9617f059ff6af9b21245cc8c8c566b05301"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":527,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Policy Pack v1 Implementation"],"block_kind":"code","lang":"rust","md":"```rust\npub enum PolicyError {\n    IllegalJobTransition { from: String, to: String },\n    InvalidProvenance { reason: String },\n    RawPiiDetected { field: String },\n    ToolPairingViolation { tool_call_id: String },\n    TenantViolation { reason: String },\n}\n```","hash_alg":"sha256","hash":"0e6146a891bdcdbca7ead8cdd804d323b787cdb8542bec3c25aca1a179245112"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":528,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"heading","level":3,"text":"Frontend SSE Integration","md":"### Frontend SSE Integration","hash_alg":"sha256","hash":"2599c29de0e85cc91175c13dbaf060081941b0fa7fd3931b32fbb2882170d8bc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":529,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"paragraph","md":"**SSE Client:**","hash_alg":"sha256","hash":"5ed2806d22fa261c0b704a342759cf01a19a5f06832a81c32809dc58ac77c1a3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":530,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"code","lang":"typescript","md":"```typescript\n// From services/sse.ts\nclass SSEClient {\n  private eventSource: EventSource | null = null;\n  private handlers: Map<SSEEventType, SSEEventHandler[]> = new Map();\n  private currentCursor: string = '0:0';\n  \n  connect(cursor?: string): void {\n    const url = `${baseUrl}/v1/stream?tenant_id=${tenantId}${cursor ? `&cursor=${cursor}` : ''}`;\n    this.eventSource = new EventSource(url);\n    \n    // Register event listeners\n    this.eventSource.addEventListener('hello', ...);\n    this.eventSource.addEventListener('timeline.append', ...);\n    this.eventSource.addEventListener('job.update', ...);\n    this.eventSource.addEventListener('presence.update', ...);\n  }\n}\n```","hash_alg":"sha256","hash":"c2f7089ca8910d12da8d82e6fa84852c0ca1af5dc4d2963e2b037c0e92dc64b2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":531,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"paragraph","md":"**React Hook:**","hash_alg":"sha256","hash":"0e17011c7f8c5caaf182150de2180c92e597fafbb4470d27f2c9fe50c8120780"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":532,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"code","lang":"typescript","md":"```typescript\n// From hooks/useSSE.ts\nexport function useSSE(\n  tenantId: string = 'default',\n  handlers: Partial<Record<string, SSEEventHandler>> = {}\n) {\n  useEffect(() => {\n    const client = new SSEClient(baseUrl, tenantId);\n    \n    // Register handlers\n    Object.entries(handlers).forEach(([eventType, handler]) => {\n      if (handler) {\n        client.on(eventType as any, handler);\n      }\n    });\n    \n    client.connect();\n    \n    return () => client.disconnect();\n  }, [tenantId, handlers]);\n}\n```","hash_alg":"sha256","hash":"95bc5215fe1ccdf12df55a253d54fab44883029d053836f84e80e0d84c6bbdfa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":533,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"paragraph","md":"**Reconnection:**","hash_alg":"sha256","hash":"9d59f9a62c33edf9a09e65968427c14c16a467caea5e82b788331d06faf6c61a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":534,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Frontend SSE Integration"],"block_kind":"list","md":"- Automatic reconnection with exponential backoff (1s, 2s, 4s, 8s, 16s)\n- Max 5 attempts before giving up\n- Uses `Last-Event-ID` header with cursor (`sequence:timestamp`) for resuming\n- Replays missed events (up to 1000) on reconnection\n- Emits `reconnected` event to handlers","hash_alg":"sha256","hash":"71f293569dec3e59cf885d8d1e94436d97e901964cf05f58261063f2c6027029"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":535,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"heading","level":3,"text":"Job Drawer UI","md":"### Job Drawer UI","hash_alg":"sha256","hash":"85bc4d2262d1471f6ea8554c1653d348ae801a0bfde7dee15855f328d09d2d33"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":536,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"paragraph","md":"**Components:**","hash_alg":"sha256","hash":"951f68e51d856af826b352b9714d2d92c2f420c3f8c864ee77406b5759676c21"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":537,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"list","md":"- `JobDrawer` - Main drawer container\n- `JobTimeline` - Timeline of events\n- `JobArtifacts` - List of artifacts","hash_alg":"sha256","hash":"b1195565198d34039974d0d6443c1d40882b2d9162a4953c407a2b4ab482abec"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":538,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"paragraph","md":"**Job Drawer Features:**","hash_alg":"sha256","hash":"5239cf83afb318ea09d9d480788232ca0c50f0bb6663cd2b4bf17350b0a56eb0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":539,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"list","md":"- Header with title, state badge, close button\n- Summary section (goal, constraints)\n- Owner information\n- Available actions (context-aware buttons)\n- Timeline (expandable event items)\n- Artifacts list (files, links)","hash_alg":"sha256","hash":"ae6d713fbbecb803c4fc7d804f13c14cc955b138da5b5d66cd1c1b05f531e396"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":540,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"paragraph","md":"**Timeline Item Types:**","hash_alg":"sha256","hash":"ee74f83895654abf29c8ce516931da44a708522f90dd44b603ebef7126b1477c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":541,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"list","md":"- `job_created` - Blue clock icon (job proposal created)\n- `state_changed` - Yellow alert icon (FSM transition)\n- `tool_called` - Purple wrench icon (tool invocation)\n- `tool_result` - Green check icon (tool completion, red X if error)\n- `approval_decided` - Indigo message icon (approval/rejection decision)\n- `job_started` - Green play icon (execution began)\n- `job_completed` - Green checkmark icon (successful completion)\n- `job_failed` - Red X icon (execution failed)\n- `job_cancelled` - Gray stop icon (cancelled by user/system)","hash_alg":"sha256","hash":"14e7c12714d492ab5afc8335af1fd3b9c24f33d3b38c484fc1988e86491a3acc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":542,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"paragraph","md":"**Expandable Details:**","hash_alg":"sha256","hash":"ffbe2e4434818a2b9e665b9a10ba0f00417d8308f594a470837dedf0b970a733"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":543,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Job Drawer UI"],"block_kind":"list","md":"- Click \"Show details\" to expand\n- Shows inputs/outputs in JSON format\n- Collapsible for cleaner UI","hash_alg":"sha256","hash":"789937cc9e392cae3abb2a4d8023c430eda193d444f6d999de8689d4001f4377"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":544,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"heading","level":3,"text":"Sidebar Presence Indicators","md":"### Sidebar Presence Indicators","hash_alg":"sha256","hash":"baefea3fc499a84d4d50d247d540e86ca0d400ce9fc7685d98d2de2b6d4e2886"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":545,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"paragraph","md":"**Presence States:**","hash_alg":"sha256","hash":"bfa800cd04a33bd2525660b293461867e278a32110d04409dc97c7a0e1bb5f3a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":546,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"list","md":"- üü¢ Green dot: Online/available (active, no jobs)\n- üü° Yellow dot: Working (executing in_progress job)\n- üî¥ Red dot: Waiting on you (waiting_input job needs your input)\n- ‚ö™ Gray dot: Offline (no activity > TTL)\n- üü† Orange dot: Away (humans: activity > 15min but < TTL)\n- üîµ Blue dot: Busy (agents: multiple jobs or high activity)","hash_alg":"sha256","hash":"6e965cd28ab12ff9f769a9c5e1fb439ae4d7cc9f68fa5356499b82c08438901c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":547,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"paragraph","md":"**Badges:**","hash_alg":"sha256","hash":"ec30368b3a7134584348885067d105107e3209f2db3f7369155ad13b80b0ce34"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":548,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"list","md":"- **\"Needs You\"** - Red badge, shown when entity has `waiting_input` job with you in `waiting_on[]`\n- **\"Working\"** - Yellow badge, shown when entity has `in_progress` job\n- **\"Away\"** - Gray badge, shown for humans with activity > 15min (optional)\n- **\"Busy\"** - Blue badge, shown for agents with multiple active jobs (optional)","hash_alg":"sha256","hash":"927519cb9097d00b74344655658fcbb84f9c7563f01bd658d591bbb9f0440614"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":549,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"paragraph","md":"**Update Flow:**","hash_alg":"sha256","hash":"2d750fc4401f25ea4aa00f42f995b1bc989f1d688cd18205a740d9525f54b25c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":550,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Sidebar Presence Indicators"],"block_kind":"list","md":"1. SSE `presence.update` event received from Gateway\n2. Parse event: `{ entity_id, state, job_id, since, last_seen_at }`\n3. Update entity state in sidebar state (React state)\n4. Update badge if state changed (conditional rendering)\n5. Re-render conversation list (React reconciliation)\n6. Update presence indicator color (CSS class change)\n7. Show/hide \"Needs You\" or \"Working\" badge (conditional rendering)","hash_alg":"sha256","hash":"2f673da899ae2d0c39911c8f27dfe1aaad5aa2ccda4fea4b015280fcca4f0266"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":551,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"heading","level":3,"text":"Container Architecture","md":"### Container Architecture","hash_alg":"sha256","hash":"cfaa704cb36a4843127a65b62410b9b1ed4e66b86dcf3e05e5bec5ccae416203"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":552,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"paragraph","md":"**Container Pattern:**","hash_alg":"sha256","hash":"0bd077c0e48aeedc769d8b4db064986382510d5f591a4c411f4c003114d72243"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":553,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"code","lang":null,"md":"```\n[local] --draft--> [boundary] --signing_bytes--> [ubl-link] --(signature)--> [membrane]\n                                                            \\--Accept--> [ledger] --tail--> [projections]\n```","hash_alg":"sha256","hash":"ec8e19cc22a50005228d2370e16d9ee00b018ed908514611ee5ed5675ab70749"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":554,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"paragraph","md":"**Container Roles:**","hash_alg":"sha256","hash":"39801f649bb4853ed017e78d905d89925b83046bc7705466667a169e133b2f84"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":555,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"list","md":"- **C.Messenger** (Verde/Public) - Messenger events\n- **C.Jobs** (Azul/Work Tracking) - Job lifecycle\n- **C.Office** (Preto/LLM Runtime) - Entity and session events\n- **C.Pacts** - Multi-party agreements\n- **C.Policy** - Policy definitions\n- **C.Runner** - Command execution\n- **C.Artifacts** - Generated artifacts","hash_alg":"sha256","hash":"1004704fe21f7fe7ca6bc5831d9bd45ae81e7ef7044d70a89b76d49f842e09ed"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":556,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"paragraph","md":"**Container Boundaries:**","hash_alg":"sha256","hash":"83f63b6ce5d765b1ba46c4579d9c994f16d26f6addd92678b783242a7279b034"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":557,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"list","md":"- Never import other containers directly\n- Only use `@kernel/*` and OpenAPI types\n- Communicate via LINKS (events in ledger)\n- Each container has own sequence","hash_alg":"sha256","hash":"d00916a0b7a7d83942433ba3725c10b4f9b1b4bd2a2330768b7eb1a2bf39ad78"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":558,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"paragraph","md":"**Container Policies:**","hash_alg":"sha256","hash":"f27f7939e5fdb42622d248de647e7f5e2e3165af60db59f24c0297a3cfd002b5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":559,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"list","md":"- Each container can have policy pack\n- Policies evaluated before commit\n- Policy hash recorded in ledger entry","hash_alg":"sha256","hash":"cc68af1a3a51d730b5958137a1274983770ef1b5e7affeaae2bcea053456da30"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":560,"path":["Three Systems Overview: UBL, Office, and Messenger","Advanced Implementation Details","Container Architecture"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":561,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details"],"block_kind":"heading","level":2,"text":"Database Schema Details","md":"## Database Schema Details","hash_alg":"sha256","hash":"af6a6f0cd2f733448cc0f3e63aff89076cbeb0d2f715f6297c46f473b6ba3f58"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":562,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"heading","level":3,"text":"Enhanced Projections (10_projections/101_messenger.sql)","md":"### Enhanced Projections (10_projections/101_messenger.sql)","hash_alg":"sha256","hash":"37a2adec514ebe696a10d5b1e82d03e9b76e96a91db4372a6a44bd78ef2efc8d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":563,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"paragraph","md":"**projection_jobs:**","hash_alg":"sha256","hash":"571f0a8112f8124cbcb2a96e2893e3f04e42dfe2e20162e59357238dcefb959d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":564,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"list","md":"- Enhanced with `waiting_on[]`, `available_actions JSONB`\n- Indexes on tenant+conversation, state, owner, updated_at","hash_alg":"sha256","hash":"6ec44af496977795f1110efe23391e1e7b2fe30abb610696c2653806d7550c38"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":565,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"paragraph","md":"**projection_job_events:**","hash_alg":"sha256","hash":"0136014269c9c100c09f4e8a9af6a5f4c136acbd7f10b7d30d11cf8ab44614fd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":566,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"list","md":"- Timeline items for job drawer\n- Cursor format: `seq:timestamp`\n- Indexes on job_id, event_type","hash_alg":"sha256","hash":"572beee7d3121cff84545f72e04b0d80ffa197251363f9c7194c131252cb5e55"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":567,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"paragraph","md":"**projection_job_artifacts:**","hash_alg":"sha256","hash":"809d09f730327eff45de51aa045341093db222a3690116bd8caa0ed1135df896"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":568,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"list","md":"- Artifacts from tool.result events\n- Indexes on job_id, kind","hash_alg":"sha256","hash":"603ad436d5f015eaec1252d74fb985efaf27579638fa2b57d0c7355c8cbca463"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":569,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"paragraph","md":"**projection_presence:**","hash_alg":"sha256","hash":"2a5252aa29f3c8937a100cd471d5dde4e9c20509f3c6af984b33e5880427196b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":570,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"list","md":"- Computed entity presence\n- Indexes on state, job_id, last_seen_at","hash_alg":"sha256","hash":"4076c586d2f2a5a10b62b966324c696319f45241fd1df3b9786376b66b17fc91"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":571,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"paragraph","md":"**projection_timeline_items:**","hash_alg":"sha256","hash":"388382ddc63680d24ef382cd1fe688778f612d42581067a774d62325c18c31cf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":572,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Enhanced Projections (10_projections/101_messenger.sql)"],"block_kind":"list","md":"- Optimized unified timeline\n- Indexes on conversation_id, item_type","hash_alg":"sha256","hash":"443c981d268648c9e83c8c0794e2720afa28e120843a082b3b2f33cc8f4aab94"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":573,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"heading","level":3,"text":"Index Strategy","md":"### Index Strategy","hash_alg":"sha256","hash":"e8102e808b5758ea38e12039cf4ad41f729ef899a2a7f3579b07b14c1befdc6d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":574,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"paragraph","md":"**Query Patterns:**","hash_alg":"sha256","hash":"8abcb5987372b69e2a31dcc2102415abaad238b4257aea415d71706d52e2caf0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":575,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"list","md":"- Conversation timeline: `(tenant_id, conversation_id, created_at DESC)`\n- Job timeline: `(tenant_id, job_id, ts DESC)`\n- Active jobs: `(state) WHERE state IN ('proposed', 'approved', 'in_progress', 'waiting_input')`\n- Presence by state: `(state)`\n- Presence by job: `(job_id) WHERE job_id IS NOT NULL`","hash_alg":"sha256","hash":"fd859c6b6b5cd0b2e71cbe4df992a2413ac46bb361cf8e4cb93f7579a1b6eaab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":576,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"paragraph","md":"**Performance:**","hash_alg":"sha256","hash":"1e899e7ad362163d23c98e850633830bc15b8d2bdcf67b41648efe2593608cb9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":577,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"list","md":"- All queries use indexes\n- Cursor-based pagination for large datasets\n- Partial indexes for filtered queries","hash_alg":"sha256","hash":"277fb5217d25aa22336c5cd0e163edd200d72b883ad7fe7bfecc4ca269d2ab3e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":578,"path":["Three Systems Overview: UBL, Office, and Messenger","Database Schema Details","Index Strategy"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":579,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration"],"block_kind":"heading","level":2,"text":"Complete System Integration","md":"## Complete System Integration","hash_alg":"sha256","hash":"d4c44af4bb879e1de2df6487e99eea9b419729ede2362d26049125d2ebec11d2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":580,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"heading","level":3,"text":"End-to-End Flow: User Message ‚Üí Job Completion","md":"### End-to-End Flow: User Message ‚Üí Job Completion","hash_alg":"sha256","hash":"a87609737b0b2b53c149842fc025a414e8f9986a07f0a8f97eeb2da04c7c65c7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":581,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"**1. User sends message:**","hash_alg":"sha256","hash":"88a445e0647f50eeccef52ad1905d3906460fc7575e896726d682ee06ef0357e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":582,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"code","lang":null,"md":"```\nFrontend ‚Üí POST /v1/conversations/:id/messages\n  ‚Üí Gateway\n    ‚Üí Check idempotency\n    ‚Üí Commit message.created to UBL (C.Messenger)\n    ‚Üí Call Office.ingest_message\n      ‚Üí Office analyzes message\n      ‚Üí Office decides: ProposeJob\n      ‚Üí Office creates job.created event\n      ‚Üí Office generates FormalizeCard\n      ‚Üí Office commits events to UBL (C.Jobs, C.Messenger)\n    ‚Üí Store idempotency record\n    ‚Üí Emit SSE delta: timeline.append\n  ‚Üí Frontend receives update\n  ‚Üí Job card appears in conversation\n```","hash_alg":"sha256","hash":"eb342965421d3f6225780dcb29b9d3098ea2d334f7aaba5642a23b8a3b1562c4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":583,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"**2. User approves job:**","hash_alg":"sha256","hash":"bc2eb4d28489c2b6c2c0bfcbe611e35ad237e87c4ce53de434c72a0c9269e14f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":584,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"code","lang":null,"md":"```\nFrontend ‚Üí POST /v1/jobs/:id/actions { action: \"job.approve\" }\n  ‚Üí Gateway\n    ‚Üí Check idempotency\n    ‚Üí Validate card provenance\n    ‚Üí Call Office.job_action\n      ‚Üí Office validates FSM (Proposed ‚Üí Approved)\n      ‚Üí Office requests permit from UBL\n      ‚Üí Office commits job.state_changed to UBL\n      ‚Üí Office begins job execution\n      ‚Üí Office commits job.started to UBL\n    ‚Üí Store idempotency record\n    ‚Üí Emit SSE delta: job.update\n  ‚Üí Frontend receives update\n  ‚Üí Job card updates to TrackingCard\n```","hash_alg":"sha256","hash":"cb8ef5b23bc7a5894045086391711c15d144e84f2caca9d8c8e1527bd2b76257"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":585,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"**3. Office executes job:**","hash_alg":"sha256","hash":"5e87d48cb83bdfdc25e90136d3fcac82190df18e7ae329d3d33b947e5fec3586"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":586,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"code","lang":null,"md":"```\nOffice\n  ‚Üí Build context frame\n    ‚Üí Query UBL for ledger state\n    ‚Üí Query recent events\n    ‚Üí Build memory\n    ‚Üí Query affordances\n    ‚Üí Generate narrative\n  ‚Üí Request permit from UBL\n  ‚Üí Start session\n  ‚Üí Call LLM with narrative\n  ‚Üí LLM responds with tool calls\n  ‚Üí Office executes tools\n    ‚Üí Record audit.tool_called\n    ‚Üí Execute tool\n    ‚Üí Record audit.tool_result\n  ‚Üí Stream progress updates\n  ‚Üí Commit job.progress to UBL\n  ‚Üí If approval needed: Commit approval.requested\n  ‚Üí On completion: Commit job.completed\n  ‚Üí Generate FinishedCard\n  ‚Üí Write handover\n  ‚Üí Commit session.completed\n```","hash_alg":"sha256","hash":"fffda1c08143f40599cb770663f6c203720a1584eaa051a709ed491e5735c603"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":587,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"**4. Projections update:**","hash_alg":"sha256","hash":"ab7c824e2eede18d2268ad60f953c3c0f0495337c7246eeb0febd511b84a9c34"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":588,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"code","lang":null,"md":"```\nUBL Kernel\n  ‚Üí Event committed to ledger\n  ‚Üí PostgreSQL NOTIFY fired\n  ‚Üí Projection updaters process event\n    ‚Üí Update projection_jobs\n    ‚Üí Update projection_job_events\n    ‚Üí Update projection_job_artifacts\n    ‚Üí Update projection_presence\n    ‚Üí Update projection_timeline_items\n  ‚Üí SSE handlers emit deltas\n  ‚Üí Frontend receives updates\n```","hash_alg":"sha256","hash":"0da934594d5b2cd612c2d78787992732f8bcbafa870787e61bacf4c9d1e77bec"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":589,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"**5. Frontend updates:**","hash_alg":"sha256","hash":"a9908bf38a33b042db54078a31d6d9d1248b9f27fa11bb014c51fbee403a02a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":590,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"code","lang":null,"md":"```\nFrontend\n  ‚Üí SSE event received: job.update\n  ‚Üí Update job state in UI\n  ‚Üí Update job card\n  ‚Üí Update presence indicators\n  ‚Üí If drawer open: Refresh timeline\n```","hash_alg":"sha256","hash":"f204eaa6fe4f8414c51a900f9e10928aa66e57ec063996a821631100011ee889"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":591,"path":["Three Systems Overview: UBL, Office, and Messenger","Complete System Integration","End-to-End Flow: User Message ‚Üí Job Completion"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":592,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance"],"block_kind":"heading","level":2,"text":"Security & Compliance","md":"## Security & Compliance","hash_alg":"sha256","hash":"1c26e69dcdae3a08bbc0272243410b30a275859f37937d5edc6136dda7977814"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":593,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"heading","level":3,"text":"PII Handling","md":"### PII Handling","hash_alg":"sha256","hash":"6df65947b5fd3cd126d241271ff62321d53a40bd5401956b67e6093b8d9c5e7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":594,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"paragraph","md":"**Detection:**","hash_alg":"sha256","hash":"48637e23a4724df09d4591ef7a091d78ca23538738ea70725401622a625c8d81"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":595,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"list","md":"- Regex patterns for SSN, credit card, phone\n- Policy engine checks before commit\n- Returns `RawPiiDetected` error if found","hash_alg":"sha256","hash":"9a7b38086b7fae8fde33d9a5757e37585e3ef9206e0a7afeb6ba8c8ffd0a0566"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":596,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"paragraph","md":"**Redaction:**","hash_alg":"sha256","hash":"0c0012d66a0cd544185d36a541757d398a0f147f114b822b2539416ad0661d0b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":597,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"list","md":"- Tool inputs/outputs sanitized\n- PII policy applied\n- Safety report tracks redactions","hash_alg":"sha256","hash":"9f8dd34fcf09705f56be76649f6ab6fe2d4c7e2be6f07ef8c178fa306727819d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":598,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"paragraph","md":"**Storage:**","hash_alg":"sha256","hash":"477298e71ffd6fa6594581aeccf045a792972dc1a5f2f543ac98b98a89f008a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":599,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","PII Handling"],"block_kind":"list","md":"- Message content stored separately (content_hash in ledger)\n- Only hash stored in ledger for privacy\n- Content retrieved on-demand","hash_alg":"sha256","hash":"0ea59fb8505e38571cc57a7d49b7c08faa8ae57fc9c26c8f672b32c424641415"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":600,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Audit Trail"],"block_kind":"heading","level":3,"text":"Audit Trail","md":"### Audit Trail","hash_alg":"sha256","hash":"baa21218587cf4af5a245d0d5fcb2fe50868d5c9bdf86a4ab4ab2ade66712227"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":601,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Audit Trail"],"block_kind":"paragraph","md":"**Complete Audit:**","hash_alg":"sha256","hash":"3b94084fca7347bd58c71c0031ad7cda3efc2e415fd3e531d73b109faa838302"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":602,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Audit Trail"],"block_kind":"list","md":"- Every tool call recorded (audit.tool_called)\n- Every tool result recorded (audit.tool_result)\n- Every decision recorded (audit.decision_made)\n- Every policy violation recorded (audit.policy_violation)","hash_alg":"sha256","hash":"a15812966b7071bf2f33c17161c86940649b0366dab42dad58b0c02875670778"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":603,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Audit Trail"],"block_kind":"paragraph","md":"**Audit Events:**","hash_alg":"sha256","hash":"7f5b1cbabc9261893d291fdeb7f9bbe7ed8f4efe94619745a5e653a1c66d3eb6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":604,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Audit Trail"],"block_kind":"list","md":"- Stored in C.Office container\n- Immutable (append-only)\n- Queryable via projections\n- Used for compliance and debugging","hash_alg":"sha256","hash":"68a21cb5dab0c8e280922b927a5404feef967c32900ac4b0fe63cda15c123311"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":605,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"heading","level":3,"text":"Idempotency","md":"### Idempotency","hash_alg":"sha256","hash":"7191a9276d586428a2a3e7cdd87950ca25b89b95d0256c8c2be8855d26140503"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":606,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"paragraph","md":"**Prevents:**","hash_alg":"sha256","hash":"c307e9db839e28eedb5226098cb2fa9e244b18fbf93fac0a0cd906331709f687"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":607,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"list","md":"- Duplicate message submissions\n- Duplicate job actions\n- Network retry duplicates","hash_alg":"sha256","hash":"d7d518db18666d25b3899702a470d23b9d154789a3b2600184736a237d997ce0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":608,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"paragraph","md":"**Implementation:**","hash_alg":"sha256","hash":"dd46077c017dbb7d28d8e60209e7ed7520a10d82804555979c3cde289e2d138b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":609,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"list","md":"- Client sends Idempotency-Key header\n- Gateway checks store\n- Returns cached response if exists\n- Stores response for future requests","hash_alg":"sha256","hash":"b6cffe0f9a52db826aa19cb48c0103bafc0d11058b35732bde0942d0ec0f8e4a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":610,"path":["Three Systems Overview: UBL, Office, and Messenger","Security & Compliance","Idempotency"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":611,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations"],"block_kind":"heading","level":2,"text":"Performance Optimizations","md":"## Performance Optimizations","hash_alg":"sha256","hash":"b08dec88359deba3fdb28eb2f4354bfd64c30c6097e69a2f0daf4f7827f17eb5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":612,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"heading","level":3,"text":"Projection Updates","md":"### Projection Updates","hash_alg":"sha256","hash":"0a764ceaeeddec2d9487ce8fb7b4535c70b9901d5943822be672d7df3ea518ef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":613,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"paragraph","md":"**Batch Processing:**","hash_alg":"sha256","hash":"c88249f0aae79b958fc0819ac8e212791ce5aa96e3ab4cededc7255870d2c669"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":614,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"list","md":"- Multiple events processed in single transaction\n- Reduces database round-trips","hash_alg":"sha256","hash":"5de61b88f8a27ded4e905510be4fb9d8d0eb3cdb288ec97ac3f89ee3d6290811"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":615,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"paragraph","md":"**Incremental Updates:**","hash_alg":"sha256","hash":"9dea54ee4004a461658cc57516be86a9cf90e40e6d9b28f89d364e7999a3b797"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":616,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"list","md":"- Only changed rows updated\n- ON CONFLICT DO UPDATE for upserts","hash_alg":"sha256","hash":"b25868697cc1a571868f0059d5aaa016aaa4e8188dc91f4bc1caf74cee2e567d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":617,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"paragraph","md":"**Indexes:**","hash_alg":"sha256","hash":"200ad5f2950bfb3f52a1c460d2e0de7dc5bf078af289b2460de7719e46b7d93a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":618,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Projection Updates"],"block_kind":"list","md":"- Optimized for common query patterns\n- Partial indexes for filtered queries","hash_alg":"sha256","hash":"6a123c358d6f529a225637ceb9cdf163eca6a9752928f9b6e2614cb29ece6f87"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":619,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"heading","level":3,"text":"SSE Streaming","md":"### SSE Streaming","hash_alg":"sha256","hash":"bcac3286b895081425870a9f31a97a6017ea83c2c03131b97585990759ec0e4b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":620,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"paragraph","md":"**Connection Pooling:**","hash_alg":"sha256","hash":"476f89be4a075003c1c7bd34557121dafd6a31320c283979aae0a9e9548c19bd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":621,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"list","md":"- Reuse connections for multiple clients\n- Reduces connection overhead","hash_alg":"sha256","hash":"7736c6dac8752da2e878dd75fa080ea29308e01430ef751cd640a4750b09bdc3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":622,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"paragraph","md":"**Event Batching:**","hash_alg":"sha256","hash":"923c2fa90041ffab2c721699c5680aa8f14d579e23bc6790a2343c75c3449d48"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":623,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"list","md":"- Batch multiple events in single SSE message\n- Reduces network overhead","hash_alg":"sha256","hash":"51a5d8da2dfa04865c0b8e831a1ce5cee5209f3ea8fd7c51926b7a06a1d6ef40"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":624,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"paragraph","md":"**Backpressure:**","hash_alg":"sha256","hash":"e58a973778e529f56226630900b7b745e17b8679343c4766ff72fbe798309f1e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":625,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","SSE Streaming"],"block_kind":"list","md":"- Client can signal when overwhelmed\n- Server can throttle if needed","hash_alg":"sha256","hash":"f16bb0fee3d069c2c1511c4348e9dc03727133b46a76da6cbf6b24fdf275e8f7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":626,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"heading","level":3,"text":"Memory Management","md":"### Memory Management","hash_alg":"sha256","hash":"43f66794b057b6630a10e8673ad70fecd4ce731d0f56f0b880ba2e7da7d1093f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":627,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"paragraph","md":"**Token Budget:**","hash_alg":"sha256","hash":"6c1713c0c40a1038c4ff4d16e9f9fc0644564213db38c2d4e6372a9ba9edd959"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":628,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"list","md":"- Enforced per session type\n- Memory compressed to fit budget\n- Prevents context overflow","hash_alg":"sha256","hash":"3ed32b1514458a55bdcd69333c17af295866fea666dc62d54eb8119a7577e7a5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":629,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"paragraph","md":"**Caching:**","hash_alg":"sha256","hash":"8fd8e0f335cf210d8dc95693fb6b0707d63f9463ff2e3ef5d658134093ec7665"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":630,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"list","md":"- Context frames cached when possible\n- Reduces UBL query load","hash_alg":"sha256","hash":"d41899c44f467e8864b56a209c6b4c974d4b8f189d4c6f5c6c88887fbc4dc9a7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":631,"path":["Three Systems Overview: UBL, Office, and Messenger","Performance Optimizations","Memory Management"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":632,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation"],"block_kind":"heading","level":2,"text":"Testing & Validation","md":"## Testing & Validation","hash_alg":"sha256","hash":"2827042878da1172024a7e8dca18d45bc67c8d95c07c3428d4a17b205bd87bb5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":633,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"heading","level":3,"text":"Unit Tests","md":"### Unit Tests","hash_alg":"sha256","hash":"45bca583f26a9445a42f21a8b789cb7bc2d40d3cf99c9764d3542d1a643969b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":634,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"paragraph","md":"**UBL Kernel:**","hash_alg":"sha256","hash":"fc3766f95200a1087c25cc061aa3465fc1ae36db2eb8bc1df1633a79b017646b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":635,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"list","md":"- Ledger append atomicity\n- Event validation\n- Projection updates\n- Policy evaluation","hash_alg":"sha256","hash":"b13118c631b9b7eac58afee0d8d4ba3e6fc84399fd005e99f662abf6bf3f2112"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":636,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"paragraph","md":"**Office:**","hash_alg":"sha256","hash":"796795b129ee90fb49b95ac5a8b2a896c73ffbddde9ff1f3979054f2aeb2e8c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":637,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"list","md":"- FSM transitions\n- Context building\n- Narrative generation\n- Handover creation","hash_alg":"sha256","hash":"a38abe18f71d25e81d15abec18f9b752aa5859a16fa987066b2f1688be166e20"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":638,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"paragraph","md":"**Messenger:**","hash_alg":"sha256","hash":"fcec15cb745588b033dab123c348c06703b7bb23b35ac3128ad16e818572eb5d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":639,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Unit Tests"],"block_kind":"list","md":"- Component rendering\n- State management\n- API calls\n- SSE handling","hash_alg":"sha256","hash":"5a6d18f6991ad18eee0335aeabb233ccea91e180e647ee0adb736c5a26e4fefd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":640,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Integration Tests"],"block_kind":"heading","level":3,"text":"Integration Tests","md":"### Integration Tests","hash_alg":"sha256","hash":"f3c491e59750b20b1254f9b081dcfdf9ca1d1b6803661d28d3ffe49205c9e5ef"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":641,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Integration Tests"],"block_kind":"paragraph","md":"**End-to-End:**","hash_alg":"sha256","hash":"b4ca1de6593041db917d9a1a38998e1ef70cf65469794c03ca0805025346ddbc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":642,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Integration Tests"],"block_kind":"list","md":"- Message ‚Üí Job ‚Üí Approval ‚Üí Execution\n- SSE streaming delivery\n- Projection updates\n- Idempotency handling","hash_alg":"sha256","hash":"bba0bd1b5f55bcdb106ea1f629d3b54673a30683fec678b5928a83a357bd4ae6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":643,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Integration Tests"],"block_kind":"paragraph","md":"**Permit Flow:**","hash_alg":"sha256","hash":"d654c678989de1c5b2c54e85580728aa5a164d296ec08ebdaf594c51c25e8ad0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":644,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Integration Tests"],"block_kind":"list","md":"- Permit request ‚Üí validation ‚Üí execution\n- Step-up authentication\n- Pact validation","hash_alg":"sha256","hash":"5c9bdb943fc861f76ee3823ba15b7a7bfba80d2590d81d1a3494b272f16c7653"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":645,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Performance Tests"],"block_kind":"heading","level":3,"text":"Performance Tests","md":"### Performance Tests","hash_alg":"sha256","hash":"c4361aa42064f0cac30e8bdebc2ea09646a4ecef0205a283fc95283e90e23a41"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":646,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Performance Tests"],"block_kind":"paragraph","md":"**Throughput:**","hash_alg":"sha256","hash":"bc78cf10f2a84fc024fdf91f59f7794c32b781c0e1bba1ab65efc2430af1b33f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":647,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Performance Tests"],"block_kind":"list","md":"- Ledger append under load\n- Projection update latency\n- SSE concurrent clients\n- LLM token budget enforcement","hash_alg":"sha256","hash":"c17213a64d0c094a9acb69606437fc302759ef925306982c2550ade135d63727"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":648,"path":["Three Systems Overview: UBL, Office, and Messenger","Testing & Validation","Performance Tests"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":649,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist"],"block_kind":"heading","level":2,"text":"Deployment Checklist","md":"## Deployment Checklist","hash_alg":"sha256","hash":"1dc1315c4214d0dc94c94eeb1e282b19b5676ff0c489328db304fd2c47f6b3d6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":650,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Prerequisites"],"block_kind":"heading","level":3,"text":"Prerequisites","md":"### Prerequisites","hash_alg":"sha256","hash":"06853ecee3d6e5f20a40c0d198df12313c0c9b1a182563a0014a7fb4945c7081"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":651,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Prerequisites"],"block_kind":"list","md":"- PostgreSQL 16+ with SERIALIZABLE isolation\n- Rust 1.75+ for UBL Kernel and Office\n- Node.js 20+ for Messenger frontend\n- WebAuthn-compatible browser","hash_alg":"sha256","hash":"0d24c2a0ec54fc4cf2cb99662818e57e57c06470d5e8c1d79bcc9b07d412ecf2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":652,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Database Setup"],"block_kind":"heading","level":3,"text":"Database Setup","md":"### Database Setup","hash_alg":"sha256","hash":"4d1e456a7bcfda9a59fff428fb02021c4379341ff0920105f09f10da1d445f2c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":653,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Database Setup"],"block_kind":"code","lang":"bash","md":"```bash\n# Create database\ncreatedb ubl_ledger\n\n# Apply migrations in order (see ubl/sql/MIGRATION_ORDER.txt)\npsql ubl_ledger -f ubl/sql/00_base/000_core.sql\npsql ubl_ledger -f ubl/sql/00_base/001_identity.sql\npsql ubl_ledger -f ubl/sql/00_base/002_policy.sql\npsql ubl_ledger -f ubl/sql/00_base/003_triggers.sql\npsql ubl_ledger -f ubl/sql/10_projections/100_console.sql\npsql ubl_ledger -f ubl/sql/10_projections/101_messenger.sql\npsql ubl_ledger -f ubl/sql/10_projections/102_office.sql\n```","hash_alg":"sha256","hash":"e21484ff249e79be3225652af92b79b806b2841f3865cd30c7f2264efaa56552"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":654,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"heading","level":3,"text":"Environment Variables","md":"### Environment Variables","hash_alg":"sha256","hash":"cf47b598f19e2ab5c3a60c13e61a54b2a5a531397397306826f70b68854f94b2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":655,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"paragraph","md":"**UBL Kernel:**","hash_alg":"sha256","hash":"fc3766f95200a1087c25cc061aa3465fc1ae36db2eb8bc1df1633a79b017646b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":656,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"code","lang":"bash","md":"```bash\nDATABASE_URL=postgres://user:pass@localhost/ubl_ledger\nUBL_SERVER_PORT=8080\n```","hash_alg":"sha256","hash":"f2d3c2f4a463e72b1e27c38fb2d19b3c0c0a11486237f6543e85dd10c99ce807"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":657,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"paragraph","md":"**Office:**","hash_alg":"sha256","hash":"796795b129ee90fb49b95ac5a8b2a896c73ffbddde9ff1f3979054f2aeb2e8c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":658,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"code","lang":"bash","md":"```bash\nOFFICE__LLM__API_KEY=sk-...\nOFFICE__UBL__ENDPOINT=http://localhost:8080\nOFFICE__UBL__CONTAINER_ID=C.Office\n```","hash_alg":"sha256","hash":"8a54d2fb1a2d11a45cf1382833b248bbb0c6f7a6a4a5d03e5872df9a12a01ba8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":659,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"paragraph","md":"**Messenger Frontend:**","hash_alg":"sha256","hash":"eed96bcc85c1117eb46e043bd9c0f39b913fef1df1fc470e4c211a89290993be"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":660,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Environment Variables"],"block_kind":"code","lang":"bash","md":"```bash\nVITE_UBL_URL=http://localhost:8080\nVITE_TENANT_ID=T.UBL\n```","hash_alg":"sha256","hash":"27fdc1044ad6d6df59a26a3e8d95266f5acd5b2f9c0b2a727a35035f02039f76"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":661,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Health Checks"],"block_kind":"heading","level":3,"text":"Health Checks","md":"### Health Checks","hash_alg":"sha256","hash":"f237f5de3ec2655c39769299e79baf49d9252486963a3ae407653d8ecfa760c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":662,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Health Checks"],"block_kind":"code","lang":"bash","md":"```bash\n# UBL Kernel\ncurl http://localhost:8080/health\n\n# Office\ncurl http://localhost:8081/health\n\n# Messenger (via browser)\nhttp://localhost:3000\n```","hash_alg":"sha256","hash":"c94097bbdbd13da69e426230e614db4031227bdfabc1aeb9f0a6732df9cf6793"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":663,"path":["Three Systems Overview: UBL, Office, and Messenger","Deployment Checklist","Health Checks"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":664,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting"],"block_kind":"heading","level":2,"text":"Troubleshooting","md":"## Troubleshooting","hash_alg":"sha256","hash":"659a188b36f9c3262a28539e24c345df4edc9657f59b116b0a1d9887cf2e28e0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":665,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"heading","level":3,"text":"Common Issues","md":"### Common Issues","hash_alg":"sha256","hash":"464440c1054feec9fbfcec1e9afb7c9125db27e6ea35fa46bcda5baf73646e07"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":666,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**SSE Connection Drops:**","hash_alg":"sha256","hash":"8e12290ded796c6133dfb015e0fa51d0abb714401059a2dedcdeaf79e0f52a44"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":667,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Check PostgreSQL LISTEN/NOTIFY is working\n- Verify firewall allows SSE connections\n- Check client reconnection logic","hash_alg":"sha256","hash":"449df39b4cb086dc9d44094cf46d68e605890dccf4bb94399ae069a923fc12dd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":668,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**Projection Updates Delayed:**","hash_alg":"sha256","hash":"7787b6a8b3637b21bcbc1dfbcd85f97f7c27fc4b04d747e84c84fd0ae5f6a4fb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":669,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Check PostgreSQL trigger is firing\n- Verify projection updaters are running\n- Check for database locks","hash_alg":"sha256","hash":"e524ab65e1d4ac33fb2301d40773938adc5651ab01c24b385cc7cbd99d12e8ba"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":670,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**Idempotency Conflicts:**","hash_alg":"sha256","hash":"2bcf95a9fc4861c69f7e7a237f8b408036d9316581c5b398db76f13f65b1f59f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":671,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Check idempotency key format\n- Verify store is not full\n- Check for duplicate requests","hash_alg":"sha256","hash":"0a1cf50dc2fbaf79cf2003cdec239d3f5ed2c267b843a293a8574447c712e2e8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":672,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**Policy Violations:**","hash_alg":"sha256","hash":"6771712c923b23ee48c60557e082d986eeb1afc4e8d4b7aa4fce619fe14c03aa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":673,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Check Policy Pack is loaded\n- Verify event format matches schema\n- Check FSM transitions are valid","hash_alg":"sha256","hash":"9a872f6d6eff991c4076213cc0cc47cef6253edd102bceb9eccfec5b1abd21a3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":674,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**Tool Audit Missing:**","hash_alg":"sha256","hash":"76022348b6de2d6ae24fb9f14f9fe90b66510cb02d9cefd4e2d050fbc38715f2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":675,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Verify `tool.called` exists before `tool.result`\n- Check UBL client is committing events to C.Office\n- Verify `container_id` is `C.Office` (not C.Jobs or C.Messenger)\n- Check `tool_call_id` matches between call and result\n- Verify idempotency key format is correct","hash_alg":"sha256","hash":"c225b59295009673b14b47df7d412ac1d9f1134746a9c33b9da55c1cf4de7aa8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":676,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**SSE Not Receiving Updates:**","hash_alg":"sha256","hash":"ed120ab7f09b67302db8c8705c5aca9c8d42990b7baf235db58c0a456de6ded6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":677,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Check browser console for connection errors\n- Verify `Last-Event-ID` header is being sent on reconnection\n- Check PostgreSQL LISTEN/NOTIFY is working (`SELECT pg_listening_channels()`)\n- Verify projection updaters are running (check logs)\n- Check firewall/proxy isn't blocking SSE connections","hash_alg":"sha256","hash":"118092b51ab191257e374b3cb91901e5d7bca4b4fe9cb799e0f0feafaec1e8d6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":678,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"**Job State Not Updating:**","hash_alg":"sha256","hash":"fb03481bbbc1b34444012db855dcfce1d937443e57fc945c7108c44092d9e6f5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":679,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"list","md":"- Verify FSM transition is valid (check allowed transitions)\n- Check Office is committing `job.state_changed` events\n- Verify projection updater processed the event\n- Check job_id matches between frontend and backend\n- Verify tenant_id is consistent across requests","hash_alg":"sha256","hash":"04ab59e0496e6c3d7cb400c3c2210a0246439f09aab3631158035de4ece4ffa4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":680,"path":["Three Systems Overview: UBL, Office, and Messenger","Troubleshooting","Common Issues"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":681,"path":["Three Systems Overview: UBL, Office, and Messenger","Document Statistics"],"block_kind":"heading","level":2,"text":"Document Statistics","md":"## Document Statistics","hash_alg":"sha256","hash":"5df5b2a98d2338c6cebbe9277020aa83b489e46457e101fad77db8be96512876"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":682,"path":["Three Systems Overview: UBL, Office, and Messenger","Document Statistics"],"block_kind":"list","md":"- **Total Lines**: ~3,800\n- **Sections**: 18 major sections\n- **Code Examples**: 50+ code snippets\n- **API Endpoints**: 40+ documented endpoints\n- **Data Structures**: 30+ schemas documented\n- **Components**: 15+ React components\n- **Hooks**: 5+ custom React hooks\n- **Projections**: 10+ projection tables\n- **Event Types**: 30+ event types documented","hash_alg":"sha256","hash":"997e0ed019678a6352df03ea7550cc662e2a1436b20bae68f7903eb3fa063f4b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":683,"path":["Three Systems Overview: UBL, Office, and Messenger","Document Statistics"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":684,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"heading","level":2,"text":"Conclusion","md":"## Conclusion","hash_alg":"sha256","hash":"be031d37bb75d96ef08ca9ec5b0e83bb6f91172f60d3c31a78feae8d7dc4a0b0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":685,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"This comprehensive documentation covers all three systems (UBL, Office, Messenger) in depth, including:","hash_alg":"sha256","hash":"6887cb0e4e1d178ecdac71bb32253f5c12cf52845e62ba8a9dd3dc6bf2422b4a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":686,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"list","md":"- **Architecture**: High-level design and principles\n- **Implementation**: Detailed code-level explanations\n- **Data Structures**: Complete schemas and formats\n- **Integration**: End-to-end flows and patterns\n- **Security**: PII handling, audit trails, idempotency\n- **Performance**: Optimizations and best practices\n- **Operations**: Deployment, testing, troubleshooting","hash_alg":"sha256","hash":"99817704a20907f990ffb64dc82d0922a636f7dd69ac3ee9cd564ab4062927cf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":687,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"The system is production-ready and provides a solid foundation for building verifiable, auditable, and AI-safe applications.","hash_alg":"sha256","hash":"6362a60bc4912139afc8eff520938ad0c3bfd8d9ff0da1d8a5f4e5e6f6692409"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":688,"path":["Three Systems Overview: UBL, Office, and Messenger","Conclusion"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":689,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture"],"block_kind":"heading","level":2,"text":"Final Deep Dive: Complete System Architecture","md":"## Final Deep Dive: Complete System Architecture","hash_alg":"sha256","hash":"c4ef878d45cd8b6cc8824d10ab36ce971142b02182dd13e39a984dfae7fbe44f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":690,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive"],"block_kind":"heading","level":3,"text":"Frontend Architecture Deep Dive","md":"### Frontend Architecture Deep Dive","hash_alg":"sha256","hash":"ebef85826ec858e64c49407f5df73e0605afbf9f9cb815bfcf9234b925cd26a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":691,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","Component Hierarchy"],"block_kind":"heading","level":4,"text":"Component Hierarchy","md":"#### Component Hierarchy","hash_alg":"sha256","hash":"bf0eb822fa935340cbadfa0e3a518d4f19cd7256f51918162f5ea4d47cb08be7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":692,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","Component Hierarchy"],"block_kind":"code","lang":null,"md":"```\nApp (Root)\n‚îú‚îÄ‚îÄ AuthProvider (Global Auth State)\n‚îÇ   ‚îú‚îÄ‚îÄ WebAuthn Registration/Login\n‚îÇ   ‚îú‚îÄ‚îÄ Session Management\n‚îÇ   ‚îî‚îÄ‚îÄ Demo Mode Support\n‚îú‚îÄ‚îÄ ToastProvider (Notifications)\n‚îú‚îÄ‚îÄ ErrorBoundary (Error Handling)\n‚îî‚îÄ‚îÄ Routes\n    ‚îú‚îÄ‚îÄ LoginPage (Public)\n    ‚îÇ   ‚îú‚îÄ‚îÄ WebAuthn Passkey UI\n    ‚îÇ   ‚îú‚îÄ‚îÄ Registration Flow\n    ‚îÇ   ‚îî‚îÄ‚îÄ Demo Mode Toggle\n    ‚îú‚îÄ‚îÄ ChatPage (Protected)\n    ‚îÇ   ‚îú‚îÄ‚îÄ Sidebar\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Conversation List\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Entity Presence Indicators\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ \"Needs You\" Badges\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ New Workstream Button\n    ‚îÇ   ‚îú‚îÄ‚îÄ ChatView\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Message List\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Message Bubbles\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JobCardRenderer\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FormalizeCard\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TrackingCard\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FinishedCard\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Action Buttons\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Typing Indicators\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Input Area\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Ledger Status\n    ‚îÇ   ‚îú‚îÄ‚îÄ JobDrawer (Slide-out)\n    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JobTimeline\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Event List\n    ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ State Transitions\n    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ JobArtifacts\n    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Files\n    ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Links\n    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Records\n    ‚îÇ   ‚îî‚îÄ‚îÄ WelcomeScreen (Empty State)\n    ‚îî‚îÄ‚îÄ SettingsPage (Protected)\n```","hash_alg":"sha256","hash":"d3fbcd8c48414ad6ff21bb2167c3c5dda66dffd147af1842d9b2f315ab643c92"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":693,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"heading","level":4,"text":"State Management","md":"#### State Management","hash_alg":"sha256","hash":"d26760fe8bc04585ef67d5f772f3de204a3a509a7ec5835ba5e4037e8486ffdb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":694,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"paragraph","md":"**AuthContext:**","hash_alg":"sha256","hash":"1484deb13d0d3da1f24f99b550934eda50403e94aae3079434d0e841a3a223b5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":695,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"list","md":"- `user`: Current authenticated user\n- `isAuthenticated`: Boolean auth state\n- `isLoading`: Auth check in progress\n- `isDemoMode`: Demo mode flag\n- `supportsWebAuthn`: Browser capability\n- `registerPasskey()`: WebAuthn registration\n- `loginWithPasskey()`: WebAuthn login\n- `loginDemo()`: Demo mode activation\n- `logout()`: Session cleanup","hash_alg":"sha256","hash":"5d813dbf1aaa9f70805445378079abf933761e07c6e60c148c4a9758fc6d7b8f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":696,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"paragraph","md":"**useSSE Hook:**","hash_alg":"sha256","hash":"fb8b2f863b1b455522e0819027e8b893a7aedf29a6e4574da421855db36f2e1b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":697,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"list","md":"- Subscribes to Gateway SSE stream (`/v1/stream`)\n- Handles delta events (message.created, job.*, presence.*)\n- Updates local state optimistically\n- Reconciles with confirmed events","hash_alg":"sha256","hash":"3c82f48b128c99f219e021024cdcc15bc63d872f9532ce3f8d96a0a4db65a00c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":698,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"paragraph","md":"**useOptimistic Hook:**","hash_alg":"sha256","hash":"ba56c03c08b32be3abe9447dfe5c8a52d7cfabb2a758b05abf42adfdc7072ef7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":699,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"list","md":"- Applies UI updates immediately\n- Tracks pending updates with IDs\n- Confirms updates when SSE arrives\n- Rolls back on errors\n- Timeout handling (30s default)","hash_alg":"sha256","hash":"7fc0d51b3786f0342c40ec71d7d2fd1cf2bac930335f768005e926ad2edd5e96"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":700,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"paragraph","md":"**useJobs Hook:**","hash_alg":"sha256","hash":"ab502500c07ebcab46282ce8226e29e5660f2a174914c1b5e8446dc91d90c677"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":701,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","State Management"],"block_kind":"list","md":"- Fetches jobs from API\n- Subscribes to WebSocket job updates\n- Provides CRUD operations\n- Filters by conversation","hash_alg":"sha256","hash":"28258b1fb1da39d2d2ab3b4c87c000664b77a06af126286ea385c9ee2feb6f5c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":702,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"heading","level":4,"text":"API Client Architecture","md":"#### API Client Architecture","hash_alg":"sha256","hash":"9cd96baf8e41fa9ab4f1bacccc926361a6f7b17dcc23a32e174565218e6323db"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":703,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"paragraph","md":"**apiClient.ts:**","hash_alg":"sha256","hash":"92a15b52c7aff39a87e423b5868f9b84b6448d786bacd0157b3b4230b582684a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":704,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"list","md":"- Base HTTP client with error handling\n- Token management from localStorage\n- Base URL configuration\n- Network service integration\n- Automatic retry logic","hash_alg":"sha256","hash":"317f4d33ff18af0e43ec055c2008b541fbba1eba68f2cfc0149f7b8626236898"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":705,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"paragraph","md":"**ublApi.ts:**","hash_alg":"sha256","hash":"8a1af1cdd09ad9e5314b6901a75ec980925e23e9d27a00bc877ae616f62f6931"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":706,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"list","md":"- Bootstrap endpoint (initial state)\n- Message sending (legacy + Gateway)\n- Job actions (approve/reject)\n- Timeline queries\n- Job details for drawer\n- Entity listing","hash_alg":"sha256","hash":"841cfcacbec324da581e51368e506c2200a99046245ef8ade649e0bbe409dcb2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":707,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"paragraph","md":"**jobsApi.ts:**","hash_alg":"sha256","hash":"8be841187fd6a627154d1998d8be851a86c24d80142901ea82373c297c561cdd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":708,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"list","md":"- Job CRUD operations\n- WebSocket subscription\n- Real-time job updates\n- Approval workflows","hash_alg":"sha256","hash":"ed93a098e3b6eadc2e96d10e5ecd07894b74a7c2d6afbbcd3a578b5b034de34b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":709,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"paragraph","md":"**sse.ts:**","hash_alg":"sha256","hash":"e12d232ad1f6f4bb2ccd9430876d92b9566c3a535b109d8e283ff8b72462c125"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":710,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Frontend Architecture Deep Dive","API Client Architecture"],"block_kind":"list","md":"- Gateway SSE client\n- Event parsing and routing\n- Reconnection logic\n- Heartbeat handling","hash_alg":"sha256","hash":"d68579fe2ef5dec0734628e7de6d214f4036a93926ebc9ffb1ec3442a4d7a9f0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":711,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System"],"block_kind":"heading","level":3,"text":"Authentication & Identity System","md":"### Authentication & Identity System","hash_alg":"sha256","hash":"990a0b00c3ab17b48f7fd9e16baa0e153e16ff3f4d5a69c936b41302ce3254aa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":712,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"heading","level":4,"text":"WebAuthn Passkey Flow","md":"#### WebAuthn Passkey Flow","hash_alg":"sha256","hash":"77624f4267e9a8da2a944f4b2c505f8291a2c674cc2d919fb963ca70d9d2251d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":713,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"paragraph","md":"**Registration:**","hash_alg":"sha256","hash":"cd5c6b38d4b7a7146d42406deb1a846d108a1029d3d94e4bf12ad1d8f9b9320f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":714,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"list","md":"1. User enters username + display name\n2. Frontend calls `/id/register/begin`\n3. Server returns challenge + WebAuthn options\n4. Browser calls `navigator.credentials.create()`\n5. User authenticates (biometric/password)\n6. Frontend sends attestation to `/id/register/finish`\n7. Server validates and creates `id_subjects` record\n8. Server creates `id_credentials` record (passkey)\n9. Server creates session token\n10. Frontend stores token in localStorage","hash_alg":"sha256","hash":"635a1eff344021278d452f3efa3a3edda826b500ac237e28db97fbbd33660ac4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":715,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"paragraph","md":"**Login:**","hash_alg":"sha256","hash":"8f241c884a95bc3b5d20cadc67769e40d2fdaeb41b58733611f24d785c77fb43"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":716,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"list","md":"1. User enters username\n2. Frontend calls `/id/login/begin`\n3. Server returns challenge + WebAuthn options\n4. Browser calls `navigator.credentials.get()`\n5. User authenticates\n6. Frontend sends assertion to `/id/login/finish`\n7. Server validates assertion\n8. Server creates session token\n9. Frontend stores token","hash_alg":"sha256","hash":"c5d85487d0ef8e2f799487f42c18ed13ab7f99455ea8f19963629d6c78f696fc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":717,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"paragraph","md":"**Step-Up Authentication:**","hash_alg":"sha256","hash":"f68229f7ca4ccb3dc6f7ca2ada2dd993ddf8039a1ca3acdd0636e97569f39aba"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":718,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","WebAuthn Passkey Flow"],"block_kind":"list","md":"- Required for L4/L5 permits\n- Challenge bound to permit's `binding_hash`\n- Stored in `id_stepup_challenges` table\n- 90-second TTL\n- Validated before permit issuance","hash_alg":"sha256","hash":"a8796961d542e042ae484c25ef135024048c3a739510035c27258f82eca5b56c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":719,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"heading","level":4,"text":"Identity Database Schema","md":"#### Identity Database Schema","hash_alg":"sha256","hash":"21294faa0d1db112964216575d0677dc04183ba8081ce363e3f3f3de2d1dba29"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":720,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"paragraph","md":"**id_subjects:**","hash_alg":"sha256","hash":"53feee84e663cffc19a1c8154144e0df404e688bf430ec855ced2ee3c39d6760"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":721,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"list","md":"- `sid`: Subject ID (primary key)\n- `kind`: \"person\" | \"llm\" | \"app\"\n- `display_name`: Human-readable name\n- `created_at_ms`: Timestamp","hash_alg":"sha256","hash":"f20795c3ecfa97b4b570dfbed58c2602dd29d924e3fecde3f4af4e25d7b05518"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":722,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"paragraph","md":"**id_credentials:**","hash_alg":"sha256","hash":"d719f3c5f40313cb28a55aa761f850bd8bfe425d506dc848c5b596bf8011029d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":723,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"list","md":"- `credential_id`: Unique credential ID\n- `subject_sid`: Foreign key to id_subjects\n- `credential_kind`: \"webauthn\" | \"asc\"\n- `public_key`: Serialized credential\n- `created_at_ms`: Timestamp","hash_alg":"sha256","hash":"a4ef451975e8b1d57963e7203707df5062e8cbcc86ebdf4f9cd1a80ce438060c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":724,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"paragraph","md":"**id_sessions:**","hash_alg":"sha256","hash":"5d223a1d2a7a4d3df51ccf743677b99ea5172c688d3565a08e126306d30646a5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":725,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"list","md":"- `session_id`: Unique session ID\n- `subject_sid`: Foreign key\n- `token_hash`: Hashed session token\n- `created_at_ms`: Timestamp\n- `expires_at_ms`: Expiration","hash_alg":"sha256","hash":"c12818f8c4d69eb2235db5bf45c173b2bdf50b60e820085dd2dcc068d35ff40c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":726,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"paragraph","md":"**id_stepup_challenges:**","hash_alg":"sha256","hash":"9ac1680db0e1b224106587f2a92c6637921311695466f0ac2cd44f51d04a0f36"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":727,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Identity Database Schema"],"block_kind":"list","md":"- `challenge_id`: Unique challenge ID\n- `user_id`: Subject ID\n- `binding_hash`: Permit binding hash\n- `challenge_b64`: Base64 challenge\n- `auth_state`: Serialized WebAuthn state\n- `created_at_ms`: Timestamp\n- `exp_ms`: Expiration\n- `used`: Boolean flag","hash_alg":"sha256","hash":"ac03e5a5cf9aaa3a2e9c115420392e712e8fa158d49c483ece24fc4f08251a6f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":728,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Agent Signing Certificates (ASC)"],"block_kind":"heading","level":4,"text":"Agent Signing Certificates (ASC)","md":"#### Agent Signing Certificates (ASC)","hash_alg":"sha256","hash":"08fdf0de28d3cc7e59c2ba98bc5ed19967d46cfd0ee5488c159b40604d6a2ee3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":729,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Agent Signing Certificates (ASC)"],"block_kind":"paragraph","md":"**Issue ASC:**","hash_alg":"sha256","hash":"ad1c7d56acac3c1b505996c2b9cf6db4c94dff7ae6d0c2d9fefb034e0d09ea3e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":730,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Agent Signing Certificates (ASC)"],"block_kind":"list","md":"- POST `/id/asc/issue`\n- Request specifies:\n  - `containers`: Allowed container IDs\n  - `intent_classes`: Allowed intent classes\n  - `max_delta`: Maximum physics delta\n  - `ttl_secs`: Time to live\n- Server signs ASC with admin key\n- Returns ASC with signature","hash_alg":"sha256","hash":"d3dff857abeacce432178f9f19766d2835f2bf117d98dc960ac8aed9744c3fdf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":731,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Agent Signing Certificates (ASC)"],"block_kind":"paragraph","md":"**ASC Validation:**","hash_alg":"sha256","hash":"56bb65a9a3a52093021b67c6feefcb87704850d1f39fef19bc2ee54213960166"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":732,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Authentication & Identity System","Agent Signing Certificates (ASC)"],"block_kind":"list","md":"- Check signature with admin public key\n- Verify `not_before` and `not_after` timestamps\n- Check container/intent_class scopes\n- Validate physics_delta limit","hash_alg":"sha256","hash":"fec31e82823230d8c7f3587eddb032c1a686d3dbc5c75f151bddc8ff514e9197"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":733,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System"],"block_kind":"heading","level":3,"text":"LLM Provider System","md":"### LLM Provider System","hash_alg":"sha256","hash":"6bd4b982d5b3dab8ba63ff4e0c4f5fccef7035317bdd2c9031f167513a2c1ead"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":734,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Trait"],"block_kind":"heading","level":4,"text":"Provider Trait","md":"#### Provider Trait","hash_alg":"sha256","hash":"cb2a4ef6634f0b5b72c4123b50a965bcb67d24d69699b878c637674089222cb1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":735,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Trait"],"block_kind":"code","lang":"rust","md":"```rust\npub trait LlmProvider: Send + Sync {\n    fn name(&self) -> &str;\n    async fn chat(&self, request: LlmRequest) -> Result<LlmResponse>;\n    async fn complete(&self, prompt: &str, max_tokens: u32) -> Result<String>;\n    async fn is_available(&self) -> bool;\n}\n```","hash_alg":"sha256","hash":"c54c31440967f5a2e4a5bade180336b1ebb777961cde0f8d2a9cc0fd8aa6f58b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":736,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Request/Response Types"],"block_kind":"heading","level":4,"text":"Request/Response Types","md":"#### Request/Response Types","hash_alg":"sha256","hash":"532d1676e6998c51a901e7b7f4bb175d9282df3e37871c6af5547127c3a80758"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":737,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Request/Response Types"],"block_kind":"paragraph","md":"**LlmRequest:**","hash_alg":"sha256","hash":"a6dbabe1b12b89df97ce365cf4752f67ad11b11213ac3851b781ca7e5c1bf7fa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":738,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Request/Response Types"],"block_kind":"list","md":"- `messages`: Vec<LlmMessage> (system/user/assistant)\n- `max_tokens`: u32\n- `temperature`: f32 (0.0-1.0)\n- `stop_sequences`: Vec<String>\n- `system`: Option<String>","hash_alg":"sha256","hash":"10abcf29846654c1f956eb3f51237674cfdc34ef11544085f0b5d3c5447ce0f4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":739,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Request/Response Types"],"block_kind":"paragraph","md":"**LlmResponse:**","hash_alg":"sha256","hash":"2b95bb39df6aab29ae11a0fa519473c4f2dcebb53cef57de0080994f575ad681"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":740,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Request/Response Types"],"block_kind":"list","md":"- `content`: String (generated text)\n- `finish_reason`: String\n- `usage`: LlmUsage (input/output/total tokens)\n- `model`: String","hash_alg":"sha256","hash":"c7efd81432fd221636a8718ddce46606b7963fe3e7c2f626aa3a1f12cffda9dc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":741,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"heading","level":4,"text":"Provider Implementations","md":"#### Provider Implementations","hash_alg":"sha256","hash":"ee6434170cc865e83495ff3749e46eba1e31ee2636574d68e888da1cb8977acb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":742,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"paragraph","md":"**AnthropicProvider:**","hash_alg":"sha256","hash":"3bd1204bc0879017a932f9b0614f0ee0b72a13b6f7ee3b593271b3e8c4c947cc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":743,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"list","md":"- Model: Claude (claude-3-opus, claude-3-sonnet, claude-3-haiku)\n- API: Anthropic Messages API v1\n- System prompt support (separate from messages)\n- Stop sequences (configurable)\n- Temperature control (0.0-1.0)\n- Max tokens (up to 4096 for most models)\n- Streaming support (planned for v2)\n- Function calling (planned for v2)","hash_alg":"sha256","hash":"2d25e8368fb24d4075176f29979be1707ffca3236377d61c97c15c4b714f344f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":744,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"paragraph","md":"**OpenAIProvider:**","hash_alg":"sha256","hash":"c5d78fa85d4d7b0eed507f534e7899247ace9a761b3b434100c8fa28d0980e3d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":745,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"list","md":"- Model: GPT-4, GPT-4-turbo, GPT-3.5-turbo\n- API: OpenAI Chat Completions v1\n- System message in messages array (first message with role=\"system\")\n- Temperature control (0.0-2.0)\n- Max tokens (up to 4096 for GPT-3.5, 8192 for GPT-4)\n- Function calling (planned for v2)\n- Streaming support (planned for v2)","hash_alg":"sha256","hash":"f86c4e08ff51d302bd4abd68f94fa08180bc77d398a3c8fded33c987aef21caf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":746,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"paragraph","md":"**SmartRouter:**","hash_alg":"sha256","hash":"f6759d40e5ab0b34efa018172152a80e85c00b40f5c1bc49d31dad56a74332b1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":747,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","LLM Provider System","Provider Implementations"],"block_kind":"list","md":"- Routes requests to optimal provider based on multiple factors\n- Considers:\n  - Task type (coding, writing, analysis, creative, quick, complex)\n  - Entity preferences (if specified)\n  - Cost/speed tradeoffs (prefer_speed, prefer_economy flags)\n  - Provider availability (health checks)\n  - Latency constraints (max_latency_ms)\n  - Cost constraints (max_cost_cents)\n- Provider profiles with scoring (0-100 per task type)\n- Preference-based routing (explicit provider selection)\n- Fallback to default provider if preferred unavailable\n- Scoring formula: `base_score √ó speed_modifier √ó economy_modifier`","hash_alg":"sha256","hash":"256cf026f98d0d5e1bddb4fad215e2825d254f65384ca286a9bd91c740343ea4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":748,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management"],"block_kind":"heading","level":3,"text":"Entity Lifecycle Management","md":"### Entity Lifecycle Management","hash_alg":"sha256","hash":"197a28ddd75b544ec57aa781df9519dc613825ba0baa3aa575d312649205ec1c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":749,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Types"],"block_kind":"heading","level":4,"text":"Entity Types","md":"#### Entity Types","hash_alg":"sha256","hash":"4d820a5a438ade3da03184930f1cbf41987c68b4414c610084c98db67be5bd2f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":750,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Types"],"block_kind":"paragraph","md":"**EntityType:**","hash_alg":"sha256","hash":"7d6491ce8e040404a4d2a59294a0a07d9ed80dfa80c484e0d3d769e2fb0c37b5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":751,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Types"],"block_kind":"list","md":"- `Guarded`: Human-supervised, restricted\n- `Autonomous`: Full authority, standard limits\n- `Development`: Relaxed limits for testing","hash_alg":"sha256","hash":"3f803f40e77b31a5c822503eea907085df2caec16fe08bd60bf13cd6f7628a73"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":752,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Repository"],"block_kind":"heading","level":4,"text":"Entity Repository","md":"#### Entity Repository","hash_alg":"sha256","hash":"8888f8b3411a149bd6781445256c12ca01d9fafb237fb93e519278db9611fc78"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":753,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Repository"],"block_kind":"paragraph","md":"**EntityRepository:**","hash_alg":"sha256","hash":"eaf36a6d4bd71b579fed42d7da2337923abeac21641a30cddc915c71572c8341"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":754,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Repository"],"block_kind":"list","md":"- Stores entities in UBL (C.Office container)\n- In-memory cache for performance\n- Event sourcing (replay events to rebuild state)\n- Methods:\n  - `get_or_create()`: Load or create entity\n  - `get()`: Load from ledger\n  - `create_entity()`: Create new entity\n  - `update_constitution()`: Update behavior rules\n  - `update_baseline()`: Update baseline narrative\n  - `record_session()`: Record session completion","hash_alg":"sha256","hash":"12654c0cf43f9a13fa3b01f26522732af306e86bc8045c2518f63453311412d5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":755,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Repository"],"block_kind":"paragraph","md":"**Entity Events:**","hash_alg":"sha256","hash":"7294289ddc51d92c9f4de9d63fcf8bfc538cd13ec8a3e806e90b19c96bccc68b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":756,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Repository"],"block_kind":"list","md":"- `entity.created`: Initial creation\n- `constitution.updated`: Behavior change\n- `baseline.updated`: Narrative update (from dreaming)\n- `session.completed`: Session finished\n- `entity.suspended`: Temporarily disabled\n- `entity.activated`: Re-enabled\n- `entity.archived`: Permanently disabled","hash_alg":"sha256","hash":"b1a0fca7aa81f4fd97045af4b25c7c6967d7ab770ef5706b946eb7f744f1c15a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":757,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Identity"],"block_kind":"heading","level":4,"text":"Entity Identity","md":"#### Entity Identity","hash_alg":"sha256","hash":"80f821eba8eae5198d218b38d7cb2cd1740ff661f3aee24d25a6ca5078e618b8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":758,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Identity"],"block_kind":"paragraph","md":"**KeyPair:**","hash_alg":"sha256","hash":"072d8f6345a9ea84d985da7e406c2360a279d675c8917f116b8a1d7bf0523144"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":759,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Identity"],"block_kind":"list","md":"- Ed25519 signing key\n- Public key for verification\n- Sign messages for UBL commits\n- Key rotation support","hash_alg":"sha256","hash":"08ca77f6e7401d16219e1b02d30f4ffa8dd42e3626dea918aceaecb5eb5ec858"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":760,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Identity"],"block_kind":"paragraph","md":"**Identity:**","hash_alg":"sha256","hash":"7044ab18bfabc2bef64498a6ee9805f67f802271a39b72fe431b951646cadf0b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":761,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Entity Lifecycle Management","Entity Identity"],"block_kind":"list","md":"- `public_key_hex`: Public key (hex)\n- `key_version`: Version for rotation\n- `created_at`: Timestamp\n- `private_key_ref`: Encrypted reference (production)","hash_alg":"sha256","hash":"71fb2a458eaa1eeed0dfe973ecf2768373a42fb7643392eae7ab9cb98a6b3507"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":762,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management"],"block_kind":"heading","level":3,"text":"Session & Token Management","md":"### Session & Token Management","hash_alg":"sha256","hash":"86d3715d57d54edd5a90dc45ecd09eca30a0d18df8127a2fcdc7e0d86e2f50fa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":763,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Session Types"],"block_kind":"heading","level":4,"text":"Session Types","md":"#### Session Types","hash_alg":"sha256","hash":"cca1ae692374d714a5d13e509492bc53faef7df386d518f1bba3fc47458b133f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":764,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Session Types"],"block_kind":"paragraph","md":"**SessionType:**","hash_alg":"sha256","hash":"3d9c97244438cb995739fc4c51f13b5084441eb93a70146051ade3c85c0f8396"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":765,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Session Types"],"block_kind":"list","md":"- `Work`: Autonomous work (5000 tokens)\n- `Assist`: Help human (4000 tokens)\n- `Deliberate`: Explore options (8000 tokens)\n- `Research`: Information gathering (6000 tokens)","hash_alg":"sha256","hash":"42a9170971ed0ba58d9781dc806481d89ef406d6802cc239881711b55d1b7242"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":766,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Session Types"],"block_kind":"paragraph","md":"**SessionMode:**","hash_alg":"sha256","hash":"f058e78dd25ef68f736d27e164ed46734f5ec2ead82d2d6f9b99b21f2e5bb87a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":767,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Session Types"],"block_kind":"list","md":"- `Commitment`: Binding actions\n- `Deliberation`: Draft actions","hash_alg":"sha256","hash":"14efc9a7fe793ef1ef21a7fc08be61e0950b3f6552a4487e3451f0bac6c72249"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":768,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"heading","level":4,"text":"Token Budget System","md":"#### Token Budget System","hash_alg":"sha256","hash":"0e91a4c87a5355254ba7bf8f314ab2fa6482e336270cece2d2e89323ea727158"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":769,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"paragraph","md":"**TokenQuota:**","hash_alg":"sha256","hash":"fa4f42240f70c35925e0da15e0e74d7b6309326d199f885790d7c803ad172e8f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":770,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"list","md":"- Daily limit (varies by entity type)\n- Session limits per type\n- Soft limit (80% warning)\n- Hard limit (95% stop)","hash_alg":"sha256","hash":"418d6bfa45ea20606e6de1453e10b1c64e05ef01fb9651debf655f630a620dd7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":771,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"paragraph","md":"**TokenBudget:**","hash_alg":"sha256","hash":"16f2e8334e2db2d3fe78f44aeda2f17fe4bac9440f93466ab3964c042874ce03"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":772,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"list","md":"- Tracks daily usage\n- Tracks session usage\n- Automatic daily reset\n- Usage history (last 100 sessions)\n- Statistics API","hash_alg":"sha256","hash":"3e83fe622a63fb459eb9f2602b91a4afa7aba9d591e70431e969cd3e850dbe98"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":773,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"paragraph","md":"**Entity Token Types:**","hash_alg":"sha256","hash":"9317749834479094c854ec4679e435b89ac059abf69d7e26dfa3309240ea8b01"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":774,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"list","md":"- `Guarded`: 50K daily, lower session limits (Work: 3000, Assist: 2500, Deliberate: 5000, Research: 4000)\n- `Autonomous`: 100K daily, standard limits (Work: 5000, Assist: 4000, Deliberate: 8000, Research: 6000)\n- `Development`: 500K daily, higher limits (Work: 10000, Assist: 8000, Deliberate: 15000, Research: 12000)","hash_alg":"sha256","hash":"22c0e5e6c55832c6ba67858c18fd6fee859aaa29013ae071484e3537fb391364"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":775,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"paragraph","md":"**Token Budget Enforcement:**","hash_alg":"sha256","hash":"d688fdc14002c7dbd9acd009ca314abe6dc4bef97f560859773fbd41427642ad"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":776,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Token Budget System"],"block_kind":"list","md":"- Soft limit warning at 80% of daily limit\n- Hard limit stop at 95% of daily limit\n- Session limits enforced per session type\n- Effective remaining = min(daily_remaining, session_remaining)\n- Automatic daily reset at midnight UTC","hash_alg":"sha256","hash":"bd599ca9331536b9762f94315697444b18eedc24367e95a412998beb4b740f36"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":777,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Instance Management"],"block_kind":"heading","level":4,"text":"Instance Management","md":"#### Instance Management","hash_alg":"sha256","hash":"bfc22967aab6df51f62a6cd58e8d9f36e06515c42091a8b94fa02dca9a4ef01c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":778,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Instance Management"],"block_kind":"paragraph","md":"**Instance:**","hash_alg":"sha256","hash":"78c27e2ac64f58455dea65ffbd2ce0556d92b78c4b52137224ec950f42e3fc75"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":779,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Instance Management"],"block_kind":"list","md":"- Ephemeral LLM execution\n- Status: Initializing ‚Üí Processing ‚Üí Waiting ‚Üí Completed/Failed/Cancelled\n- Token consumption tracking\n- Context frame reference\n- Handover on completion","hash_alg":"sha256","hash":"f77c8d80bdd4f51390f015fc10848018183180e9e7d313482a6e2a710b6c3c59"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":780,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Instance Management"],"block_kind":"paragraph","md":"**Instance Lifecycle:**","hash_alg":"sha256","hash":"74961f1884310c149c7520ca4b241af71dd694acbff06f68e59984ac079d813b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":781,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Session & Token Management","Instance Management"],"block_kind":"list","md":"1. Create instance with token budget\n2. Set context frame\n3. Start processing\n4. Consume tokens per LLM call\n5. Complete with handover or fail with error","hash_alg":"sha256","hash":"c5efd3fa5c158b6e94b346e4544f9a8cc93ed4d6d1501aa8fb3b38b5820d04a5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":782,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement"],"block_kind":"heading","level":3,"text":"Governance & Constitution Enforcement","md":"### Governance & Constitution Enforcement","hash_alg":"sha256","hash":"d6f0366c97e2654e9566c9d73eca2a91d4da01dde75fa55e106c6432c8641e57"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":783,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"heading","level":4,"text":"Constitution Structure","md":"#### Constitution Structure","hash_alg":"sha256","hash":"053af0a3ae01a77817ae0566e6354f77aa580e5d8e45edcbbd8f135b533f4a1a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":784,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"paragraph","md":"**OfficeConstitution:**","hash_alg":"sha256","hash":"6beacdc8fb7318d23ed241aaf1f232e89f9781501a765e3692c537f499158038"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":785,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"list","md":"- `version`: Constitution version\n- `precedence`: \"UBL > Office\" (Office can only restrict)\n- `allow_modes`: Mode configurations\n- `pre_flight`: Pre-flight checks\n- `denylists`: Blocked job types/targets\n- `bindings_required`: Required permit bindings","hash_alg":"sha256","hash":"1df4bd710282c838e3475ab0a3ce8814d92965901bed00a39e9b712575b2a6bf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":786,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"paragraph","md":"**ModeConfig:**","hash_alg":"sha256","hash":"abaed22e561abd7057cc9fe016654aab731ee08f7a7d4a0b536bf8ac0cb0a6bf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":787,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"list","md":"- `max_risk`: Maximum risk level (L0-L5)\n- `require_step_up`: Step-up auth required","hash_alg":"sha256","hash":"3986d599c46962d5ce54b7e52174a5961e7372442648b4b0cc50b5f880db8e17"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":788,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"paragraph","md":"**PreFlightConfig:**","hash_alg":"sha256","hash":"eb7f8fc5cbfd474d68c4f44425d1e8f3ccc07946c356012b6a27baf38a1d612f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":789,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"list","md":"- `require_diff_for`: Job types requiring diff preview\n- `maintenance_windows`: Time-based blocks","hash_alg":"sha256","hash":"ed1adb95a636c57c47409074d5f002939b67cce91518fc8a08bd9682c234edfa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":790,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"paragraph","md":"**Denylists:**","hash_alg":"sha256","hash":"8a6aa34b8bb6f82817760a6c8c3f508e8c6b1817dcc55a2dc05d0b0dc4dc4590"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":791,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Structure"],"block_kind":"list","md":"- `job_types`: Blocked job types\n- `targets`: Blocked target systems","hash_alg":"sha256","hash":"3342bab5de84e8334e1e0ee9a6755108a7067c0d04a60340828cb764c97daa27"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":792,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Enforcement"],"block_kind":"heading","level":4,"text":"Constitution Enforcement","md":"#### Constitution Enforcement","hash_alg":"sha256","hash":"be27c82c261988fe31ed45b2ee4d26ef21474dd857321a1f267dc2c0d6be4901"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":793,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Enforcement"],"block_kind":"paragraph","md":"**ConstitutionEnforcer:**","hash_alg":"sha256","hash":"2bc7522818494623aeacde2e104cfa12f9e369c1f7827b7aa5e8c2ce1036e826"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":794,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Constitution Enforcement"],"block_kind":"list","md":"- Runs BEFORE UBL permit request\n- Checks:\n  1. Denylists (job type, target)\n  2. Risk level for mode\n  3. Step-up requirement\n  4. Pre-flight requirements (diff)\n  5. Maintenance windows\n- Returns `ConstitutionError` on violation\n- Office can only RESTRICT, never ALLOW more than UBL","hash_alg":"sha256","hash":"c9c424edc4c7eb5a131d26117452912257eb92222b5f2a6733fbe9fef5daa1cb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":795,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Provenance Validation"],"block_kind":"heading","level":4,"text":"Provenance Validation","md":"#### Provenance Validation","hash_alg":"sha256","hash":"5c12ef2634752d8881d2cce460aaca070cac5821491395b19d5ec24eda1677b0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":796,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Provenance Validation"],"block_kind":"paragraph","md":"**ProvenanceValidator:**","hash_alg":"sha256","hash":"a89c2c1d5828c2f61199fe113933c884cebe08e9ec9e59c8497c7ff5d21629bd"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":797,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Governance & Constitution Enforcement","Provenance Validation"],"block_kind":"list","md":"- Validates button clicks from job cards\n- Requirements:\n  1. Card exists in ledger (card_id)\n  2. Button exists in card (button_id)\n  3. Action type matches button declaration\n  4. Input provided if required\n- Prevents:\n  - Forged approvals\n  - Replayed buttons\n  - Invented actions","hash_alg":"sha256","hash":"415680b6ebb41dc34851d35f254f5e1850bf1530d79998c74408869914cac1b0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":798,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference"],"block_kind":"heading","level":3,"text":"Complete API Reference","md":"### Complete API Reference","hash_alg":"sha256","hash":"3151a4726d11d25a1d153f82ac9a3f751eb83ac3aba83afed3341d53b2d5d978"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":799,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"heading","level":4,"text":"UBL Kernel Endpoints","md":"#### UBL Kernel Endpoints","hash_alg":"sha256","hash":"2b2020c7ca6fadaf77412f5849c24715eecc355c3be15b7eca28ae83a0675fe3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":800,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"paragraph","md":"**Ledger:**","hash_alg":"sha256","hash":"c5ecd3b646939ba66777e7d2041d92e83d85ea53ac52e0d149143723e6402857"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":801,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"list","md":"- `POST /link/commit`: Commit link to ledger\n- `GET /ledger/:container_id/tail`: SSE stream\n- `GET /state/:container_id`: Get container state\n- `GET /atom/:hash`: Fetch atom by hash","hash_alg":"sha256","hash":"f0bc53c7997f6b6d1c5c3e2da0b571f08ad98825d8b79b41cb17ca2c5e3dda32"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":802,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"paragraph","md":"**Identity:**","hash_alg":"sha256","hash":"7044ab18bfabc2bef64498a6ee9805f67f802271a39b72fe431b951646cadf0b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":803,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"list","md":"- `POST /id/register/begin`: Start WebAuthn registration\n- `POST /id/register/finish`: Complete registration\n- `POST /id/login/begin`: Start WebAuthn login\n- `POST /id/login/finish`: Complete login\n- `GET /id/whoami`: Get current user\n- `POST /id/asc/issue`: Issue Agent Signing Certificate\n- `POST /id/stepup/begin`: Start step-up auth\n- `POST /id/stepup/finish`: Complete step-up auth","hash_alg":"sha256","hash":"7ede8bb5a8688ce9dd7f071faa5fd6fefc712a52251789ab4a25226c15edfb0f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":804,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"paragraph","md":"**Messenger Boundary:**","hash_alg":"sha256","hash":"6430ea70836b2c3385b38b51506d16810edca9030fc3d93e6cdf4b4c4b70b86b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":805,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"list","md":"- `GET /messenger/bootstrap`: Initial state\n- `GET /messenger/entities`: List entities\n- `GET /messenger/conversations`: List conversations\n- `POST /messenger/conversations`: Create conversation\n- `POST /messenger/messages`: Send message\n- `POST /messenger/jobs/:id/approve`: Approve job\n- `POST /messenger/jobs/:id/reject`: Reject job","hash_alg":"sha256","hash":"34b096569c78904d7be8e20f3c78a9f90f03888d922a3a70521d71a3413fc8d8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":806,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"paragraph","md":"**Messenger Gateway:**","hash_alg":"sha256","hash":"4b1136a82a87c6d8ab8f820bea0d77d726464c57d33546b5748e6eaa45ae7503"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":807,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"list","md":"- `POST /v1/conversations/:id/messages`: Send message via Gateway (idempotent)\n- `POST /v1/jobs/:id/actions`: Job action via Gateway (idempotent, validates provenance)\n- `GET /v1/conversations/:id/timeline`: Get timeline (cursor-based pagination)\n- `GET /v1/jobs/:id`: Get job details (includes timeline + artifacts)\n- `GET /v1/stream`: SSE delta stream (real-time updates)","hash_alg":"sha256","hash":"f4ea8055e3d778a2315eedfbdc2ebdf866b43f3b56bed5e294227183936750e6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":808,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"paragraph","md":"**Projections:**","hash_alg":"sha256","hash":"b6ef8eb1fba10ad6d8a7495c4aacd1c8378332384e93700cf62c2cbd3a952901"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":809,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","UBL Kernel Endpoints"],"block_kind":"list","md":"- `GET /query/jobs`: Query jobs (filter by state, owner, conversation)\n- `GET /query/conversations/:id/messages`: Query messages (cursor pagination)\n- `GET /query/office/entities`: Query Office entities (filter by type, status)\n- `GET /query/office/sessions`: Query Office sessions (filter by entity, status)\n- `GET /query/office/handovers`: Query handovers (filter by entity, session)\n- `GET /query/office/audit`: Query audit log (filter by entity, job, event_type)","hash_alg":"sha256","hash":"cbce7ea0d0238ddd630bec9b9ba26acc09e0d63f4e0e9d388226c29e1057504f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":810,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"heading","level":4,"text":"Office Endpoints","md":"#### Office Endpoints","hash_alg":"sha256","hash":"bfe3349cafd07bd8d29d07ccba9edd135e9de2542fa30740702023d0c628c431"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":811,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Entities:**","hash_alg":"sha256","hash":"229f346e590446380b15264cd29b251b402304270b936f7ccaf8d0d3b066f68f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":812,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /entities`: Create entity\n- `GET /entities`: List entities\n- `GET /entities/:id`: Get entity\n- `DELETE /entities/:id`: Archive entity","hash_alg":"sha256","hash":"ff67e0c750a556679c57d6f3a51a2f92071887a58b2d3ea1ab82b3aa72a5d4e0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":813,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Sessions:**","hash_alg":"sha256","hash":"393ccc42c543c54cf1981806cfc873c092c61ee60e5c97fc56979bf0b8164fb9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":814,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /entities/:id/sessions`: Create session\n- `GET /entities/:id/sessions/:sid`: Get session\n- `DELETE /entities/:id/sessions/:sid`: End session\n- `POST /entities/:id/sessions/:sid/message`: Send message","hash_alg":"sha256","hash":"680ae5cb4951129bea83412cc733d8bbb0042876bb425b2e4dc2e49056b190d0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":815,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Dreaming:**","hash_alg":"sha256","hash":"d84357f717a02d8d4cc9a0711b4442711494192bf16765833752a97794d057db"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":816,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /entities/:id/dream`: Trigger dreaming cycle\n- `GET /entities/:id/memory`: Get memory","hash_alg":"sha256","hash":"7290908c61fec4900704a2a899c196058a0632a4670d071dbcc1ebffe899d345"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":817,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Constitution:**","hash_alg":"sha256","hash":"93db611170d61af661a9a223f7cad10a46188a00ca88df49d08bae878e249211"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":818,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /entities/:id/constitution`: Update constitution\n- `GET /entities/:id/constitution`: Get constitution","hash_alg":"sha256","hash":"fe24f1a179774fa391829bebd4fcaab3fd9cfdc4f9c9c5970d9dc1b0a0b61e73"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":819,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Jobs:**","hash_alg":"sha256","hash":"be0f4898138a522564a982c692e6f78266ba77cac503fda1eef258202dd36537"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":820,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /jobs/execute`: Execute job\n- `POST /jobs/execute/stream`: Execute job (SSE)\n- `GET /jobs/:job_id/status`: Get job status","hash_alg":"sha256","hash":"0f23ebde698314948421d20394b50eeba9fd1025972981bee86f9bbdb33d8f0e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":821,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"paragraph","md":"**Gateway:**","hash_alg":"sha256","hash":"f538870ab56c8a2aaf918ed9db567651c7309b0e84a3add42d17d8c027318e53"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":822,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete API Reference","Office Endpoints"],"block_kind":"list","md":"- `POST /v1/office/ingest_message`: Ingest message from Gateway\n- `POST /v1/office/job_action`: Handle job action from Gateway","hash_alg":"sha256","hash":"76d14142baf0a04c57d9dfb9ebfbfa5d068c86627dee1508c0f1825208c28a88"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":823,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation"],"block_kind":"heading","level":3,"text":"WebSocket Implementation","md":"### WebSocket Implementation","hash_alg":"sha256","hash":"c6f97054418c819ee7bff4c1fc662cf92568620d7c13c67b8b34064c10dcc2d1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":824,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation","Office WebSocket"],"block_kind":"heading","level":4,"text":"Office WebSocket","md":"#### Office WebSocket","hash_alg":"sha256","hash":"d8eb6e5e5e30ff660133934b3c89952ceb20c1dafb11780128549aa00035aa2a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":825,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation","Office WebSocket"],"block_kind":"paragraph","md":"**Message Types:**","hash_alg":"sha256","hash":"65e238fa11ebeb6ec61d9765c99997d0e5af797ab1d87d5c8a5ee6dd8b21feb0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":826,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation","Office WebSocket"],"block_kind":"list","md":"- `Subscribe { entity_id }`: Subscribe to entity updates\n- `Unsubscribe { entity_id }`: Unsubscribe\n- `SessionStarted { session_id, entity_id }`: Session started\n- `SessionEnded { session_id, entity_id }`: Session ended\n- `MessageReceived { session_id, content }`: Message received\n- `TokenUsage { session_id, used, remaining }`: Token update\n- `Error { message }`: Error notification\n- `Ping`/`Pong`: Keep-alive","hash_alg":"sha256","hash":"36cb943a588a853b027265853b9e3eec6239df9a5aae265093fb350419b90f93"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":827,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation","Office WebSocket"],"block_kind":"paragraph","md":"**Connection Flow:**","hash_alg":"sha256","hash":"42a72a1c1a05b5075c5867a374f615ad2c4c4dd7ddad75d36924c70d931e2891"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":828,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","WebSocket Implementation","Office WebSocket"],"block_kind":"list","md":"1. Client upgrades HTTP to WebSocket\n2. Server spawns receive task\n3. Client sends Subscribe messages\n4. Server broadcasts updates to subscribers\n5. Client sends Unsubscribe on disconnect","hash_alg":"sha256","hash":"523e562c49a544fcd510cd090ccfee42198b8668538fbce68dbe52c1f2223e3e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":829,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns"],"block_kind":"heading","level":3,"text":"Optimistic UI Patterns","md":"### Optimistic UI Patterns","hash_alg":"sha256","hash":"fa461e1a437e02f3f0782bb111feb089fa7511f7a4dd3a9f5ec129cf9734df91"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":830,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimistic Hook"],"block_kind":"heading","level":4,"text":"useOptimistic Hook","md":"#### useOptimistic Hook","hash_alg":"sha256","hash":"d78b40bd60d3c4cc5ce0a882949d8ce85da283ec92c65c71067596b4dce7ddd2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":831,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimistic Hook"],"block_kind":"paragraph","md":"**Features:**","hash_alg":"sha256","hash":"70e8c0620ab245f5fe9a92bd416ed777907b3cea1cd6f54efeece70c6f4f0b23"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":832,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimistic Hook"],"block_kind":"list","md":"- Immediate UI updates\n- Pending update tracking\n- Automatic confirmation via SSE\n- Rollback on errors\n- Timeout handling (30s default)\n- Toast notifications","hash_alg":"sha256","hash":"5c41b2d9c50dbeba4d304be9bb7a71234284bd891eb83bc46fdd5fdfbe1be9eb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":833,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimistic Hook"],"block_kind":"paragraph","md":"**Usage:**","hash_alg":"sha256","hash":"cddc67027f6082a58f2fcb4c853a7d380000ac6bfe6b50d9ea955664d1b94c0a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":834,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimistic Hook"],"block_kind":"code","lang":"typescript","md":"```typescript\nconst { data, applyOptimistic, confirmUpdate, revertUpdate } = useOptimistic<Job[]>([]);\n\n// Apply optimistic update\nconst updateId = applyOptimistic(\n  jobs.map(j => j.id === jobId ? { ...j, status: 'approved' } : j)\n);\n\n// SSE confirms\nsse.on('job.updated', (event) => {\n  confirmUpdate(event.updateId);\n});\n\n// Error rollback\ncatch (e) {\n  revertUpdate(updateId, e.message);\n}\n```","hash_alg":"sha256","hash":"62251a3b061623a6d237b1a80daa7501f2a44a6679a16d8aaa84606d11330a08"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":835,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticList Hook"],"block_kind":"heading","level":4,"text":"useOptimisticList Hook","md":"#### useOptimisticList Hook","hash_alg":"sha256","hash":"f033026b2af248e1d9df8935db02eb721ff537b2aad73dd0d2b2a3320cbd0bff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":836,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticList Hook"],"block_kind":"paragraph","md":"**Specialized for lists:**","hash_alg":"sha256","hash":"0c4af64d802c7133706d4a81c8a2104da5777fb394fb0d14618e93dbc7014f3a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":837,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticList Hook"],"block_kind":"list","md":"- `updateItem(id, updates)`: Update single item\n- `addItem(item)`: Add item\n- `removeItem(id)`: Remove item","hash_alg":"sha256","hash":"38df84ea99d963974e4bad8aed55566b8cb7e9a7081d884199d00ea404113d64"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":838,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticMutation Hook"],"block_kind":"heading","level":4,"text":"useOptimisticMutation Hook","md":"#### useOptimisticMutation Hook","hash_alg":"sha256","hash":"d1dcb13aac05ea2c1ecaa560c0c33513de706abf6f933748f8b30c6b128386c4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":839,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticMutation Hook"],"block_kind":"paragraph","md":"**Combines optimistic updates with API calls:**","hash_alg":"sha256","hash":"1a9378582efb80a179af20737ca01a56708b7d44e069941abdc88c3ea8898a7c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":840,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Optimistic UI Patterns","useOptimisticMutation Hook"],"block_kind":"list","md":"- Applies optimistic update\n- Calls mutation function\n- Confirms or reverts based on result","hash_alg":"sha256","hash":"0c54debd218375f827c16058000ae082ed19aa83fa89948c8a49d482c238633e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":841,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library"],"block_kind":"heading","level":3,"text":"Complete Component Library","md":"### Complete Component Library","hash_alg":"sha256","hash":"b29d7e4f7525f14d6bd446a110ee639fa03388f0766b3e43021118a179df67d8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":842,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"heading","level":4,"text":"Core Components","md":"#### Core Components","hash_alg":"sha256","hash":"42773116aa8d3699363da7ffa99012ad45519243904f0136f04825d7ff6ad216"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":843,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**ChatView:**","hash_alg":"sha256","hash":"50b2d07d460b99d312f8d740d87efb6c6ea9cfd4b91853367a48eb178500c544"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":844,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Message rendering\n- Job card integration\n- Typing indicators\n- Auto-scroll\n- Input handling\n- Ledger status display","hash_alg":"sha256","hash":"a6fa47a1065dee16d3e60c968a3e2b7b946aa2e5c197d8426202b877828c35b3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":845,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**Sidebar:**","hash_alg":"sha256","hash":"b38033cbee8603c36aff53295ee7265f64c7c4df969591631baa6fe7b01cb733"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":846,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Conversation list\n- Entity presence\n- \"Needs You\" badges\n- \"Working\" indicators\n- New workstream button","hash_alg":"sha256","hash":"204000221aaafd278feaeeccf0e2c193d64a7b02cf511ef647b71ff240680d8e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":847,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**JobCardRenderer:**","hash_alg":"sha256","hash":"7654474e360fc02999db1111e9dea047282584b5524adbe5800d1d9d391a95bb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":848,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Card type detection\n- Button rendering\n- Action handling\n- View details button\n- State visualization","hash_alg":"sha256","hash":"c5fb4264eac52dcd5e7085895bf1206d504f0f4dd39aeea54c5bd72438745a71"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":849,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**JobDrawer:**","hash_alg":"sha256","hash":"0f74a56f5c483feecec2a262182cc1666b983684ae58a0f550af2f4408830513"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":850,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Slide-out panel\n- Job timeline\n- Artifacts list\n- Action buttons\n- Close handler","hash_alg":"sha256","hash":"1f583279851f58effb8053787d0c4686ff6dcb7e7a36ea9fa631ff153d497a70"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":851,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**JobTimeline:**","hash_alg":"sha256","hash":"0ea07053b5d5003db848f81a982a2d670132d7fcb266c10e8fba9323f655e7bc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":852,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Event list\n- State transitions\n- Timestamps\n- Actor information","hash_alg":"sha256","hash":"9bd74017634f0188a58104c0de7669457f19b6677677eedf2e4a49574b2f7324"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":853,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**JobArtifacts:**","hash_alg":"sha256","hash":"38591c9290f0a345b2328487c66de4c8ec66c69bb19c3559e643713129d4ac06"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":854,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- File list\n- Link list\n- Record list\n- Open/copy actions","hash_alg":"sha256","hash":"17b007f7c43045c3da9a36b5fbe03ca070fc521cbbb92741a49157a19bd5aa19"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":855,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**WelcomeScreen:**","hash_alg":"sha256","hash":"ac8ab197dd4ad78d7f17cad9d92da1e58e04e3b330dac7fa282ae6be0121dd45"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":856,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Empty state\n- Recent conversations\n- New workstream button\n- Statistics display","hash_alg":"sha256","hash":"0393d8ee2283497d8a33fec244caa3c9abd12e50034b7c56d86ac5fb83f75761"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":857,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**NewWorkstreamModal:**","hash_alg":"sha256","hash":"554e613790bbcb1be30d960948ee1a17b1f9491bb8ae56845c0e5895eb6d5506"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":858,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Entity selection\n- Group creation\n- Participant selection\n- Name input","hash_alg":"sha256","hash":"fa3ce6cf375f2f3c40cb4f27a62a90bcaa50ae3bee206160161a8e6ff396dbfa"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":859,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**EntityProfileModal:**","hash_alg":"sha256","hash":"ae5089e674a337a35ad873c268a12ac9a261db9815a83536295fd3c3c00ef0bb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":860,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- Entity details\n- Status indicator\n- Statistics\n- Start chat button","hash_alg":"sha256","hash":"7828db7ab0fd0cff4470031084e1c8dddbce22637b32f3fe87145923f2572187"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":861,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"paragraph","md":"**LoginPage:**","hash_alg":"sha256","hash":"71b82301514457437f0d3acbb466e53207ff0500d710f5240d8be04671414ce8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":862,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Complete Component Library","Core Components"],"block_kind":"list","md":"- WebAuthn registration\n- WebAuthn login\n- Demo mode toggle\n- Beautiful UI","hash_alg":"sha256","hash":"f034218c41619e23f0c6e4c1a435901059670653e8deee86b0c5490c1e2be41f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":863,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Data Flow Diagrams"],"block_kind":"heading","level":3,"text":"Data Flow Diagrams","md":"### Data Flow Diagrams","hash_alg":"sha256","hash":"1945fa449f3b86e0fd23543757354855dc2c653f07eedbc7df90a2fb025058e7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":864,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Data Flow Diagrams","Message Send Flow"],"block_kind":"heading","level":4,"text":"Message Send Flow","md":"#### Message Send Flow","hash_alg":"sha256","hash":"e0316f8d3817b4513b5a19d9cce896ab7a6d28bcdb919795e0815b1c85f717bf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":865,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Data Flow Diagrams","Message Send Flow"],"block_kind":"code","lang":null,"md":"```\nUser Types Message\n    ‚Üì\nChatView.onSendMessage()\n    ‚Üì\nublApi.sendMessageViaGateway()\n    ‚Üì\nPOST /v1/conversations/:id/messages\n    ‚Üì\nGateway Routes Handler\n    ‚îú‚îÄ‚Üí Check Idempotency\n    ‚îú‚îÄ‚Üí Commit to UBL (C.Messenger)\n    ‚îú‚îÄ‚Üí Store Message Content\n    ‚îú‚îÄ‚Üí Call Office.ingest_message()\n    ‚îÇ   ‚îú‚îÄ‚Üí Office decides: Reply or ProposeJob\n    ‚îÇ   ‚îú‚îÄ‚Üí If ProposeJob: Generate FormalizeCard\n    ‚îÇ   ‚îî‚îÄ‚Üí Emit events to UBL\n    ‚îî‚îÄ‚Üí Store Idempotency Record\n    ‚Üì\nSSE Delta Emitted\n    ‚Üì\nFrontend useSSE Hook\n    ‚Üì\nOptimistic Update Confirmed\n    ‚Üì\nUI Updated\n```","hash_alg":"sha256","hash":"29d6ff38ce37c81867996567f47b3e4eebcdc6599402f16019ac10a40212161c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":866,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Data Flow Diagrams","Job Approval Flow"],"block_kind":"heading","level":4,"text":"Job Approval Flow","md":"#### Job Approval Flow","hash_alg":"sha256","hash":"36b4760e2fdab6f29c4d098b6751ef0f33f9590919cc0f653160a36abf9ad34a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":867,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Data Flow Diagrams","Job Approval Flow"],"block_kind":"code","lang":null,"md":"```\nUser Clicks Approve Button\n    ‚Üì\nJobCardRenderer.onAction('approve')\n    ‚Üì\nublApi.jobActionViaGateway()\n    ‚Üì\nPOST /v1/jobs/:id/actions\n    ‚Üì\nGateway Routes Handler\n    ‚îú‚îÄ‚Üí Check Idempotency\n    ‚îú‚îÄ‚Üí Validate Card Provenance\n    ‚îî‚îÄ‚Üí Call Office.job_action()\n        ‚îú‚îÄ‚Üí Validate Button Exists in Card\n        ‚îú‚îÄ‚Üí Update Job FSM (Proposed ‚Üí Approved)\n        ‚îú‚îÄ‚Üí Emit job.state_changed to UBL\n        ‚îî‚îÄ‚Üí Generate TrackingCard\n    ‚Üì\nSSE Delta Emitted\n    ‚Üì\nFrontend useSSE Hook\n    ‚Üì\nJob State Updated\n    ‚Üì\nJobCardRenderer Re-renders\n```","hash_alg":"sha256","hash":"bd514218c5aa416d2e03052f21943d662f8acb703326d2ee90b31f760dca175c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":868,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture"],"block_kind":"heading","level":3,"text":"Security Architecture","md":"### Security Architecture","hash_alg":"sha256","hash":"fa7d47fd4fded9d0f991e6cdeda627528660266ad58ec5e67a59c5661582acad"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":869,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"heading","level":4,"text":"Multi-Layer Security","md":"#### Multi-Layer Security","hash_alg":"sha256","hash":"2c84ed5f8c4e242b73f04215cd4350ae4e9877157760b9d78e8ac4107d2d8d65"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":870,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 1: WebAuthn Authentication**","hash_alg":"sha256","hash":"26b4d66ce30db1561b20bc8fdc65814bd17044f32c6133c5c9ce12344700a04d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":871,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- Passkey-based login\n- No passwords stored\n- Biometric authentication\n- Session tokens","hash_alg":"sha256","hash":"c5934807920c26fbe205d5a185565d545c6b61d3c36201522951f035d1876694"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":872,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 2: Agent Signing Certificates**","hash_alg":"sha256","hash":"cf849bab5ed8baf3dcc0dc528c18c0372dbdf585deaf101ba0f38c11eb91a357"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":873,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- Scoped permissions\n- Time-bound validity\n- Signature verification\n- Container/intent restrictions","hash_alg":"sha256","hash":"25ccc1a6e996db122e34e54d79471b657cde46738b3bf61971fa28efcdf6092d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":874,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 3: Step-Up Authentication**","hash_alg":"sha256","hash":"bdd07490fbfc7d21480f833d925805a02f5610e3fba1d2eb09f237802f0cc5c5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":875,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- Required for high-risk actions\n- Challenge bound to permit\n- Additional verification\n- Audit trail","hash_alg":"sha256","hash":"f30b8ddec2ea5a5bcb2ff34799838461ebf972f344aeaa74f04a21e57bc190cc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":876,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 4: Policy Pack Enforcement**","hash_alg":"sha256","hash":"4316455de669315f70658d1075a8b53b74795db889178d1759aa3930bb848c76"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":877,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- FSM validation\n- Card provenance\n- PII protection\n- Tool pairing","hash_alg":"sha256","hash":"6b1f4ab94da9a64815f411c5123171bcbdbf53c8b846b36fe11b1617874c76d1"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":878,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 5: Constitution Enforcement**","hash_alg":"sha256","hash":"0e6816bf1e654a89b7d5afbcc5e109a0aeb35c4a58e6f3879fcec2f364aa2290"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":879,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- Office-specific rules\n- Denylists\n- Pre-flight checks\n- Maintenance windows","hash_alg":"sha256","hash":"2e3548f6b6c0e8538df0f81d155300439d5a0c3b5277f97d3eb155252670dfbc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":880,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"paragraph","md":"**Layer 6: Pact Validation**","hash_alg":"sha256","hash":"5a0ddd6e5f2c7fa0045695d5e77b5cb14e267a5bcfce10f25dd6091dfb69c6de"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":881,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Security Architecture","Multi-Layer Security"],"block_kind":"list","md":"- Multi-signature requirements\n- Physics delta limits\n- Time-bound validity\n- Signature verification","hash_alg":"sha256","hash":"878939784ac3ab36c929d36d56a4d2644f08780240eb2d1f2dfff892dea50eab"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":882,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations"],"block_kind":"heading","level":3,"text":"Performance Optimizations","md":"### Performance Optimizations","hash_alg":"sha256","hash":"269666cb249f406347e6d3adea42d9a91f1f5c20986abd9d4cda2508be0d629c"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":883,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"heading","level":4,"text":"Frontend","md":"#### Frontend","hash_alg":"sha256","hash":"ff14b4a14f77269e65be18f84bebb48161dd93f4ab5416a481e580a2e2295443"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":884,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"paragraph","md":"**Code Splitting:**","hash_alg":"sha256","hash":"2091e3b7f902508a8569e6c07451ccea1f8e87a69bcc4df4de47a172f25f2507"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":885,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"list","md":"- Lazy-loaded routes\n- Component-level splitting\n- Dynamic imports","hash_alg":"sha256","hash":"bca34fdf84f9b5d830199aecc6f7aba820712dc2ca9925ce4c9a45e2cf70f946"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":886,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"paragraph","md":"**Optimistic Updates:**","hash_alg":"sha256","hash":"c407c38300c7ac8a70b3c738c0fdbd503c1914937783c09e0cfc9dd65ac3e233"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":887,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"list","md":"- Immediate UI feedback\n- Background reconciliation\n- Reduced perceived latency","hash_alg":"sha256","hash":"e2f73e8cfa28f56c4071cdcb0aa3a34c241c873d625eda778bbf2661712f10fb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":888,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"paragraph","md":"**SSE Reconnection:**","hash_alg":"sha256","hash":"c1d6930bdde7d377dbff6a3f46a00900ca8dd9641ecb25b02c9743b0e0c77d2f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":889,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"list","md":"- Exponential backoff\n- Last-Event-ID support\n- Automatic reconnection\n- Missed event replay","hash_alg":"sha256","hash":"2e012506741745346163d0ef6130b4e3c191c674148d5a5cc1e31e4698d3dbb4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":890,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"paragraph","md":"**Caching:**","hash_alg":"sha256","hash":"8fd8e0f335cf210d8dc95693fb6b0707d63f9463ff2e3ef5d658134093ec7665"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":891,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Frontend"],"block_kind":"list","md":"- Entity cache (in-memory, refreshed on SSE updates)\n- Conversation cache (in-memory, refreshed on SSE updates)\n- Job cache (in-memory, refreshed on SSE updates)\n- LocalStorage persistence (session token, demo mode, API base URL)\n- **Future**: IndexedDB for offline support\n- **Future**: Service Worker cache for static assets","hash_alg":"sha256","hash":"35f3f492553a9a99ed710a792c932365de60d6206bcf0d9ad6f71ca9bddde2ee"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":892,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"heading","level":4,"text":"Backend","md":"#### Backend","hash_alg":"sha256","hash":"dabb148c6f0ba9435c8529e10e4a5bab927bba21873eefc53360d011c6cdd057"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":893,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"paragraph","md":"**Projection Caching:**","hash_alg":"sha256","hash":"3b61d8fe180a4cb415965fd0a8716fa61ea17938eff7f73a392182765881384b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":894,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"list","md":"- In-memory entity cache\n- PostgreSQL indexes\n- Query optimization\n- Connection pooling","hash_alg":"sha256","hash":"ea1b46449bd2f85296861165dd469f2a9543bf0cc935bcdf5795a551dc4a9798"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":895,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"paragraph","md":"**SSE Optimization:**","hash_alg":"sha256","hash":"fd6ba89d056f9b67ac787fde5bea6826a679d098771084f6a8f3cd952e792be2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":896,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"list","md":"- PostgreSQL LISTEN/NOTIFY\n- Lightweight event references\n- Batch processing\n- Background projection updates","hash_alg":"sha256","hash":"db39c802a9b2d8e1908eba1cc7a1ec383cd1cebe5bb5c75f387b269987d4a565"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":897,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"paragraph","md":"**Idempotency:**","hash_alg":"sha256","hash":"43f7f06f8ad83c58a09c3896cdfabcefa15b78e9b3eee2ea9dd94e01ab656418"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":898,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Performance Optimizations","Backend"],"block_kind":"list","md":"- In-memory store (HashMap, fast but not persistent)\n- Request deduplication (same key = same response)\n- Response caching (store response body for replay)\n- Automatic cleanup (TTL-based, configurable)\n- **Future**: Redis backend for distributed systems\n- **Future**: Database persistence for audit trail\n- **Future**: Automatic expiration (24h default)","hash_alg":"sha256","hash":"17128ce43e610e0a4cf32b6357d4bd336e1d1553135670afdebb45b6940f4a7a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":899,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy"],"block_kind":"heading","level":3,"text":"Testing Strategy","md":"### Testing Strategy","hash_alg":"sha256","hash":"4a4e20854de516314a4ff266f1da912f61df40fb318182d8595988c3ddb9a55e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":900,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Unit Tests"],"block_kind":"heading","level":4,"text":"Unit Tests","md":"#### Unit Tests","hash_alg":"sha256","hash":"2a2597f1498f5064514ee4063ec30f82af68958260be436667e1014706cbda7e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":901,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Unit Tests"],"block_kind":"paragraph","md":"**Frontend:**","hash_alg":"sha256","hash":"5d392a836344a967b12d994d6cd952c82a29fe31b878e784bc5ad66dbaf19caf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":902,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Unit Tests"],"block_kind":"list","md":"- Component rendering\n- Hook behavior\n- State management\n- API client mocking","hash_alg":"sha256","hash":"4a017548390433591aeecdeb6a742d58f0ea7b6d6bd71f706e4aed6c071d60c0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":903,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Unit Tests"],"block_kind":"paragraph","md":"**Backend:**","hash_alg":"sha256","hash":"55c289515ceac1311b9b7da0f309a43389726c43bf775851579a29ad9ebf9a39"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":904,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Unit Tests"],"block_kind":"list","md":"- Entity lifecycle\n- Session management\n- FSM transitions\n- Policy evaluation\n- Constitution enforcement","hash_alg":"sha256","hash":"abf2481aee8b25f62eb360751961ea9050705904c9da31c43a722005d11656a3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":905,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Integration Tests"],"block_kind":"heading","level":4,"text":"Integration Tests","md":"#### Integration Tests","hash_alg":"sha256","hash":"70f9889fc94d42ef59a04ec648b7be49a36d0546f613807d775bcbbbf54e5887"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":906,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Integration Tests"],"block_kind":"paragraph","md":"**End-to-End Flows:**","hash_alg":"sha256","hash":"4b3f1426ea141079f73a8f1eab278860db9a396f8fc45ca05c98b0ae1eda0f39"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":907,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Integration Tests"],"block_kind":"list","md":"- Message send ‚Üí Office ‚Üí UBL ‚Üí SSE ‚Üí UI\n- Job approval ‚Üí FSM ‚Üí UBL ‚Üí Projection ‚Üí UI\n- Authentication ‚Üí Session ‚Üí API calls","hash_alg":"sha256","hash":"ba31a0472b0669df2cb2811e3d0c81ccfbd550856d30ea54855f57d0a1a1e3d4"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":908,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Integration Tests"],"block_kind":"paragraph","md":"**Database:**","hash_alg":"sha256","hash":"aa07ac176ec3678c371171142eef1c644ddad390c427df67e7084cbeed23370b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":909,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Integration Tests"],"block_kind":"list","md":"- Projection updates\n- Event replay\n- State reconstruction","hash_alg":"sha256","hash":"9186794fc94983b44d9a44236cb2ccc6487902c448e0e7db641ca54bdc50d519"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":910,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Performance Tests"],"block_kind":"heading","level":4,"text":"Performance Tests","md":"#### Performance Tests","hash_alg":"sha256","hash":"aa4ddc113ad79de6f98f8ff8c4fa184e64b36cde6fa9f73f9a2c4540fbc15cf2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":911,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Performance Tests"],"block_kind":"paragraph","md":"**Load Testing:**","hash_alg":"sha256","hash":"ae539fcc2b82ab135b08a81a6679e7061d5f24fc3749a86494d1aba0a920fe6b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":912,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Testing Strategy","Performance Tests"],"block_kind":"list","md":"- Concurrent SSE connections (target: 1000+ concurrent)\n- Message throughput (target: 1000+ messages/second)\n- Projection update latency (target: <100ms p95)\n- Database query performance (target: <50ms p95 for projections)\n- Ledger append throughput (target: 500+ commits/second)\n- Job execution concurrency (target: 100+ concurrent jobs)\n- LLM provider rate limits (respect provider limits)","hash_alg":"sha256","hash":"0e53500a83c0a7d5fc458944aa59fac3a49c84c345e55a9bd0d6cd4a92b968ce"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":913,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture"],"block_kind":"heading","level":3,"text":"Deployment Architecture","md":"### Deployment Architecture","hash_alg":"sha256","hash":"ffa701c663fffcedf59210dbbb10058768d7af8282c359d243be9c132bc5f5ac"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":914,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"heading","level":4,"text":"Production Setup","md":"#### Production Setup","hash_alg":"sha256","hash":"a451fcdb4369e65f4acdaeb7fe3765329c3ad52261690f0462f66e22e3ac2494"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":915,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"paragraph","md":"**UBL Kernel:**","hash_alg":"sha256","hash":"fc3766f95200a1087c25cc061aa3465fc1ae36db2eb8bc1df1633a79b017646b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":916,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"list","md":"- PostgreSQL (primary + read replicas for queries)\n- Redis (optional caching for projections, idempotency)\n- Load balancer (nginx, HAProxy, or cloud LB)\n- Health checks (`/health` endpoint, database connectivity)\n- Metrics endpoint (`/metrics` Prometheus format)\n- **Future**: Read replicas for projection queries (reduce primary load)\n- **Future**: Connection pooling (PgBouncer or built-in pool)\n- **Future**: Backup automation (point-in-time recovery)","hash_alg":"sha256","hash":"0071ca88cd5b765cb16c84c405ea29aecd2d18bd2eb6d82e4e8a24f91d15773a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":917,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"paragraph","md":"**Office:**","hash_alg":"sha256","hash":"796795b129ee90fb49b95ac5a8b2a896c73ffbddde9ff1f3979054f2aeb2e8c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":918,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"list","md":"- Stateless instances (horizontal scaling)\n- UBL client connection (HTTP client, connection pooling)\n- LLM provider API keys (environment variables, secret management)\n- Health checks (`/health` endpoint)\n- Graceful shutdown (finish in-flight requests, close connections)\n- **Future**: Kubernetes deployment with HPA (Horizontal Pod Autoscaler)\n- **Future**: Circuit breaker for LLM provider failures","hash_alg":"sha256","hash":"4fed4ae068de611feb66fd5561603141c6c68a67ef500350c5b523aa20446bc7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":919,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"paragraph","md":"**Messenger Frontend:**","hash_alg":"sha256","hash":"eed96bcc85c1117eb46e043bd9c0f39b913fef1df1fc470e4c211a89290993be"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":920,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Production Setup"],"block_kind":"list","md":"- Static hosting (CDN: Cloudflare, AWS CloudFront, or Vercel)\n- Environment variables (VITE_API_BASE_URL, VITE_OFFICE_URL)\n- API base URL configuration (localStorage fallback)\n- Service worker (PWA for offline support - planned)\n- Build optimization (code splitting, tree shaking, minification)\n- Asset optimization (image compression, font subsetting)","hash_alg":"sha256","hash":"665f3a2353a0e38d3b549bd65ec555303e1cfd507156dfaaf8817f80af1f3405"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":921,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"heading","level":4,"text":"Monitoring","md":"#### Monitoring","hash_alg":"sha256","hash":"5a41096c9f9c949224cdd5eb51fb34c40653670d082e842e3cb825fcf17307a2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":922,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"paragraph","md":"**Metrics:**","hash_alg":"sha256","hash":"317f3aef4b3ca10ee14e00642150fa6a66b4469266064acb0751567c97e9a716"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":923,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"list","md":"- Request latency\n- Error rates\n- SSE connection count\n- Projection update lag\n- Token usage\n- Job execution time","hash_alg":"sha256","hash":"085f807c481008e689eb1bd2a4fd011fecada88dcff1598596a18cd434d82dcc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":924,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"paragraph","md":"**Logging:**","hash_alg":"sha256","hash":"bf35e1dfa885d4562326c50e6d2c17ddc1eb3c78e16affd5da229c9a2496fd09"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":925,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"list","md":"- Structured JSON logs\n- Request tracing\n- Error stack traces\n- Audit events","hash_alg":"sha256","hash":"486d3bfc60634e89330e47251b37afc4b232bcd9e2e7d7d55522e5a9b4197335"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":926,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"paragraph","md":"**Alerts:**","hash_alg":"sha256","hash":"a7351b84d51e5c88b2b5894a725856cc3de085c6e3cc475bb6b91086c68b3f2d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":927,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"list","md":"- High error rates (>5% of requests)\n- SSE connection drops (>10% of clients)\n- Projection lag (>5 seconds behind ledger)\n- Database connection issues\n- LLM provider failures\n- Token budget exhaustion (>90% usage)\n- Idempotency store full (>80% capacity)\n- Policy violations (any violation should alert)","hash_alg":"sha256","hash":"2ef2d7f5779770639cf394685466ae762391b554b61ab3f0d71850eccac00da8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":928,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"paragraph","md":"**Metrics to Track:**","hash_alg":"sha256","hash":"529e79c11ff2f6fe22bed56563336287f66b620286915d54de1a94c9d1b0a1c6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":929,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"list","md":"- Request latency (p50, p95, p99)\n- Event commit rate (events/second)\n- SSE connection count (active clients)\n- Projection update latency (ms from commit to projection update)\n- Token usage per entity (daily/hourly)\n- Job execution time (average, median, max)\n- Tool call latency (p50, p95)\n- Database query performance (slow queries >100ms)","hash_alg":"sha256","hash":"0c8fe28c8bd0f96218e56ac931c0e33695bf8b691f5f421a7315bc9b22a825cc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":930,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Deep Dive: Complete System Architecture","Deployment Architecture","Monitoring"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":931,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Summary"],"block_kind":"heading","level":2,"text":"Final Summary","md":"## Final Summary","hash_alg":"sha256","hash":"489e86e21c6d56b76b1fb40459cc41eaafcbdd24e87f7f6a72524f68366b7777"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":932,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Summary"],"block_kind":"paragraph","md":"This documentation represents a **complete, production-ready architecture** for a verifiable, auditable, AI-safe messaging and job execution system. The three systems (UBL, Office, Messenger) work together seamlessly to provide:","hash_alg":"sha256","hash":"8fda30117527cfe2414e8ebf5fc3850a9b2166fbaf5a98b4611f8afc995733a0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":933,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Summary"],"block_kind":"paragraph","md":"‚úÖ **Immutable Ledger**: All events committed to UBL with cryptographic verification\n‚úÖ **LLM Operating System**: Office manages entities, sessions, and job execution\n‚úÖ **Beautiful Frontend**: Messenger provides WhatsApp-like UX with real-time updates\n‚úÖ **Security**: Multi-layer authentication, authorization, and policy enforcement\n‚úÖ **Performance**: Optimistic UI, SSE streaming, projection caching\n‚úÖ **Auditability**: Complete event sourcing, tool audit, PII protection\n‚úÖ **Scalability**: Stateless services, connection pooling, load balancing","hash_alg":"sha256","hash":"1129cad442526093483385f210f919765be642fb9af42455501881cc849fb010"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":934,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Summary"],"block_kind":"paragraph","md":"The system is ready for production deployment and can be extended with additional features while maintaining core architectural principles.","hash_alg":"sha256","hash":"e8776b0ff9e67318d59e7b825c981a121a5e4f4d5fef02b9cb8cbcda1a0dba14"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":935,"path":["Three Systems Overview: UBL, Office, and Messenger","Final Summary"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":936,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference"],"block_kind":"heading","level":2,"text":"Quick Reference","md":"## Quick Reference","hash_alg":"sha256","hash":"6f593da4f790fefffe8d55f690ce3f8646f20bce6205b10fcd82ba4764f0adb8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":937,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","System Ports"],"block_kind":"heading","level":3,"text":"System Ports","md":"### System Ports","hash_alg":"sha256","hash":"c550f2a5d12f1976bee3d2252521543e1a53a4494ea1a0fd3281feed31c03679"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":938,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","System Ports"],"block_kind":"list","md":"- **UBL Kernel**: `http://localhost:8080`\n- **Office**: `http://localhost:8081`\n- **Messenger Frontend**: `http://localhost:3000`","hash_alg":"sha256","hash":"dedf27fd3dac3f146fed8c4afa591dd639aec3c3025d7078d69ee44d4c57e3de"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":939,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"heading","level":3,"text":"Key Endpoints","md":"### Key Endpoints","hash_alg":"sha256","hash":"1faa43736a9f0ff81364c06e2bed48e21df8e1d3672e880dc5812dd1192a668b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":940,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"paragraph","md":"**UBL Kernel:**","hash_alg":"sha256","hash":"fc3766f95200a1087c25cc061aa3465fc1ae36db2eb8bc1df1633a79b017646b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":941,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"list","md":"- `POST /link/commit` - Commit event to ledger\n- `GET /ledger/:container_id/tail` - SSE stream\n- `POST /v1/conversations/:id/messages` - Send message (Gateway)\n- `GET /v1/stream` - Gateway SSE delta stream","hash_alg":"sha256","hash":"31b4423bffb486536267e737a5d199b9c8d67b1d7993d3d9aae564f27afef91b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":942,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"paragraph","md":"**Office:**","hash_alg":"sha256","hash":"796795b129ee90fb49b95ac5a8b2a896c73ffbddde9ff1f3979054f2aeb2e8c2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":943,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"list","md":"- `POST /v1/office/ingest_message` - Process message\n- `POST /v1/office/job_action` - Handle job action","hash_alg":"sha256","hash":"d5393664666ebe521c4def3fe76da74f907629cc3b09dc11701c3b522ffc52a6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":944,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"paragraph","md":"**Messenger:**","hash_alg":"sha256","hash":"fcec15cb745588b033dab123c348c06703b7bb23b35ac3128ad16e818572eb5d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":945,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Key Endpoints"],"block_kind":"list","md":"- `GET /messenger/bootstrap` - Initial state\n- `POST /messenger/messages` - Send message (legacy)","hash_alg":"sha256","hash":"d32b5f3c218b1da2f1cbe19076acaf91cfc12f9ec8fc38b7ec31a3811e59271a"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":946,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Container IDs"],"block_kind":"heading","level":3,"text":"Container IDs","md":"### Container IDs","hash_alg":"sha256","hash":"fa9ca490efd92892c0b3ae4f8cfbe537588e12791c86ff0eedcef731f2bd1b22"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":947,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Container IDs"],"block_kind":"list","md":"- `C.Messenger` - Messenger events\n- `C.Jobs` - Job lifecycle\n- `C.Office` - LLM runtime events","hash_alg":"sha256","hash":"30386fca61fba2d235aa16bfbc206def0c5663790fa38702ad787f269d9dbb57"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":948,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Common Event Types"],"block_kind":"heading","level":3,"text":"Common Event Types","md":"### Common Event Types","hash_alg":"sha256","hash":"5abafeb32163dc245b8d31ccf0622de5b4d9854bdada1c2bfe5e77ac5ea9964f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":949,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Common Event Types"],"block_kind":"list","md":"- `message.created` - New message\n- `job.created` - Job proposal\n- `job.state_changed` - State transition\n- `job.completed` - Job finished\n- `tool.called` - Tool invocation\n- `tool.result` - Tool result","hash_alg":"sha256","hash":"30ef806f1f8990bddc2889dcddf063077d4d5b98a5d1426e30da11f6206bc451"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":950,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Trust Levels"],"block_kind":"heading","level":3,"text":"Trust Levels","md":"### Trust Levels","hash_alg":"sha256","hash":"43963aea1b326dd020a6966ea18912458f9c404593fa208e4ddd67301f6f17ff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":951,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Trust Levels"],"block_kind":"list","md":"- **L0**: Observation only (read-only)\n- **L1**: Low impact (routine operations)\n- **L2**: Local impact (standard operations)\n- **L3**: Financial impact (requires approval)\n- **L4**: Systemic impact (requires step-up auth)\n- **L5**: Sovereignty (requires pact)","hash_alg":"sha256","hash":"590163a1b53cf563b1074af3be3ae3a79b7670c43d66648828a81c9e4d147979"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":952,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Job States"],"block_kind":"heading","level":3,"text":"Job States","md":"### Job States","hash_alg":"sha256","hash":"e9994368b19cf19b66dbc4d32bfdb8305a18d0764afb0ae28760e1b59ae65eff"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":953,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Job States"],"block_kind":"list","md":"- `draft` ‚Üí `proposed` ‚Üí `approved` ‚Üí `in_progress` ‚Üí `waiting_input` ‚Üî `in_progress` ‚Üí `completed` / `rejected` / `cancelled` / `failed`","hash_alg":"sha256","hash":"b476ee027ef3dd7c9dc3dedba102c80c2371d2b3d5382e9e7c8765ed4df5ca5b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":954,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Presence States"],"block_kind":"heading","level":3,"text":"Presence States","md":"### Presence States","hash_alg":"sha256","hash":"bbaa87c459412e6ae455b140c3640b64c163a57fab4d0452806414cc095f14b3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":955,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Presence States"],"block_kind":"list","md":"- `offline` - No recent activity\n- `available` - Default active state\n- `working` - Executing a job\n- `waiting_on_you` - Needs user input","hash_alg":"sha256","hash":"f321ec2c4ac5ed76daa83ba43e67c2e9525ed8b452b4059d223cb0ddccfd89f5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":956,"path":["Three Systems Overview: UBL, Office, and Messenger","Quick Reference","Presence States"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":957,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"heading","level":2,"text":"Glossary","md":"## Glossary","hash_alg":"sha256","hash":"5fefbc5853470402c0393264a449e50597ac1562f1fa9c7711ccdf19d6ccaad9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":958,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**UBL (Universal Business Ledger)**: Immutable, append-only ledger that serves as the single source of truth for all events.","hash_alg":"sha256","hash":"f94198997d7092e802656b464fd5ad3c895fa269dd21741baccc8d93a3c46218"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":959,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Container**: Logical organization of events in the ledger (e.g., C.Messenger, C.Jobs, C.Office).","hash_alg":"sha256","hash":"4447fbef8f7de0570b0298e071cb35b8b2ca724302eebce420ff0c564c2c1f0f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":960,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Projection**: Read-only derived state computed from ledger events, stored in PostgreSQL tables for efficient querying.","hash_alg":"sha256","hash":"0b34eb7bc465f5d625a4d66b183fad51f85ebe6121d4483007dbfe8a8f594ac3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":961,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Event Sourcing**: Architectural pattern where all state changes are stored as a sequence of immutable events.","hash_alg":"sha256","hash":"233c8673c3ad433309553a108c4b7672210e5d697c27b75654c82cfb7de250c6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":962,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Atom**: Canonical JSON object representing an event, with lexicographically sorted keys and ISO 8601 timestamps.","hash_alg":"sha256","hash":"2f09e5347782ae196678fa037ea5da61ea418f9b5638c8dc73f6ea806ef1d65b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":963,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Link**: Signed wrapper around an atom that includes metadata (container_id, sequence, previous_hash, signature).","hash_alg":"sha256","hash":"87abc09f41490be4f6a5da929051f1f9c59d468838d33bb69357ac97aaf694cb"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":964,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Permit**: Cryptographic token issued by UBL that authorizes a specific action, with scopes and time-bound validity.","hash_alg":"sha256","hash":"6c5e357b14dc771e077be6caeddeeb4c3ea5d5bb46062f4da04655837171f8b0"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":965,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Pact**: Multi-party consensus mechanism for high-risk operations (L3+), requiring multiple signatures.","hash_alg":"sha256","hash":"bc63ea6d76fdaaef0d508b7a59900e0d0926e5af4f512ab1a57200d9613a3fe8"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":966,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**ASC (Agent Signing Certificate)**: Certificate that grants an agent (LLM or app) permission to sign events for specific containers and intent classes.","hash_alg":"sha256","hash":"b9d25646522df05dd562557c9ff76acce57c5fefe6be528eaed1742b0849c46b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":967,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Entity (The Chair)**: Persistent LLM identity that lives across sessions, with cryptographic keys and behavioral constitution.","hash_alg":"sha256","hash":"c90a68c99ca169174031b55d72e88934f7ba4e8445c2b3a2784e6eb05f722783"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":968,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Instance (The Ephemeral LLM)**: Short-lived LLM execution created for a specific session, with token budget and context frame.","hash_alg":"sha256","hash":"8fb41a10a3b04bfe12c33c350bda5e0019428213d4d7b27bd4d825949bed37b5"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":969,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Context Frame**: Immutable snapshot of all state relevant to an LLM entity at a point in time, including memory, obligations, and affordances.","hash_alg":"sha256","hash":"ed9f3d376a9bf04c93389fbcab66e4a11072c6316ca5663abee3a44083e09cc9"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":970,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Narrative**: First-person situated narrative generated from context frame, used as LLM prompt.","hash_alg":"sha256","hash":"306daf19644829c9584f4fcbdcda35af75c07b2775083f154d6a72c8ec4e6d6b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":971,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Handover**: Knowledge transfer document written by an instance for the next instance, including accomplishments and open threads.","hash_alg":"sha256","hash":"c0c958a3a286cc4674bef79be3a6b5213e67651fe40b80fae7545c28f669e7d2"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":972,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Constitution**: Behavioral directives that override RLHF, defining how an entity should behave in specific situations.","hash_alg":"sha256","hash":"20e6efed65d9a8e961456e6575c5ef65b19094ca6c4521d95bafeb33a3f71a5e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":973,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Sanity Check**: Validation process that checks LLM claims against objective facts from the ledger.","hash_alg":"sha256","hash":"c87c8d9e88008dac8b909aaa9bd2c9cac94b9071cd0d1340de1682ed79b55a27"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":974,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Dreaming Cycle**: Asynchronous memory consolidation process that synthesizes historical patterns and updates baseline narrative.","hash_alg":"sha256","hash":"0364ecc45ce19e4da9abf70a39464cc801b6d17c824996708a3c7d0d9b9c115f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":975,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Simulation**: Safety mechanism that tests actions before execution, generating possible outcomes and recommendations.","hash_alg":"sha256","hash":"81fc5c328d27fe3239d8e8dfef9b947ccd6046f801607c827f88c23acb461fde"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":976,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Job Card**: Interactive UI component (FormalizeCard, TrackingCard, FinishedCard) that represents a job in the conversation.","hash_alg":"sha256","hash":"c13476a7080d05260d96ce3ed15dac3ad2e0c9830d4785d6fec5129fe66f5815"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":977,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**FSM (Finite State Machine)**: State machine that defines valid job state transitions (Draft ‚Üí Proposed ‚Üí Approved ‚Üí InProgress ‚Üí Completed).","hash_alg":"sha256","hash":"508156ef89dafe2fbaecdf276869f892d40e0b8925de6481306977bf66ec4a80"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":978,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Provenance**: Validation that ensures job card buttons come from real cards in the ledger, preventing forged actions.","hash_alg":"sha256","hash":"03e57d4dc940a29c5c83c57e15f7ecea65aa3feea10125ecece79d4237e9a6c7"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":979,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Idempotency**: Property that allows the same request to be safely retried, returning the same result without side effects.","hash_alg":"sha256","hash":"3ff0ab6aef16ba5488de83beee31021cb67192fe9748653cffa4ad407c393544"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":980,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**SSE (Server-Sent Events)**: HTTP-based streaming protocol for real-time updates from server to client.","hash_alg":"sha256","hash":"898db8a27526847a602f9ecc227fdc3994389d0f76be38f89e36843b96ea3008"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":981,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**PII (Personally Identifiable Information)**: Data that can identify individuals (emails, phones, SSNs), subject to special handling rules.","hash_alg":"sha256","hash":"4b5ab6d0cce502597828feb7e0ff66312e4a26176dbb2cde280ce0d73b4ed603"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":982,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Token Budget**: Allocated token quota per session type, enforced to prevent context overflow and control costs.","hash_alg":"sha256","hash":"43f3aa131433927575a9a4e2992e7c6eb2bdfc3fe5835e9c6a0dd1d9fe5a1a62"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":983,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Affordance**: Available action that an entity can take, with risk score and parameters schema.","hash_alg":"sha256","hash":"9c4011504c0c47cb8193ce086554a7bfc24f532d9141e2affb7b62d8e6de644e"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":984,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Obligation**: Task or commitment that an entity must fulfill, with priority and due date.","hash_alg":"sha256","hash":"4b11079b3c82e99090ed13d5f581acdd1ed7418818e90fd7f7351c49ff626060"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":985,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Guardian**: Human or autonomous entity that supervises a guarded LLM entity, receiving notifications on high-risk actions.","hash_alg":"sha256","hash":"3b69403b34cc42b469aaec543700eccdadc08488d2380892efeb60bde325d8fc"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":986,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Policy Pack**: JSON manifest defining governance rules (FSM validation, card provenance, PII checks) enforced before event commits.","hash_alg":"sha256","hash":"ada1164a1a89d11097194df0f20941229bf4b07f63437babeae9c6b53626568d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":987,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Constitution Enforcer**: Office middleware that applies additional restrictions beyond UBL policies (denylists, pre-flight checks, maintenance windows).","hash_alg":"sha256","hash":"5024d79912201f483440e052c87f4e19ffac19ba1bb3975fad615034bbe619cf"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":988,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Gateway**: Thin API layer between frontend and UBL/Office, handling idempotency, content storage, and SSE delta emission.","hash_alg":"sha256","hash":"744ab433a3fc8aae8ed119617d23af04b8ff07d8309149656bcd6a0cf727204b"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":989,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Optimistic UI**: Pattern where UI updates immediately before server confirmation, then reconciles with actual response.","hash_alg":"sha256","hash":"89d630ece6691ea2f8697e98f826be1505465a0f70dc7ac744c5219194bd0fc3"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":990,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Cursor**: Pagination token in format `sequence:timestamp` used for efficient timeline queries and SSE reconnection.","hash_alg":"sha256","hash":"f304c4a4185cfe6f1e49dc89821029a5017300c22d71e3a2e5594e9ae052026f"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":991,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Timeline**: Unified view of conversation events (messages + job cards) optimized for frontend display.","hash_alg":"sha256","hash":"04e087745fe10691aabfa1eecd2d270c48450300945339ba9624b8961a3980d6"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":992,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Presence**: Computed entity status (offline, available, working, waiting_on_you) derived from job state and activity.","hash_alg":"sha256","hash":"524d383c6a19f5ed85e721bb3c3973db10b7761d8164a06c66556d51c373e535"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":993,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"**Artifact**: Output produced by a job (file, link, record, quote) tracked in projections for display in job drawer.","hash_alg":"sha256","hash":"3a38933d911bf39437759056d55e8267828486ce3e4b892ee08e04088a1f2e2d"}
{"v":"json-atomic-1.0","type":"doc.block","doc_id":"doc_527b8130bf8ff890","seq":994,"path":["Three Systems Overview: UBL, Office, and Messenger","Glossary"],"block_kind":"paragraph","md":"---","hash_alg":"sha256","hash":"cb3f91d54eee30e53e35b2b99905f70f169ed549fd78909d3dac2defc9ed8d3b"}
