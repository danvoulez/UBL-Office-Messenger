# UBL Fractal SecPack - Infrastructure Automation
# Date: 2025-12-28

.PHONY: help pf-apply iptables postgres-init wg-up runner-start runner-stop gen-ids all

help:
	@echo "UBL Fractal SecPack Commands:"
	@echo "  pf-apply      - Apply pf.conf (macOS firewall)"
	@echo "  iptables      - Apply iptables rules (Linux firewall)"
	@echo "  postgres-init - Initialize PostgreSQL roles and triggers"
	@echo "  wg-up         - Start WireGuard tunnel"
	@echo "  runner-start  - Start Runner service (macOS launchd)"
	@echo "  runner-stop   - Stop Runner service"
	@echo "  gen-ids       - Generate container IDs"
	@echo "  all           - Apply all security configs"

# macOS firewall
pf-apply:
	@echo "ğŸ”¥ Applying pf.conf..."
	sudo pfctl -f firewall/pf.conf
	sudo pfctl -e
	@echo "âœ… pf.conf applied"

# Linux firewall
iptables:
	@echo "ğŸ”¥ Applying iptables rules..."
	sudo bash firewall/iptables.sh
	@echo "âœ… iptables applied"

# PostgreSQL init (socket-only + append-only triggers)
postgres-init:
	@echo "ğŸ—„ï¸ Initializing PostgreSQL..."
	@if [ -f /etc/postgresql/*/main/postgresql.conf ]; then \
		sudo cp postgres/postgresql.conf /etc/postgresql/*/main/conf.d/ubl.conf; \
	else \
		echo "âš ï¸ PostgreSQL config not found, manual copy required"; \
	fi
	psql -U postgres -d ubl_ledger -f postgres/roles.sql
	@echo "âœ… PostgreSQL configured (socket-only, append-only)"

# WireGuard (LAB 256)
wg-up:
	@echo "ğŸ”’ Starting WireGuard..."
	sudo cp wireguard/wg0.lab256.conf /etc/wireguard/wg0.conf
	sudo wg-quick up wg0
	@echo "âœ… WireGuard tunnel active"

wg-down:
	sudo wg-quick down wg0

# Runner service (macOS)
runner-start:
	@echo "ğŸƒ Starting Runner service..."
	mkdir -p /Users/Shared/ubl-runner/{ro,rw,logs}
	cp -R runner/* /Users/Shared/ubl-runner/
	cp sandbox/runner.sb /Users/Shared/ubl-runner/
	launchctl load -w examples/launchd.ubl-runner.plist
	@echo "âœ… Runner service started"

runner-stop:
	launchctl unload examples/launchd.ubl-runner.plist

# Generate container IDs
gen-ids:
	@echo "ğŸ”‘ Generating container IDs..."
	python3 scripts/gen_container_ids.py > manifests/containers.json
	@echo "âœ… Container IDs generated:"
	@cat manifests/containers.json

# Full setup
all: pf-apply postgres-init wg-up runner-start gen-ids
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ›¡ï¸  UBL Fractal SecPack - DEPLOYED              â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  âœ… Firewall: pf.conf applied                    â•‘"
	@echo "â•‘  âœ… PostgreSQL: socket-only, append-only         â•‘"
	@echo "â•‘  âœ… WireGuard: 10.77.0.0/24 tunnel active        â•‘"
	@echo "â•‘  âœ… Runner: sandboxed, pull-only                 â•‘"
	@echo "â•‘  âœ… Container IDs: generated                     â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

