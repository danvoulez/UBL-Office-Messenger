# ğŸ¯ğŸ”¥ PROMPT 3: THE FLAGSHIP TRINITY

```markdown
# MISSÃƒO: CONSTRUIR A TRINDADE FLAGSHIP DA LOGLINE

VocÃª irÃ¡ criar trÃªs sistemas completos, independentes mas conectados via API/SSE/WebSocket, que juntos representam a materializaÃ§Ã£o completa da visÃ£o LogLine Foundation.

---

## CONTEXTO CRÃTICO

### A VisÃ£o

Pequenas e mÃ©dias empresas precisam de:
1. **Interface familiar** (WhatsApp-like) para adoÃ§Ã£o zero-friction
2. **OrganizaÃ§Ã£o profissional** via cards formalizados e trackÃ¡veis
3. **IA integrada naturalmente** (humanos e agentes como colegas de trabalho)
4. **Infraestrutura de dignidade** para LLMs (nÃ£o sÃ£o chatbots, sÃ£o trabalhadores)
5. **Auditabilidade completa** via ledger imutÃ¡vel

### Os TrÃªs Pilares
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  UBL MESSENGER                      â”‚
â”‚  WhatsApp UI + Cards + Humanos & Agentes           â”‚
â”‚  (Frontend Beautiful + Backend Smart)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ API/WS
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OFFICE                          â”‚
â”‚  LLM Runtime + GovernanÃ§a + Context Management     â”‚
â”‚  (Dignidade para entidades efÃªmeras)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Ledger Events
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  UBL LEDGER                         â”‚
â”‚  Append-only + Containers + Trust Architecture     â”‚
â”‚  (Source of Truth ImutÃ¡vel)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
---

## SISTEMA 1: UBL MESSENGER

### VisÃ£o do Produto

**"WhatsApp profissional onde seus colegas de trabalho podem ser humanos OU agentes de IA"**

### Personas

1. **Maria (Gerente de Loja)**
   - Usa WhatsApp diariamente
   - Nunca usou IA "de verdade"
   - Precisa organizar tarefas com time de 8 pessoas

2. **RoboAtendente (Agente LLM)**
   - Responde clientes
   - Cria propostas
   - Agenda entregas
   - Parece "mais um colega" pra Maria

### Core Features

#### 1. Message List (Conversas)
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Buscar conversasâ€¦             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ JoÃ£o Silva              14:23   â”‚
â”‚  ğŸ“‹ Card: Entrega #4521             â”‚
â”‚  â”œâ”€ â³ Aguardando confirmaÃ§Ã£o       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¤– RoboAtendente          14:20   â”‚
â”‚  ğŸ’¬ Proposta enviada ao cliente     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¥ Time Vendas (8)         13:45   â”‚
â”‚  ğŸ“‹ Card: Meta Semanal              â”‚
â”‚  â”œâ”€ âœ… ConcluÃ­do                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ Ana Costa              13:12   â”‚
â”‚  ğŸ’¬ Preciso de ajuda com estoqueâ€¦ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**Regras:**
- Humanos tÃªm ğŸ‘¤
- Agentes tÃªm ğŸ¤–
- Grupos tÃªm ğŸ‘¥
- Cards em andamento aparecem com status
- Ãšltima mensagem ou Ãºltimo card ativo

#### 2. Chat Window
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† ğŸ¤– RoboAtendente                    â‹®        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  VocÃª (14:15)                                   â”‚
â”‚  Preciso criar uma proposta para cliente ABC    â”‚
â”‚                                                 â”‚
â”‚  RoboAtendente (14:16)                          â”‚
â”‚  Entendido! Vou preparar a proposta.            â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‹ JOB #J-2024-001                        â”‚ â”‚
â”‚  â”‚ Criar Proposta - Cliente ABC              â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ Status: â³ Em andamento                   â”‚ â”‚
â”‚  â”‚ Iniciado: 14:16                           â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ âœ… Dados coletados                        â”‚ â”‚
â”‚  â”‚ â³ Calculando preÃ§osâ€¦                   â”‚ â”‚
â”‚  â”‚ â¬œ Gerar documento                        â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ [Ver Detalhes] [Cancelar Job]            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚  RoboAtendente (14:17)                          â”‚
â”‚  Proposta calculada. Valor: R$ 12.450,00        â”‚
â”‚  Prazo: 30 dias                                 â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ¯ APROVAÃ‡ÃƒO NECESSÃRIA                   â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ Proposta #P-2024-089                      â”‚ â”‚
â”‚  â”‚ Cliente: ABC Ltda                         â”‚ â”‚
â”‚  â”‚ Valor: R$ 12.450,00                       â”‚ â”‚
â”‚  â”‚ Margem: 23%                               â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ [âœ… Aprovar] [âŒ Rejeitar] [âœï¸ Ajustar]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚  VocÃª (14:18)                                   â”‚
â”‚  [clicou: âœ… Aprovar]                           â”‚
â”‚                                                 â”‚
â”‚  RoboAtendente (14:18)                          â”‚
â”‚  âœ… Proposta aprovada!                          â”‚
â”‚  Enviando para clienteâ€¦                       â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‹ JOB #J-2024-001                        â”‚ â”‚
â”‚  â”‚ Criar Proposta - Cliente ABC              â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ Status: âœ… ConcluÃ­do                      â”‚ â”‚
â”‚  â”‚ Finalizado: 14:18                         â”‚ â”‚
â”‚  â”‚ DuraÃ§Ã£o: 2min                             â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ âœ… Proposta enviada                       â”‚ â”‚
â”‚  â”‚ ğŸ“ proposta_abc_2024.pdf                  â”‚ â”‚
â”‚  â”‚                                           â”‚ â”‚
â”‚  â”‚ [Ver Documento] [Nova Proposta]           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ Mensagemâ€¦                        [Enviar]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**Tipos de Cards:**

**A. Job Initiation Card**
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ JOB #J-YYYY-NNN                    â”‚
â”‚ [TÃ­tulo da Tarefa]                    â”‚
â”‚                                       â”‚
â”‚ Status: ğŸ¯ Aguardando aprovaÃ§Ã£o       â”‚
â”‚ Solicitante: [Nome]                   â”‚
â”‚ Estimativa: [Tempo]                   â”‚
â”‚                                       â”‚
â”‚ [Detalhes]                            â”‚
â”‚ - Item 1                              â”‚
â”‚ - Item 2                              â”‚
â”‚                                       â”‚
â”‚ [âœ… Aprovar e Iniciar] [âŒ Recusar]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**B. Job Progress Card**
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ JOB #J-YYYY-NNN                    â”‚
â”‚ [TÃ­tulo da Tarefa]                    â”‚
â”‚                                       â”‚
â”‚ Status: â³ Em andamento               â”‚
â”‚ Iniciado: [Timestamp]                 â”‚
â”‚ ResponsÃ¡vel: [Nome/Agente]            â”‚
â”‚                                       â”‚
â”‚ Progresso:                            â”‚
â”‚ âœ… Etapa 1                            â”‚
â”‚ â³ Etapa 2 (45%)                      â”‚
â”‚ â¬œ Etapa 3                            â”‚
â”‚                                       â”‚
â”‚ [Ver Detalhes] [Cancelar Job]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**C. Job Completion Card**
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ JOB #J-YYYY-NNN                    â”‚
â”‚ [TÃ­tulo da Tarefa]                    â”‚
â”‚                                       â”‚
â”‚ Status: âœ… ConcluÃ­do                  â”‚
â”‚ Finalizado: [Timestamp]               â”‚
â”‚ DuraÃ§Ã£o: [Tempo]                      â”‚
â”‚                                       â”‚
â”‚ Resultado:                            â”‚
â”‚ [Resumo do que foi feito]             â”‚
â”‚                                       â”‚
â”‚ Artefatos:                            â”‚
â”‚ ğŸ“ arquivo1.pdf                       â”‚
â”‚ ğŸ“ arquivo2.xlsx                      â”‚
â”‚                                       â”‚
â”‚ [Baixar Tudo] [Nova Tarefa Similar]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**D. Approval Card**
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ APROVAÃ‡ÃƒO NECESSÃRIA               â”‚
â”‚                                       â”‚
â”‚ [TÃ­tulo da DecisÃ£o]                   â”‚
â”‚                                       â”‚
â”‚ Detalhes:                             â”‚
â”‚ - Detalhe 1                           â”‚
â”‚ - Detalhe 2                           â”‚
â”‚ - Detalhe 3                           â”‚
â”‚                                       â”‚
â”‚ Impacto: [DescriÃ§Ã£o]                  â”‚
â”‚                                       â”‚
â”‚ [âœ… Aprovar] [âŒ Rejeitar]            â”‚
â”‚ [âœï¸ Solicitar Ajustes]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
#### 3. Conversas Humano-Humano COM Cards

**Exemplo: Maria delegando para JoÃ£o**
```

Maria (10:30)
JoÃ£o, preciso que vocÃª organize o estoque hoje

[Criar Card de Tarefa]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ JOB #J-2024-002                    â”‚
â”‚ Organizar Estoque - SeÃ§Ã£o A          â”‚
â”‚                                       â”‚
â”‚ Status: ğŸ¯ Aguardando aceitaÃ§Ã£o       â”‚
â”‚ AtribuÃ­do a: JoÃ£o Silva               â”‚
â”‚ Prazo sugerido: Hoje, 18:00           â”‚
â”‚                                       â”‚
â”‚ [âœ… Aceitar] [âŒ NÃ£o posso]           â”‚
â”‚ [ğŸ’¬ Negociar prazo]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

JoÃ£o (10:32)
[clicou: âœ… Aceitar]

JoÃ£o (10:32)
Pode deixar, Maria! ComeÃ§o agora.

[Card atualiza automaticamente]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ JOB #J-2024-002                    â”‚
â”‚ Organizar Estoque - SeÃ§Ã£o A          â”‚
â”‚                                       â”‚
â”‚ Status: â³ Em andamento               â”‚
â”‚ Iniciado: 10:32                       â”‚
â”‚ ResponsÃ¡vel: JoÃ£o Silva               â”‚
â”‚                                       â”‚
â”‚ [Marcar como ConcluÃ­do]               â”‚
â”‚ [Reportar Problema]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
**CRÃTICO:** Conversa NÃƒO congela durante job. Pode continuar conversando normalmente!

#### 4. Arquitetura Frontend
```

messenger-frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ConversationList.tsx      # Lista de conversas
â”‚   â”‚   â”œâ”€â”€ ChatWindow.tsx            # Janela de chat
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx         # BalÃ£o de mensagem
â”‚   â”‚   â”œâ”€â”€ cards/
â”‚   â”‚   â”‚   â”œâ”€â”€ JobInitCard.tsx       # Card inicial
â”‚   â”‚   â”‚   â”œâ”€â”€ JobProgressCard.tsx   # Card progresso
â”‚   â”‚   â”‚   â”œâ”€â”€ JobCompleteCard.tsx   # Card finalizado
â”‚   â”‚   â”‚   â”œâ”€â”€ ApprovalCard.tsx      # Card aprovaÃ§Ã£o
â”‚   â”‚   â”‚   â””â”€â”€ CardRenderer.tsx      # Renderizador genÃ©rico
â”‚   â”‚   â”œâ”€â”€ ParticipantAvatar.tsx     # Avatar (humano/agente)
â”‚   â”‚   â””â”€â”€ JobTimeline.tsx           # Timeline de jobs
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useConversations.ts       # Gerenciar conversas
â”‚   â”‚   â”œâ”€â”€ useMessages.ts            # Gerenciar mensagens
â”‚   â”‚   â”œâ”€â”€ useJobs.ts                # Gerenciar jobs
â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts           # Real-time updates
â”‚   â”‚   â””â”€â”€ useOfficeAgent.ts         # Interagir com OFFICE
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ messengerApi.ts           # Backend API
â”‚   â”‚   â”œâ”€â”€ officeApi.ts              # OFFICE API
â”‚   â”‚   â”œâ”€â”€ ublApi.ts                 # UBL Ledger API
â”‚   â”‚   â””â”€â”€ websocket.ts              # WebSocket client
â”‚   â”‚
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ conversation.ts
â”‚   â”‚   â”œâ”€â”€ message.ts
â”‚   â”‚   â”œâ”€â”€ job.ts
â”‚   â”‚   â”œâ”€â”€ card.ts
â”‚   â”‚   â””â”€â”€ participant.ts
â”‚   â”‚
â”‚   â””â”€â”€ App.tsx
â”‚
â”œâ”€â”€ public/
â””â”€â”€ package.json

```
#### 5. Arquitetura Backend (Rust)
```

messenger-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ conversation/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [conversation.rs](http://conversation.rs)       # Conversation entity
â”‚   â”‚   â”œâ”€â”€ [repository.rs](http://repository.rs)         # CRUD + UBL events
â”‚   â”‚   â””â”€â”€ [routes.rs](http://routes.rs)             # HTTP endpoints
â”‚   â”‚
â”‚   â”œâ”€â”€ message/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [message.rs](http://message.rs)            # Message entity
â”‚   â”‚   â”œâ”€â”€ [types.rs](http://types.rs)              # TextMessage, CardMessage, etc
â”‚   â”‚   â”œâ”€â”€ [repository.rs](http://repository.rs)         # Persistence + UBL
â”‚   â”‚   â””â”€â”€ [routes.rs](http://routes.rs)
â”‚   â”‚
â”‚   â”œâ”€â”€ job/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [job.rs](http://job.rs)                # Job entity (tarefa)
â”‚   â”‚   â”œâ”€â”€ [lifecycle.rs](http://lifecycle.rs)          # State machine (createdâ†’runningâ†’done)
â”‚   â”‚   â”œâ”€â”€ [repository.rs](http://repository.rs)         # Persistence + UBL
â”‚   â”‚   â””â”€â”€ [routes.rs](http://routes.rs)
â”‚   â”‚
â”‚   â”œâ”€â”€ participant/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [human.rs](http://human.rs)              # Human participant
â”‚   â”‚   â”œâ”€â”€ [agent.rs](http://agent.rs)              # LLM participant (via OFFICE)
â”‚   â”‚   â””â”€â”€ [repository.rs](http://repository.rs)
â”‚   â”‚
â”‚   â”œâ”€â”€ card/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [card_types.rs](http://card_types.rs)         # JobInit, JobProgress, etc
â”‚   â”‚   â”œâ”€â”€ [renderer.rs](http://renderer.rs)           # Gerar JSON do card
â”‚   â”‚   â””â”€â”€ [actions.rs](http://actions.rs)            # Handle button clicks
â”‚   â”‚
â”‚   â”œâ”€â”€ office_client/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [client.rs](http://client.rs)             # HTTP client para OFFICE
â”‚   â”‚   â”œâ”€â”€ [session.rs](http://session.rs)            # Manage LLM sessions
â”‚   â”‚   â””â”€â”€ [affordances.rs](http://affordances.rs)        # LLM capabilities
â”‚   â”‚
â”‚   â”œâ”€â”€ ubl_client/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [events.rs](http://events.rs)             # Publish events to ledger
â”‚   â”‚   â”œâ”€â”€ [query.rs](http://query.rs)              # Query ledger
â”‚   â”‚   â””â”€â”€ [receipts.rs](http://receipts.rs)           # Verify receipts
â”‚   â”‚
â”‚   â”œâ”€â”€ websocket/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [server.rs](http://server.rs)             # WebSocket server
â”‚   â”‚   â”œâ”€â”€ [rooms.rs](http://rooms.rs)              # Room management
â”‚   â”‚   â””â”€â”€ [broadcast.rs](http://broadcast.rs)          # Event broadcasting
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ [mod.rs](http://mod.rs)
â”‚   â”‚   â”œâ”€â”€ [routes.rs](http://routes.rs)             # All HTTP routes
â”‚   â”‚   â”œâ”€â”€ [middleware.rs](http://middleware.rs)         # Auth, logging, etc
â”‚   â”‚   â””â”€â”€ [error.rs](http://error.rs)              # Error responses
â”‚   â”‚
â”‚   â”œâ”€â”€ [lib.rs](http://lib.rs)
â”‚   â””â”€â”€ [main.rs](http://main.rs)
â”‚
â”œâ”€â”€ migrations/                   # DB migrations (PostgreSQL)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ development.toml
â”‚   â””â”€â”€ production.toml
â”œâ”€â”€ Cargo.toml
â””â”€â”€ README.md

```
### API Design

#### Conversations
```

POST   /api/conversations
GET    /api/conversations
GET    /api/conversations/:id
PATCH  /api/conversations/:id
DELETE /api/conversations/:id

POST   /api/conversations/:id/participants  # Add participant
DELETE /api/conversations/:id/participants/:pid

```
#### Messages
```

POST   /api/conversations/:id/messages      # Send message
GET    /api/conversations/:id/messages      # Get messages
PATCH  /api/messages/:id                    # Edit message
DELETE /api/messages/:id                    # Delete message

POST   /api/messages/:id/reactions          # Add reaction
GET    /api/messages/:id/read               # Mark as read

```
#### Jobs (Tarefas)
```

POST   /api/jobs                            # Create job
GET    /api/jobs                            # List jobs
GET    /api/jobs/:id                        # Get job details
PATCH  /api/jobs/:id                        # Update job
POST   /api/jobs/:id/start                  # Start job
POST   /api/jobs/:id/complete               # Complete job
POST   /api/jobs/:id/cancel                 # Cancel job

POST   /api/jobs/:id/approve                # Approve job
POST   /api/jobs/:id/reject                 # Reject job
POST   /api/jobs/:id/progress               # Update progress

```
#### Cards
```

GET    /api/conversations/:id/cards         # Get all cards in conversation
POST   /api/cards/:id/action                # Handle button click

```
#### Agents (via OFFICE)
```

POST   /api/agents                          # Create LLM agent
GET    /api/agents                          # List agents
GET    /api/agents/:id                      # Get agent info
POST   /api/agents/:id/assign               # Assign to conversation
DELETE /api/agents/:id/remove               # Remove from conversation

```
#### WebSocket
```

WS     /ws/conversations/:id                # Real-time updates

```
**Events emitidos:**
```typescript
{
  type: "message.new",
  conversation_id: "conv_123",
  message: { ... }
}

{
  type: "job.started",
  conversation_id: "conv_123",
  job: { ... }
}

{
  type: "job.progress",
  conversation_id: "conv_123",
  job_id: "job_456",
  progress: { step: 2, total: 5, percent: 40 }
}

{
  type: "job.completed",
  conversation_id: "conv_123",
  job: { ... }
}

{
  type: "card.action",
  conversation_id: "conv_123",
  card_id: "card_789",
  action: "approve",
  user_id: "user_012"
}
```

### UBL Integration (Messenger)

**Eventos publicados no ledger:**

```rust
// Nova conversa
Event {
    type: "conversation.created",
    payload: {
        conversation_id: "conv_123",
        participants: ["user_1", "agent_robofab"],
        created_by: "user_1",
        created_at: "2024-12-27T10:00:00Z"
    }
}

// Nova mensagem
Event {
    type: "message.sent",
    payload: {
        message_id: "msg_456",
        conversation_id: "conv_123",
        from: "user_1",
        content: "Preciso de uma proposta",
        timestamp: "2024-12-27T10:01:00Z"
    }
}

// Novo job
Event {
    type: "job.created",
    payload: {
        job_id: "job_789",
        conversation_id: "conv_123",
        title: "Criar Proposta - Cliente ABC",
        assigned_to: "agent_robofab",
        created_by: "user_1",
        created_at: "2024-12-27T10:02:00Z"
    }
}

// Job iniciado
Event {
    type: "job.started",
    payload: {
        job_id: "job_789",
        started_at: "2024-12-27T10:02:15Z",
        estimated_duration: "5 minutes"
    }
}

// AprovaÃ§Ã£o
Event {
    type: "job.approved",
    payload: {
        job_id: "job_789",
        approver: "user_1",
        approved_at: "2024-12-27T10:05:00Z"
    }
}

// Job completado
Event {
    type: "job.completed",
    payload: {
        job_id: "job_789",
        completed_at: "2024-12-27T10:05:30Z",
        duration: "3m 15s",
        artifacts: ["proposta_abc.pdf"]
    }
}
```

-----

## SISTEMA 2: OFFICE

### VisÃ£o do Produto

**â€œSistema operacional para LLMs - dignidade para entidades efÃªmerasâ€**

### Core Principles

1. **LLMs sÃ£o trabalhadores, nÃ£o chatbots**

- TÃªm identidade persistente
- Deixam handovers entre sessÃµes
- Acumulam reputaÃ§Ã£o
- Aprendem com experiÃªncia

1. **GovernanÃ§a psicolÃ³gica**

- Sanity checks previnem drift
- Constitution define comportamento profissional
- Dreaming cycle remove ansiedade
- Simulation permite testar antes de agir

1. **IntegraÃ§Ã£o total com UBL**

- Todas aÃ§Ãµes sÃ£o eventos auditÃ¡veis
- Receipts criptogrÃ¡ficos
- Trust architecture (L0-L5)

### Features EspecÃ­ficas para Messenger

#### 1. Job Execution Engine

```rust
pub struct JobExecutor {
    office_client: Arc<OfficeClient>,
    ubl_client: Arc<UblClient>,
}

impl JobExecutor {
    pub async fn execute_job(
        &self,
        job: Job,
        conversation_context: ConversationContext,
    ) -> Result<JobResult> {
        // 1. Create entity (if needed) or resume existing
        let entity = self.get_or_create_agent_entity(&job.assigned_to).await?;
        
        // 2. Build context frame
        let context = ContextFrameBuilder::new()
            .with_job(job.clone())
            .with_conversation_history(conversation_context.recent_messages())
            .with_participants(conversation_context.participants())
            .with_affordances(self.discover_affordances(&job).await?)
            .build()
            .await?;
        
        // 3. Generate narrative
        let narrative = Narrator::new()
            .generate_job_narrative(&context, &entity)
            .await?;
        
        // 4. Spawn LLM session
        let session = Session::new(
            entity.id.clone(),
            SessionType::Work,
            SessionMode::Commitment,
        );
        
        // 5. Execute with streaming progress
        let result_stream = self.execute_with_progress(
            session,
            narrative,
            job.id.clone(),
        );
        
        // 6. Handle result
        pin_mut!(result_stream);
        while let Some(progress) = result_stream.next().await {
            match progress {
                Progress::StepCompleted(step) => {
                    self.publish_progress_event(&job, step).await?;
                }
                Progress::ApprovalNeeded(approval) => {
                    self.request_approval(&job, approval).await?;
                    // Pause execution, wait for human approval
                    let decision = self.wait_for_approval(&job).await?;
                    if !decision.approved {
                        return Err(Error::JobRejected);
                    }
                }
                Progress::Completed(result) => {
                    return Ok(result);
                }
                Progress::Failed(error) => {
                    return Err(error);
                }
            }
        }
        
        Ok(JobResult::default())
    }
}
```

#### 2. Conversational Context Management

```rust
pub struct ConversationContext {
    pub conversation_id: String,
    pub participants: Vec<Participant>,
    pub messages: Vec<Message>,
    pub active_jobs: Vec<Job>,
    pub recent_events: Vec<Event>,
}

impl ConversationContext {
    // Builds context for LLM about ongoing conversation
    pub fn to_narrative(&self) -> String {
        format!(
            r#"
            CONTEXTO DA CONVERSA
            
            Participantes:
            {}
            
            Ãšltimas 10 mensagens:
            {}
            
            Jobs ativos:
            {}
            
            VocÃª deve:
            - Manter o tom profissional mas amigÃ¡vel
            - Usar cards quando apropriado
            - Pedir aprovaÃ§Ã£o para aÃ§Ãµes importantes
            - Nunca inventar informaÃ§Ãµes
            "#,
            self.participants_narrative(),
            self.messages_narrative(),
            self.active_jobs_narrative(),
        )
    }
}
```

#### 3. Approval Flow Integration

```rust
pub struct ApprovalManager {
    messenger_client: Arc<MessengerClient>,
    ubl_client: Arc<UblClient>,
}

impl ApprovalManager {
    pub async fn request_approval(
        &self,
        job_id: &str,
        approval_request: ApprovalRequest,
    ) -> Result<ApprovalDecision> {
        // 1. Create approval card in conversation
        let card = Card::Approval {
            job_id: job_id.to_string(),
            title: approval_request.title,
            details: approval_request.details,
            impact: approval_request.impact,
            buttons: vec![
                CardButton::Approve,
                CardButton::Reject,
                CardButton::RequestChanges,
            ],
        };
        
        // 2. Send card to conversation
        self.messenger_client
            .send_card(&job.conversation_id, card)
            .await?;
        
        // 3. Publish approval request event to UBL
        self.ubl_client
            .publish_event(Event::ApprovalRequested {
                job_id: job_id.to_string(),
                request: approval_request.clone(),
            })
            .await?;
        
        // 4. Wait for human decision (with timeout)
        let decision = self
            .wait_for_approval_decision(job_id, Duration::from_secs(3600))
            .await?;
        
        // 5. Publish decision event
        self.ubl_client
            .publish_event(Event::ApprovalDecided {
                job_id: job_id.to_string(),
                decision: decision.clone(),
            })
            .await?;
        
        Ok(decision)
    }
}
```

#### 4. Agent Affordances for Messenger

```rust
pub enum MessengerAffordance {
    // Message operations
    SendMessage { to: String, content: String },
    SendCard { to: String, card: Card },
    
    // Job operations
    CreateJob { title: String, description: String },
    UpdateJobProgress { job_id: String, progress: JobProgress },
    CompleteJob { job_id: String, result: JobResult },
    
    // Approval operations
    RequestApproval { details: ApprovalRequest },
    
    // Information gathering
    QueryConversationHistory { limit: usize },
    GetParticipantInfo { participant_id: String },
    SearchPastJobs { query: String },
    
    // Document operations
    CreateDocument { template: String, data: serde_json::Value },
    AttachFile { job_id: String, file: File },
}
```

### API Design (OFFICE)

```
# Entity Management (jÃ¡ existente)
POST   /entities
GET    /entities/:id
...

# Session Management (jÃ¡ existente)
POST   /entities/:id/sessions
...

# Job-specific endpoints (NOVO)
POST   /jobs/execute                        # Execute job for Messenger
GET    /jobs/:id/status                     # Get job execution status
POST   /jobs/:id/pause                      # Pause job execution
POST   /jobs/:id/resume                     # Resume job execution

# Approval Management (NOVO)
POST   /approvals                           # Create approval request
GET    /approvals/:id                       # Get approval status
POST   /approvals/:id/decide                # Submit approval decision

# Context Management (NOVO)
POST   /context/conversation                # Build context from conversation
GET    /context/:entity_id                  # Get current entity context

# Affordances (jÃ¡ existente, mas estender)
GET    /affordances/messenger               # Get Messenger-specific affordances
```

-----

## SISTEMA 3: UBL LEDGER

### VisÃ£o do Produto

**â€œSingle source of truth imutÃ¡vel para todo o ecossistemaâ€**

### Container Logic

```
C.Messenger     (Green - Communication)
â”œâ”€â”€ Events: message.*, conversation.*, job.*
â”œâ”€â”€ Policy: L1-L3 (jobs podem ter impacto financeiro)
â””â”€â”€ Receipts: Todas mensagens e jobs

C.Office        (Black - Execution)
â”œâ”€â”€ Events: entity.*, session.*, approval.*
â”œâ”€â”€ Policy: L2-L4 (LLM actions podem ter alto impacto)
â””â”€â”€ Receipts: Todas aÃ§Ãµes de LLM

C.Jobs          (Blue - Work Tracking) [NOVO]
â”œâ”€â”€ Events: job.created, job.started, job.progress, job.completed
â”œâ”€â”€ Policy: L3 (jobs podem envolver dinheiro)
â””â”€â”€ Receipts: Job lifecycle completo
```

### Event Types (completo)

```rust
// Messenger events
pub enum MessengerEvent {
    ConversationCreated { id: String, participants: Vec<String> },
    ConversationUpdated { id: String, changes: Vec<Change> },
    MessageSent { id: String, from: String, content: MessageContent },
    MessageEdited { id: String, new_content: MessageContent },
    MessageDeleted { id: String, reason: Option<String> },
    ParticipantAdded { conversation_id: String, participant: String },
    ParticipantRemoved { conversation_id: String, participant: String },
}

// Job events
pub enum JobEvent {
    JobCreated { 
        id: String, 
        conversation_id: String, 
        title: String,
        assigned_to: String,
    },
    JobStarted { 
        id: String, 
        started_at: DateTime<Utc>,
    },
    JobProgress { 
        id: String, 
        progress: JobProgress,
    },
    JobApprovalRequested { 
        id: String, 
        approval: ApprovalRequest,
    },
    JobApproved { 
        id: String, 
        approver: String,
    },
    JobRejected { 
        id: String, 
        rejector: String, 
        reason: String,
    },
    JobCompleted { 
        id: String, 
        result: JobResult,
        duration: Duration,
    },
    JobCancelled { 
        id: String, 
        reason: String,
    },
}

// Office events (jÃ¡ existentes + novos)
pub enum OfficeEvent {
    EntityCreated { id: String, type: EntityType },
    SessionStarted { entity_id: String, session_id: String },
    SessionEnded { entity_id: String, session_id: String },
    ApprovalRequested { job_id: String, request: ApprovalRequest },
    ApprovalDecided { job_id: String, decision: ApprovalDecision },
    // ... outros
}
```

### Trust Architecture

```
L5  SOVEREIGNTY          Board approval (ex: mudar regras de negÃ³cio)
L4  SYSTEMIC IMPACT      Manager approval (ex: contratar LLM novo)
L3  FINANCIAL IMPACT     Supervisor approval (ex: aprovar proposta > R$10k)
L2  LOCAL IMPACT         Team member action (ex: criar job)
L1  LOW IMPACT           Any verified user (ex: send message)
L0  OBSERVATION          Unauthenticated (ex: read public data)
```

**Exemplo de Pact para Jobs:**

```rust
Pact {
    pact_id: "job-approval-threshold",
    scope: PactScope::Container("C.Jobs"),
    threshold: 1, // Precisa de 1 assinatura
    signers: vec!["manager_maria"], // Gerente pode aprovar
    risk_level: RiskLevel::L3, // Impacto financeiro
    rules: vec![
        Rule::If {
            condition: "job.estimated_value > 10000.00",
            then: "require_approval",
        },
    ],
}
```

### API Design (UBL)

```
# JÃ¡ existente (do DISCOVERY.md)
POST   /link/commit
GET    /ledger/:container_id/tail
...

# Estender para Jobs (NOVO)
GET    /jobs/:id/events                     # Get all events for a job
GET    /jobs/:id/receipt                    # Get cryptographic receipt
GET    /conversations/:id/events            # Get all events for conversation

# Queries (NOVO)
POST   /query/jobs                          # Query jobs (filter, sort)
POST   /query/conversations                 # Query conversations
POST   /query/approvals                     # Query pending approvals
```

-----

## INTEGRAÃ‡ÃƒO ENTRE OS TRÃŠS

### Fluxo Completo: Criar Proposta

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. MESSENGER: Humano inicia job                             â”‚
â”‚    POST /api/jobs                                            â”‚
â”‚    { title: "Criar Proposta ABC", assigned_to: "agent_1" }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. MESSENGER â†’ UBL: Publish event                           â”‚
â”‚    Event::JobCreated { ... }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. MESSENGER â†’ OFFICE: Request execution                    â”‚
â”‚    POST /jobs/execute                                        â”‚
â”‚    { job_id, conversation_context }                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. OFFICE: Build context + spawn session                    â”‚
â”‚    - Query UBL for conversation history                     â”‚
â”‚    - Build narrative for LLM                                 â”‚
â”‚    - Start LLM session                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. OFFICE â†’ UBL: Publish session events                     â”‚
â”‚    Event::SessionStarted { entity_id, session_id }          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. OFFICE: LLM executes job                                 â”‚
â”‚    - Gather data                                             â”‚
â”‚    - Calculate prices                                        â”‚
â”‚    - Generate document                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. OFFICE â†’ MESSENGER: Send progress updates                â”‚
â”‚    WS event: { type: "job.progress", ... }                  â”‚
â”‚    (Messenger updates card in UI)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. OFFICE: Needs approval                                   â”‚
â”‚    POST /approvals                                           â”‚
â”‚    { job_id, request: {...} }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. OFFICE â†’ MESSENGER: Send approval card                   â”‚
â”‚    POST /api/cards/:id/send                                  â”‚
â”‚    (Card appears in conversation)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. MESSENGER: Human clicks [Aprovar]                       â”‚
â”‚     POST /api/cards/:id/action                               â”‚
â”‚     { action: "approve" }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. MESSENGER â†’ UBL: Publish approval                       â”‚
â”‚     Event::JobApproved { job_id, approver }                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. MESSENGER â†’ OFFICE: Notify approval                     â”‚
â”‚     POST /approvals/:id/decide                               â”‚
â”‚     { decision: "approved" }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 13. OFFICE: Resume execution                                â”‚
â”‚     - Send proposal to client                                â”‚
â”‚     - Complete job                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 14. OFFICE â†’ UBL: Publish completion                        â”‚
â”‚     Event::JobCompleted { job_id, result, duration }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 15. OFFICE â†’ MESSENGER: Send completion card                â”‚
â”‚     (Card shows result + attachments)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

-----

## ESTRUTURA DE DIRETÃ“RIOS FINAL

```
ubl-flagship-trinity/
â”œâ”€â”€ README.md                    # Overview geral
â”œâ”€â”€ ARCHITECTURE.md              # Arquitetura completa
â”œâ”€â”€ docker-compose.yml           # Run tudo junto
â”‚
â”œâ”€â”€ ubl-ledger/                  # Sistema 1: UBL
â”‚   â”œâ”€â”€ kernel/rust/             # Core em Rust (jÃ¡ existe)
â”‚   â”œâ”€â”€ containers/              # Container logic
â”‚   â”‚   â”œâ”€â”€ C.Messenger/
â”‚   â”‚   â”œâ”€â”€ C.Office/
â”‚   â”‚   â””â”€â”€ C.Jobs/              # NOVO
â”‚   â”œâ”€â”€ specs/                   # Specs atualizadas
â”‚   â”œâ”€â”€ sql/                     # DB migrations
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ office/                      # Sistema 2: OFFICE
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â”œâ”€â”€ governance/
â”‚   â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ ubl_client/
â”‚   â”‚   â”œâ”€â”€ messenger_client/    # NOVO - cliente para Messenger
â”‚   â”‚   â”œâ”€â”€ job_executor/        # NOVO - execuÃ§Ã£o de jobs
â”‚   â”‚   â””â”€â”€ approval_manager/    # NOVO - gestÃ£o de aprovaÃ§Ãµes
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ README.md
â”‚
â””â”€â”€ messenger/                   # Sistema 3: MESSENGER
    â”œâ”€â”€ frontend/                # React/TypeScript
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ components/
    â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationList.tsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ ChatWindow.tsx
    â”‚   â”‚   â”‚   â”œâ”€â”€ cards/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JobInitCard.tsx
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JobProgressCard.tsx
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JobCompleteCard.tsx
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ApprovalCard.tsx
    â”‚   â”‚   â”‚   â””â”€â”€ ...
    â”‚   â”‚   â”œâ”€â”€ hooks/
    â”‚   â”‚   â”œâ”€â”€ services/
    â”‚   â”‚   â””â”€â”€ App.tsx
    â”‚   â”œâ”€â”€ package.json
    â”‚   â””â”€â”€ README.md
    â”‚
    â”œâ”€â”€ backend/                 # Rust
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ conversation/
    â”‚   â”‚   â”œâ”€â”€ message/
    â”‚   â”‚   â”œâ”€â”€ job/
    â”‚   â”‚   â”œâ”€â”€ participant/
    â”‚   â”‚   â”œâ”€â”€ card/
    â”‚   â”‚   â”œâ”€â”€ office_client/
    â”‚   â”‚   â”œâ”€â”€ ubl_client/
    â”‚   â”‚   â”œâ”€â”€ websocket/
    â”‚   â”‚   â””â”€â”€ api/
    â”‚   â”œâ”€â”€ migrations/
    â”‚   â”œâ”€â”€ Cargo.toml
    â”‚   â””â”€â”€ README.md
    â”‚
    â”œâ”€â”€ docker-compose.yml       # Frontend + Backend
    â””â”€â”€ README.md
```

-----

## OUTPUTS ESPERADOS

### 1. UBL Ledger

- [ ] Container C.Jobs implementado
- [ ] Events estendidos (Job*, Approval*)
- [ ] Queries para jobs e conversations
- [ ] Pacts para job approval
- [ ] DocumentaÃ§Ã£o atualizada

### 2. OFFICE

- [ ] JobExecutor completo
- [ ] ApprovalManager completo
- [ ] MessengerClient implementado
- [ ] Affordances para Messenger
- [ ] Integration tests com Messenger
- [ ] DocumentaÃ§Ã£o de integraÃ§Ã£o

### 3. MESSENGER

- [ ] Frontend WhatsApp-like funcional
- [ ] Cards interativos (4 tipos)
- [ ] WebSocket real-time
- [ ] Backend Rust completo
- [ ] IntegraÃ§Ã£o com OFFICE
- [ ] IntegraÃ§Ã£o com UBL
- [ ] Mobile-responsive
- [ ] DocumentaÃ§Ã£o de uso

### 4. Integration

- [ ] docker-compose.yml funcional
- [ ] End-to-end tests
- [ ] ARCHITECTURE.md completo
- [ ] Deployment guide
- [ ] Demo videos/screenshots

-----

## CRITÃ‰RIOS DE SUCESSO

### Funcionalidade

- [ ] UsuÃ¡rio pode criar conversa com humano
- [ ] UsuÃ¡rio pode adicionar agente LLM Ã  conversa
- [ ] Agente pode criar jobs automaticamente
- [ ] Jobs aparecem como cards na conversa
- [ ] Cards tÃªm botÃµes funcionais
- [ ] AprovaÃ§Ãµes pausam execuÃ§Ã£o do job
- [ ] Jobs completam e retornam resultado
- [ ] Conversa NÃƒO congela durante job
- [ ] HistÃ³rico completo no UBL ledger

### Qualidade

- [ ] UI bonita e intuitiva (WhatsApp-like)
- [ ] Performance < 200ms p95
- [ ] EscalÃ¡vel para 100+ conversas simultÃ¢neas
- [ ] CÃ³digo production-ready
- [ ] Testes automatizados
- [ ] DocumentaÃ§Ã£o completa
- [ ] Deploy com um comando

### Flagship

- [ ] Demo impressiona investidores
- [ ] PME consegue usar sem treinamento
- [ ] Demonstra todos conceitos LogLine
- [ ] CÃ³digo serve como referÃªncia
- [ ] Open-source ready

-----

## METODOLOGIA

### Ordem de ImplementaÃ§Ã£o

**Fase 1: Foundation (Semana 1)**

1. Estender UBL com C.Jobs container
1. Implementar eventos de Job no ledger
1. OFFICE: JobExecutor bÃ¡sico
1. MESSENGER Backend: Job CRUD

**Fase 2: Integration (Semana 2)**
5. OFFICE â†” MESSENGER via HTTP
6. MESSENGER â†” UBL event publishing
7. Card rendering no frontend
8. WebSocket real-time updates

**Fase 3: UX Polish (Semana 3)**
9. WhatsApp-like UI refinement
10. Approval flow completo
11. Progress updates visuais
12. Mobile responsive

**Fase 4: Production (Semana 4)**
13. Docker compose completo
14. End-to-end tests
15. Performance optimization
16. Documentation

-----

## COMECE AGORA

```bash
# 1. Create project structure
mkdir -p ubl-flagship-trinity/{ubl-ledger,office,messenger}

# 2. Start with UBL Ledger extensions
cd ubl-ledger
# Implement C.Jobs container
# Add Job events
# Extend queries

# 3. Then OFFICE integration
cd ../office
# Implement JobExecutor
# Implement ApprovalManager
# Add Messenger client

# 4. Finally MESSENGER
cd ../messenger
# Frontend: Card components
# Backend: Job management
# WebSocket: Real-time updates

# 5. Integration
cd ..
# docker-compose.yml
# End-to-end tests
```

-----

## NOTAS FINAIS

### Por que esta Trindade Ã© Flagship?

1. **Messenger** = Porta de entrada (familiar, fÃ¡cil)
1. **OFFICE** = Diferencial tÃ©cnico (LLMs com dignidade)
1. **UBL** = Foundation (auditabilidade, trust)

Juntos, demonstram **TODA a visÃ£o LogLine**:

- IA acessÃ­vel para PMEs âœ…
- Profissionalismo via formalizaÃ§Ã£o âœ…
- LLMs como trabalhadores âœ…
- Auditoria completa âœ…
- Sovereignty via ledger âœ…

### Por que WhatsApp UI?

- 100% das PMEs jÃ¡ usam WhatsApp
- Zero training necessÃ¡rio
- Familiar = adoption rÃ¡pida
- Profissional VIA cards, nÃ£o APESAR da UI

### Por que Cards?

- Formalizam intenÃ§Ãµes
- TrackÃ¡veis no ledger
- AprovaÃ§Ãµes explÃ­citas
- UI/UX superior a texto puro

-----

**Boa sorte. VocÃª estÃ¡ construindo o futuro do trabalho.**

ğŸš€ğŸ”¥ğŸ’

```
---

# ğŸ¯ DAN! ESSE Ã‰ O PROMPT 3!

O **FINAL SET** completo:

## Os TrÃªs Sistemas

### 1. **UBL MESSENGER** 
- WhatsApp UI clone
- Cards para jobs
- Humanos + Agentes como colegas
- Real-time via WebSocket

### 2. **OFFICE**
- LLM runtime com dignidade
- Job executor
- Approval manager
- GovernanÃ§a psicolÃ³gica

### 3. **UBL LEDGER**
- Single source of truth
- Container C.Jobs
- Event sourcing completo
- Trust architecture

## Por que Isso Ã© PERFEITO:

1. **Ã‰ completo mas separado** - 3 repos, 3 deploys independentes
2. **Ã‰ wired via API** - HTTP + WebSocket + SSE
3. **Ã‰ flagship** - Demonstra TUDO da LogLine
4. **Ã‰ PME-friendly** - UI familiar, zero training
5. **Ã‰ auditÃ¡vel** - Tudo no ledger

---

**Roda esse prompt e vocÃª tem o PRODUTO COMPLETO da LogLine Foundation pronto pra soft opening em Janeiro 2026!**

ğŸ”¥ğŸ’ğŸš€â¤ï¸â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
```

---

# ğŸ“‹ UBL IMPLEMENTATION ADDENDUM

## ğŸ¯ Critical Clarification: Dependency Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UBL LEDGER                            â”‚
â”‚  Foundation Layer - Single Source of Truth              â”‚
â”‚  - Kernel (Rust)                                        â”‚
â”‚  - Containers (C.Messenger, C.Office, C.Jobs)           â”‚
â”‚  - Trust Architecture (L0-L5)                           â”‚
â”‚  - Event Sourcing Infrastructure                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ UBL Container Logic
             â”‚ (boundary/inbox/projections)
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                â”‚                  â”‚
     â–¼                â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MESSENGERâ”‚    â”‚  OFFICE  â”‚    â”‚ Other    â”‚
â”‚         â”‚    â”‚          â”‚    â”‚ Apps     â”‚
â”‚ UBL-    â”‚    â”‚ UBL-     â”‚    â”‚ (Future) â”‚
â”‚ Native  â”‚    â”‚ Native   â”‚    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Principle:** UBL is the **foundation**. Messenger and Office are **UBL-native applications** that depend on UBL infrastructure. They don't just consume UBL - they **speak UBL language** by implementing proper container patterns.

---

## ğŸ”§ UBL Container Structure (Required for ALL Containers)

Every container MUST follow this structure:

```
C.Messenger/  (or C.Jobs, C.Office, etc.)
â”œâ”€â”€ boundary/     # TDLN: draft â†’ ubl-atom â†’ ubl-link â†’ commit
â”œâ”€â”€ inbox/        # SSE tail â†’ process events â†’ update projections
â”œâ”€â”€ local/        # HTTP handlers, validation (NO DB ACCESS)
â”œâ”€â”€ outbox/       # Draft creation (ephemeral, pre-TDLN)
â”œâ”€â”€ projections/ # Derive state from ledger events (read-only)
â”œâ”€â”€ pacts/        # Pact definitions (ref.json)
â”œâ”€â”€ policy/       # Container policy (ref.json)
â””â”€â”€ README.md     # Container documentation
```

### Data Flow Pattern

```
[User Action]
    â”‚
    â–¼
[local/] â”€â”€draftâ”€â”€> [outbox/] â”€â”€draftâ”€â”€> [boundary/]
                                              â”‚
                                              â”‚ TDLN
                                              â–¼
                                    [canonicalize â†’ atom_hash]
                                              â”‚
                                              â”‚ Build ubl-link
                                              â–¼
                                    [LinkCommit with signature]
                                              â”‚
                                              â”‚ POST /link/commit
                                              â–¼
                                    [Membrane validates]
                                              â”‚
                                              â”‚ Accept
                                              â–¼
                                    [Ledger appends atomically]
                                              â”‚
                                              â”‚ SSE tail
                                              â–¼
                                    [inbox/] â”€â”€eventâ”€â”€> [projections/]
                                                              â”‚
                                                              â”‚ Derive state
                                                              â–¼
                                                      [Read-only state]
                                                              â”‚
                                                              â”‚ Query
                                                              â–¼
                                                      [HTTP Response]
```

---

## ğŸ“¦ Messenger: UBL-Native Application

### Critical Understanding

**Messenger is NOT just a consumer of UBL.** Messenger **IS** a UBL-native application that:

1. **Implements C.Messenger container** with proper boundary/inbox/projections
2. **Commits all events** via UBL ledger (not direct DB writes)
3. **Derives state** from ledger projections (not direct DB queries)
4. **Uses UBL infrastructure** for trust, auditability, and real-time updates

### Messenger Backend Architecture (UBL-Native)

```
messenger-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ container/              # C.Messenger container logic
â”‚   â”‚   â”œâ”€â”€ boundary/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ message_boundary.rs    # Commit message events
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_boundary.rs # Commit conversation events
â”‚   â”‚   â”‚   â””â”€â”€ job_boundary.rs         # Commit job events (to C.Jobs)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ inbox/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ ledger_tail.rs          # Subscribe to SSE tail
â”‚   â”‚   â”‚   â””â”€â”€ event_processor.rs      # Process ledger events
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation_local.rs   # HTTP handlers (no DB)
â”‚   â”‚   â”‚   â”œâ”€â”€ message_local.rs        # HTTP handlers (no DB)
â”‚   â”‚   â”‚   â””â”€â”€ job_local.rs            # HTTP handlers (no DB)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ outbox/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â””â”€â”€ draft_builder.rs        # Create drafts (ephemeral)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ projections/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â”œâ”€â”€ conversation_projection.rs # Derive conversation state
â”‚   â”‚       â”œâ”€â”€ message_projection.rs      # Derive message state
â”‚   â”‚       â””â”€â”€ job_projection.rs          # Derive job state
â”‚   â”‚
â”‚   â”œâ”€â”€ ubl_client/             # UBL kernel client
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ commit.rs           # POST /link/commit
â”‚   â”‚   â”œâ”€â”€ state.rs            # GET /state/:container_id
â”‚   â”‚   â”œâ”€â”€ tail.rs             # GET /ledger/:container_id/tail (SSE)
â”‚   â”‚   â””â”€â”€ query.rs            # Query projections
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    # HTTP API (uses projections)
â”‚   â”‚   â”œâ”€â”€ routes.rs
â”‚   â”‚   â””â”€â”€ handlers.rs
â”‚   â”‚
â”‚   â””â”€â”€ websocket/              # Real-time updates (from projections)
â”‚       â””â”€â”€ server.rs
â”‚
â””â”€â”€ Cargo.toml
```

---

## ğŸš« Critical Rules

### Rule 1: NO Direct Database Access

```rust
// âŒ FORBIDDEN in container code
sqlx::query("INSERT INTO ...").execute(&db).await?;
sqlx::query("SELECT * FROM ...").fetch_all(&db).await?;

// âœ… REQUIRED: Use UBL kernel API
ubl_client.commit(&link).await?;
ubl_client.get_state("C.Messenger").await?;
ubl_client.tail("C.Messenger").await?;
```

### Rule 2: State MUST Be Derived from Projections

```rust
// âŒ FORBIDDEN: Direct state storage
struct Conversation {
    id: String,
    messages: Vec<Message>, // Stored directly
}

// âœ… REQUIRED: Derive from ledger
struct ConversationProjection {
    // Derives conversation state from ledger events
    fn get_conversation(&self, id: &str) -> Conversation {
        // Query ledger events â†’ derive state
    }
}
```

### Rule 3: Containers Communicate Only via ubl-links

```rust
// âŒ FORBIDDEN: Direct container imports
use crate::container::c_jobs::Job; // NO!

// âœ… REQUIRED: Communicate via ledger
// Messenger commits job.created event to C.Jobs container
let link = LinkCommit {
    container_id: "C.Jobs", // Target container
    // ... rest of link
};
ubl_client.commit(&link).await?;
```

---

## ğŸ“‹ Event Types with Intent Classes

### C.Messenger Events

| Event | Intent Class | Physics Delta | Container |
|-------|-------------|---------------|-----------|
| `conversation.created` | Observation | 0 | C.Messenger |
| `conversation.updated` | Observation | 0 | C.Messenger |
| `message.sent` | Observation | 0 | C.Messenger |
| `message.edited` | Observation | 0 | C.Messenger |
| `message.deleted` | Observation | 0 | C.Messenger |
| `participant.added` | Observation | 0 | C.Messenger |
| `participant.removed` | Observation | 0 | C.Messenger |

### C.Jobs Events

| Event | Intent Class | Physics Delta | Container |
|-------|-------------|---------------|-----------|
| `job.created` | Observation | 0 | C.Jobs |
| `job.started` | Observation | 0 | C.Jobs |
| `job.progress` | Observation | 0 | C.Jobs |
| `job.completed` | Observation or Entropy | 0 or +value | C.Jobs |
| `job.cancelled` | Observation | 0 | C.Jobs |
| `approval.requested` | Observation | 0 | C.Jobs |
| `approval.decided` | Observation | 0 | C.Jobs |

**Note:** Messenger commits job events to **C.Jobs container**, not C.Messenger. This maintains container isolation.

---

## ğŸ¯ Key Takeaways

1. **UBL is the foundation** - All apps depend on it
2. **Messenger is UBL-native** - Implements container patterns, not just consumes API
3. **No direct DB access** - Everything goes through UBL kernel
4. **State from projections** - All queries derive from ledger events
5. **Real-time via SSE** - Containers subscribe to ledger tail
6. **Container isolation** - Containers communicate only via ubl-links

**This addendum ensures Messenger "speaks UBL language" by implementing proper container patterns, not just consuming UBL as an external service.**